{ parameter
    (list (pair (address %from_)
                (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount)))))) ;
  storage
    (pair (pair (big_map %metadata string bytes)
                (big_map %token_metadata nat (pair (nat %token_id) (map %token_info string bytes))))
          (big_map %tokens nat (map address nat))) ;
  code { UNPAIR ;
         SWAP ;
         DUP ;
         DUG 2 ;
         CDR ;
         NIL operation ;
         PAIR ;
         SWAP ;
         ITER { SWAP ;
                SENDER ;
                DIG 2 ;
                DUP ;
                DUG 3 ;
                CAR ;
                COMPARE ;
                NEQ ;
                IF { PUSH string "not authorized" ; FAILWITH } {} ;
                SWAP ;
                DUP ;
                DUG 2 ;
                CDR ;
                ITER { SWAP ;
                       PAIR ;
                       SWAP ;
                       DUP ;
                       DUG 2 ;
                       CAR ;
                       LAMBDA
                         (pair address
                               (pair (pair (list operation) (big_map nat (map address nat))) (pair address (pair nat nat))))
                         (pair (list operation) (big_map nat (map address nat)))
                         { DUP ;
                           CDR ;
                           SWAP ;
                           CAR ;
                           SWAP ;
                           UNPAIR ;
                           UNPAIR ;
                           SWAP ;
                           DUP ;
                           DUG 2 ;
                           DIG 3 ;
                           DUP ;
                           DUG 4 ;
                           CDR ;
                           CAR ;
                           GET ;
                           IF_NONE { PUSH string "Token doesnt exist" ; FAILWITH } {} ;
                           DUP ;
                           DIG 5 ;
                           DUP ;
                           DUG 6 ;
                           GET ;
                           IF_NONE { PUSH string "from has no tokens" ; FAILWITH } {} ;
                           DIG 4 ;
                           DUP ;
                           DUG 5 ;
                           CDR ;
                           CDR ;
                           SWAP ;
                           SUB ;
                           PUSH int 0 ;
                           SWAP ;
                           DUP ;
                           DUG 2 ;
                           COMPARE ;
                           LT ;
                           IF { PUSH string "insufficient tokens" ; FAILWITH } {} ;
                           SWAP ;
                           DUP ;
                           DUG 2 ;
                           DIG 5 ;
                           DUP ;
                           DUG 6 ;
                           CDR ;
                           CDR ;
                           DIG 3 ;
                           DIG 6 ;
                           DUP ;
                           DUG 7 ;
                           CAR ;
                           GET ;
                           IF_NONE { PUSH nat 0 } {} ;
                           ADD ;
                           SOME ;
                           DIG 5 ;
                           DUP ;
                           DUG 6 ;
                           CAR ;
                           UPDATE ;
                           SWAP ;
                           ABS ;
                           SOME ;
                           DIG 5 ;
                           UPDATE ;
                           DIG 2 ;
                           SWAP ;
                           SOME ;
                           DIG 3 ;
                           CDR ;
                           CAR ;
                           UPDATE ;
                           SWAP ;
                           PAIR } ;
                       SWAP ;
                       APPLY ;
                       SWAP ;
                       EXEC } ;
                SWAP ;
                DROP } ;
         UNPAIR ;
         SWAP ;
         DIG 2 ;
         DUP ;
         DUG 3 ;
         CAR ;
         CDR ;
         DIG 3 ;
         CAR ;
         CAR ;
         PAIR ;
         PAIR ;
         SWAP ;
         PAIR } }
