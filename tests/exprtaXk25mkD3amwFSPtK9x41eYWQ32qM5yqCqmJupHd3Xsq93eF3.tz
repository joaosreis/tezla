{ storage
    (pair (address %organizer)
          (pair (mutez %prize)
                (pair (nat %_state)
                      (map %submission address (pair (nat %score) (timestamp %timestamp)))))) ;
  parameter
    (or (unit %confirm)
        (or (pair %submit (bytes %packed_score) (signature %signed_score)) (unit %decide))) ;
  code { NIL operation ;
         DIG 1 ;
         UNPAIR ;
         DIP { UNPAIR ; SWAP ; UNPAIR ; SWAP ; UNPAIR ; SWAP } ;
         IF_LEFT
           { DROP ;
             DIG 3 ;
             DUP ;
             DUG 4 ;
             SENDER ;
             COMPARE ;
             EQ ;
             NOT ;
             IF { PUSH string "InvalidCaller" ; FAILWITH } {} ;
             DIG 1 ;
             DUP ;
             DUG 2 ;
             DUP ;
             PUSH nat 0 ;
             COMPARE ;
             EQ ;
             IF { DIG 3 ;
                  DUP ;
                  DUG 4 ;
                  AMOUNT ;
                  COMPARE ;
                  EQ ;
                  IF { PUSH nat 1 ; DIP { DIG 2 ; DROP } ; DUG 2 } {} }
                { PUSH string "InvalidState" ; FAILWITH } ;
             DROP ;
             SWAP ;
             PAIR ;
             SWAP ;
             PAIR ;
             SWAP ;
             PAIR ;
             DIG 1 ;
             PAIR }
           { IF_LEFT
               { UNPAIR ;
                 SWAP ;
                 PUSH nat 1 ;
                 DIG 4 ;
                 DUP ;
                 DUG 5 ;
                 COMPARE ;
                 EQ ;
                 NOT ;
                 IF { PUSH string "InvalidCondition: c1" ; FAILWITH } {} ;
                 DIG 1 ;
                 DUP ;
                 DUG 2 ;
                 DIG 1 ;
                 DUP ;
                 DUG 2 ;
                 PUSH key "edpkv9k8WZNMyEMuLLVwQfGDqm4pfxSEkTmvgq5DakPUnNbNnQuB14" ;
                 CHECK_SIGNATURE ;
                 IF { DIG 1 ;
                      DUP ;
                      DUG 2 ;
                      UNPACK (pair address nat) ;
                      IF_NONE
                        { PUSH string "cannot unpack score" ; FAILWITH }
                        { SENDER ;
                          DIG 1 ;
                          DUP ;
                          DUG 2 ;
                          CAR ;
                          COMPARE ;
                          NEQ ;
                          IF { PUSH string "bad caller" ; FAILWITH } {} ;
                          DIG 3 ;
                          DUP ;
                          DUG 4 ;
                          NOW ;
                          DIG 2 ;
                          DUP ;
                          DUG 3 ;
                          CDR ;
                          PAIR ;
                          SOME ;
                          SENDER ;
                          UPDATE ;
                          DIP { DIG 3 ; DROP } ;
                          DUG 3 ;
                          DROP } }
                    { PUSH string "not signed by oracle" ; FAILWITH } ;
                 DROP 2 ;
                 SWAP ;
                 PAIR ;
                 SWAP ;
                 PAIR ;
                 SWAP ;
                 PAIR ;
                 DIG 1 ;
                 PAIR }
               { DROP ;
                 DIG 3 ;
                 DUP ;
                 DUG 4 ;
                 SENDER ;
                 COMPARE ;
                 EQ ;
                 NOT ;
                 IF { PUSH string "InvalidCaller" ; FAILWITH } {} ;
                 DIG 1 ;
                 DUP ;
                 DUG 2 ;
                 DUP ;
                 PUSH nat 1 ;
                 COMPARE ;
                 EQ ;
                 IF { NIL address ;
                      DIG 2 ;
                      DUP ;
                      DUG 3 ;
                      ITER { UNPAIR ;
                             NIL address ;
                             DIG 1 ;
                             DUP ;
                             DUG 2 ;
                             SOME ;
                             PAIR ;
                             DIG 3 ;
                             DUP ;
                             DUG 4 ;
                             ITER { DIG 1 ;
                                    DUP ;
                                    DUG 2 ;
                                    CAR ;
                                    DIG 2 ;
                                    DUP ;
                                    DUG 3 ;
                                    CDR ;
                                    DIG 1 ;
                                    DUP ;
                                    DUG 2 ;
                                    IF_NONE
                                      { DUP ; DIG 3 ; DUP ; DUG 4 ; CONS ; DIG 2 ; DUP ; DUG 3 ; PAIR }
                                      { PUSH int 0 ;
                                        DIG 10 ;
                                        DUP ;
                                        DUG 11 ;
                                        DIG 5 ;
                                        DUP ;
                                        DUG 6 ;
                                        GET ;
                                        IF_NONE { PUSH string "GetNoneValue" ; FAILWITH } {} ;
                                        DIG 8 ;
                                        DUP ;
                                        DUG 9 ;
                                        CAR ;
                                        DIG 1 ;
                                        DUP ;
                                        DUG 2 ;
                                        CAR ;
                                        COMPARE ;
                                        LT ;
                                        IF { PUSH int 1 }
                                           { DIG 8 ;
                                             DUP ;
                                             DUG 9 ;
                                             CDR ;
                                             DIG 1 ;
                                             DUP ;
                                             DUG 2 ;
                                             CDR ;
                                             COMPARE ;
                                             GT ;
                                             IF { PUSH int 1 } { PUSH int 0 } } ;
                                        DIP { DROP } ;
                                        COMPARE ;
                                        GT ;
                                        IF { DIG 1 ;
                                             DUP ;
                                             DUG 2 ;
                                             DIG 6 ;
                                             DUP ;
                                             DUG 7 ;
                                             CONS ;
                                             DIG 4 ;
                                             DUP ;
                                             DUG 5 ;
                                             CONS ;
                                             NONE address ;
                                             PAIR }
                                           { DIG 1 ;
                                             DUP ;
                                             DUG 2 ;
                                             DIG 4 ;
                                             DUP ;
                                             DUG 5 ;
                                             CONS ;
                                             DIG 3 ;
                                             DUP ;
                                             DUG 4 ;
                                             PAIR } ;
                                        SWAP ;
                                        DROP } ;
                                    DIP { DROP } ;
                                    DIP { DROP } ;
                                    DIP { DIG 1 ; DROP } ;
                                    DUG 1 ;
                                    DROP } ;
                             DUP ;
                             CAR ;
                             DIG 1 ;
                             DUP ;
                             DUG 2 ;
                             CDR ;
                             NIL address ;
                             DIG 2 ;
                             DUP ;
                             DUG 3 ;
                             IF_NONE
                               { DIG 1 ; DUP ; DUG 2 }
                               { DIG 2 ; DUP ; DUG 3 ; DIG 6 ; DUP ; DUG 7 ; CONS ; SWAP ; DROP } ;
                             ITER { DIG 1 ;
                                    DUP ;
                                    DUG 2 ;
                                    DIG 1 ;
                                    DUP ;
                                    DUG 2 ;
                                    CONS ;
                                    DIP { DIG 1 ; DROP } ;
                                    DUG 1 ;
                                    DROP } ;
                             DIP { DROP } ;
                             DIP { DROP } ;
                             DIP { DROP } ;
                             DIP { DIG 2 ; DROP } ;
                             DUG 2 ;
                             DROP 2 } ;
                      PUSH nat 3 ;
                      DIG 1 ;
                      DUP ;
                      DUG 2 ;
                      SIZE ;
                      COMPARE ;
                      GE ;
                      IF { NONE address ;
                           PUSH nat 0 ;
                           PAIR ;
                           DIG 1 ;
                           DUP ;
                           DUG 2 ;
                           ITER { PUSH nat 0 ;
                                  DIG 2 ;
                                  DUP ;
                                  DUG 3 ;
                                  CAR ;
                                  COMPARE ;
                                  EQ ;
                                  IF { DUP ; SOME ; PUSH nat 1 ; DIG 3 ; DUP ; DUG 4 ; CAR ; ADD ; PAIR }
                                     { DIG 1 ;
                                       DUP ;
                                       DUG 2 ;
                                       CDR ;
                                       PUSH nat 1 ;
                                       DIG 3 ;
                                       DUP ;
                                       DUG 4 ;
                                       CAR ;
                                       ADD ;
                                       PAIR } ;
                                  DIP { DIG 1 ; DROP } ;
                                  DUG 1 ;
                                  DROP } ;
                           CDR ;
                           IF_NONE { PUSH string "NoneValue" ; FAILWITH } {} ;
                           NONE address ;
                           PUSH nat 0 ;
                           PAIR ;
                           DIG 2 ;
                           DUP ;
                           DUG 3 ;
                           ITER { PUSH nat 1 ;
                                  DIG 2 ;
                                  DUP ;
                                  DUG 3 ;
                                  CAR ;
                                  COMPARE ;
                                  EQ ;
                                  IF { DUP ; SOME ; PUSH nat 1 ; DIG 3 ; DUP ; DUG 4 ; CAR ; ADD ; PAIR }
                                     { DIG 1 ;
                                       DUP ;
                                       DUG 2 ;
                                       CDR ;
                                       PUSH nat 1 ;
                                       DIG 3 ;
                                       DUP ;
                                       DUG 4 ;
                                       CAR ;
                                       ADD ;
                                       PAIR } ;
                                  DIP { DIG 1 ; DROP } ;
                                  DUG 1 ;
                                  DROP } ;
                           CDR ;
                           IF_NONE { PUSH string "NoneValue" ; FAILWITH } {} ;
                           NONE address ;
                           PUSH nat 0 ;
                           PAIR ;
                           DIG 3 ;
                           DUP ;
                           DUG 4 ;
                           ITER { PUSH nat 2 ;
                                  DIG 2 ;
                                  DUP ;
                                  DUG 3 ;
                                  CAR ;
                                  COMPARE ;
                                  EQ ;
                                  IF { DUP ; SOME ; PUSH nat 1 ; DIG 3 ; DUP ; DUG 4 ; CAR ; ADD ; PAIR }
                                     { DIG 1 ;
                                       DUP ;
                                       DUG 2 ;
                                       CDR ;
                                       PUSH nat 1 ;
                                       DIG 3 ;
                                       DUP ;
                                       DUG 4 ;
                                       CAR ;
                                       ADD ;
                                       PAIR } ;
                                  DIP { DIG 1 ; DROP } ;
                                  DUG 1 ;
                                  DROP } ;
                           CDR ;
                           IF_NONE { PUSH string "NoneValue" ; FAILWITH } {} ;
                           DIG 7 ;
                           DUP ;
                           DUG 8 ;
                           PUSH nat 2 ;
                           PUSH int 1 ;
                           PAIR ;
                           PAIR ;
                           UNPAIR ;
                           UNPAIR ;
                           ABS ;
                           DIG 2 ;
                           MUL ;
                           EDIV ;
                           IF_NONE { PUSH string "DivByZero" ; FAILWITH } {} ;
                           CAR ;
                           DIG 8 ;
                           DUP ;
                           DUG 9 ;
                           PUSH nat 10 ;
                           PUSH int 3 ;
                           PAIR ;
                           PAIR ;
                           UNPAIR ;
                           UNPAIR ;
                           ABS ;
                           DIG 2 ;
                           MUL ;
                           EDIV ;
                           IF_NONE { PUSH string "DivByZero" ; FAILWITH } {} ;
                           CAR ;
                           DIG 9 ;
                           DUP ;
                           DUG 10 ;
                           PUSH nat 5 ;
                           PUSH int 1 ;
                           PAIR ;
                           PAIR ;
                           UNPAIR ;
                           UNPAIR ;
                           ABS ;
                           DIG 2 ;
                           MUL ;
                           EDIV ;
                           IF_NONE { PUSH string "DivByZero" ; FAILWITH } {} ;
                           CAR ;
                           DIG 12 ;
                           DUP ;
                           DUG 13 ;
                           DIG 6 ;
                           DUP ;
                           DUG 7 ;
                           CONTRACT unit ;
                           IF_NONE { PUSH string "BadContract" ; FAILWITH } {} ;
                           DIG 4 ;
                           DUP ;
                           DUG 5 ;
                           UNIT ;
                           TRANSFER_TOKENS ;
                           CONS ;
                           DIP { DIG 12 ; DROP } ;
                           DUG 12 ;
                           DIG 12 ;
                           DUP ;
                           DUG 13 ;
                           DIG 5 ;
                           DUP ;
                           DUG 6 ;
                           CONTRACT unit ;
                           IF_NONE { PUSH string "BadContract" ; FAILWITH } {} ;
                           DIG 3 ;
                           DUP ;
                           DUG 4 ;
                           UNIT ;
                           TRANSFER_TOKENS ;
                           CONS ;
                           DIP { DIG 12 ; DROP } ;
                           DUG 12 ;
                           DIG 12 ;
                           DUP ;
                           DUG 13 ;
                           DIG 4 ;
                           DUP ;
                           DUG 5 ;
                           CONTRACT unit ;
                           IF_NONE { PUSH string "BadContract" ; FAILWITH } {} ;
                           DIG 2 ;
                           DUP ;
                           DUG 3 ;
                           UNIT ;
                           TRANSFER_TOKENS ;
                           CONS ;
                           DIP { DIG 12 ; DROP } ;
                           DUG 12 ;
                           DIG 12 ;
                           DUP ;
                           DUG 13 ;
                           DIG 12 ;
                           DUP ;
                           DUG 13 ;
                           CONTRACT unit ;
                           IF_NONE { PUSH string "BadContract" ; FAILWITH } {} ;
                           DIG 2 ;
                           DUP ;
                           DUG 3 ;
                           DIG 4 ;
                           DUP ;
                           DUG 5 ;
                           DIG 6 ;
                           DUP ;
                           DUG 7 ;
                           DIG 15 ;
                           DUP ;
                           DUG 16 ;
                           SUB ;
                           SUB ;
                           SUB ;
                           UNIT ;
                           TRANSFER_TOKENS ;
                           CONS ;
                           DIP { DIG 12 ; DROP } ;
                           DUG 12 ;
                           DROP 6 }
                         { PUSH nat 2 ;
                           DIG 1 ;
                           DUP ;
                           DUG 2 ;
                           SIZE ;
                           COMPARE ;
                           GE ;
                           IF { NONE address ;
                                PUSH nat 0 ;
                                PAIR ;
                                DIG 1 ;
                                DUP ;
                                DUG 2 ;
                                ITER { PUSH nat 0 ;
                                       DIG 2 ;
                                       DUP ;
                                       DUG 3 ;
                                       CAR ;
                                       COMPARE ;
                                       EQ ;
                                       IF { DUP ; SOME ; PUSH nat 1 ; DIG 3 ; DUP ; DUG 4 ; CAR ; ADD ; PAIR }
                                          { DIG 1 ;
                                            DUP ;
                                            DUG 2 ;
                                            CDR ;
                                            PUSH nat 1 ;
                                            DIG 3 ;
                                            DUP ;
                                            DUG 4 ;
                                            CAR ;
                                            ADD ;
                                            PAIR } ;
                                       DIP { DIG 1 ; DROP } ;
                                       DUG 1 ;
                                       DROP } ;
                                CDR ;
                                IF_NONE { PUSH string "NoneValue" ; FAILWITH } {} ;
                                NONE address ;
                                PUSH nat 0 ;
                                PAIR ;
                                DIG 2 ;
                                DUP ;
                                DUG 3 ;
                                ITER { PUSH nat 1 ;
                                       DIG 2 ;
                                       DUP ;
                                       DUG 3 ;
                                       CAR ;
                                       COMPARE ;
                                       EQ ;
                                       IF { DUP ; SOME ; PUSH nat 1 ; DIG 3 ; DUP ; DUG 4 ; CAR ; ADD ; PAIR }
                                          { DIG 1 ;
                                            DUP ;
                                            DUG 2 ;
                                            CDR ;
                                            PUSH nat 1 ;
                                            DIG 3 ;
                                            DUP ;
                                            DUG 4 ;
                                            CAR ;
                                            ADD ;
                                            PAIR } ;
                                       DIP { DIG 1 ; DROP } ;
                                       DUG 1 ;
                                       DROP } ;
                                CDR ;
                                IF_NONE { PUSH string "NoneValue" ; FAILWITH } {} ;
                                DIG 6 ;
                                DUP ;
                                DUG 7 ;
                                PUSH nat 5 ;
                                PUSH int 3 ;
                                PAIR ;
                                PAIR ;
                                UNPAIR ;
                                UNPAIR ;
                                ABS ;
                                DIG 2 ;
                                MUL ;
                                EDIV ;
                                IF_NONE { PUSH string "DivByZero" ; FAILWITH } {} ;
                                CAR ;
                                DIG 7 ;
                                DUP ;
                                DUG 8 ;
                                PUSH nat 5 ;
                                PUSH int 2 ;
                                PAIR ;
                                PAIR ;
                                UNPAIR ;
                                UNPAIR ;
                                ABS ;
                                DIG 2 ;
                                MUL ;
                                EDIV ;
                                IF_NONE { PUSH string "DivByZero" ; FAILWITH } {} ;
                                CAR ;
                                DIG 10 ;
                                DUP ;
                                DUG 11 ;
                                DIG 4 ;
                                DUP ;
                                DUG 5 ;
                                CONTRACT unit ;
                                IF_NONE { PUSH string "BadContract" ; FAILWITH } {} ;
                                DIG 3 ;
                                DUP ;
                                DUG 4 ;
                                UNIT ;
                                TRANSFER_TOKENS ;
                                CONS ;
                                DIP { DIG 10 ; DROP } ;
                                DUG 10 ;
                                DIG 10 ;
                                DUP ;
                                DUG 11 ;
                                DIG 3 ;
                                DUP ;
                                DUG 4 ;
                                CONTRACT unit ;
                                IF_NONE { PUSH string "BadContract" ; FAILWITH } {} ;
                                DIG 2 ;
                                DUP ;
                                DUG 3 ;
                                UNIT ;
                                TRANSFER_TOKENS ;
                                CONS ;
                                DIP { DIG 10 ; DROP } ;
                                DUG 10 ;
                                DIG 10 ;
                                DUP ;
                                DUG 11 ;
                                DIG 10 ;
                                DUP ;
                                DUG 11 ;
                                CONTRACT unit ;
                                IF_NONE { PUSH string "BadContract" ; FAILWITH } {} ;
                                DIG 2 ;
                                DUP ;
                                DUG 3 ;
                                DIG 4 ;
                                DUP ;
                                DUG 5 ;
                                DIG 12 ;
                                DUP ;
                                DUG 13 ;
                                SUB ;
                                SUB ;
                                UNIT ;
                                TRANSFER_TOKENS ;
                                CONS ;
                                DIP { DIG 10 ; DROP } ;
                                DUG 10 ;
                                DROP 4 }
                              { PUSH nat 1 ;
                                DIG 1 ;
                                DUP ;
                                DUG 2 ;
                                SIZE ;
                                COMPARE ;
                                GE ;
                                IF { NONE address ;
                                     PUSH nat 0 ;
                                     PAIR ;
                                     DIG 1 ;
                                     DUP ;
                                     DUG 2 ;
                                     ITER { PUSH nat 0 ;
                                            DIG 2 ;
                                            DUP ;
                                            DUG 3 ;
                                            CAR ;
                                            COMPARE ;
                                            EQ ;
                                            IF { DUP ; SOME ; PUSH nat 1 ; DIG 3 ; DUP ; DUG 4 ; CAR ; ADD ; PAIR }
                                               { DIG 1 ;
                                                 DUP ;
                                                 DUG 2 ;
                                                 CDR ;
                                                 PUSH nat 1 ;
                                                 DIG 3 ;
                                                 DUP ;
                                                 DUG 4 ;
                                                 CAR ;
                                                 ADD ;
                                                 PAIR } ;
                                            DIP { DIG 1 ; DROP } ;
                                            DUG 1 ;
                                            DROP } ;
                                     CDR ;
                                     IF_NONE { PUSH string "NoneValue" ; FAILWITH } {} ;
                                     DIG 7 ;
                                     DUP ;
                                     DUG 8 ;
                                     DIG 1 ;
                                     DUP ;
                                     DUG 2 ;
                                     CONTRACT unit ;
                                     IF_NONE { PUSH string "BadContract" ; FAILWITH } {} ;
                                     DIG 7 ;
                                     DUP ;
                                     DUG 8 ;
                                     UNIT ;
                                     TRANSFER_TOKENS ;
                                     CONS ;
                                     DIP { DIG 7 ; DROP } ;
                                     DUG 7 ;
                                     DROP }
                                   { DIG 6 ;
                                     DUP ;
                                     DUG 7 ;
                                     DIG 6 ;
                                     DUP ;
                                     DUG 7 ;
                                     CONTRACT unit ;
                                     IF_NONE { PUSH string "BadContract" ; FAILWITH } {} ;
                                     DIG 6 ;
                                     DUP ;
                                     DUG 7 ;
                                     UNIT ;
                                     TRANSFER_TOKENS ;
                                     CONS ;
                                     DIP { DIG 6 ; DROP } ;
                                     DUG 6 } } } ;
                      DROP ;
                      PUSH nat 2 ;
                      DIP { DIG 2 ; DROP } ;
                      DUG 2 }
                    { PUSH string "InvalidState" ; FAILWITH } ;
                 DROP ;
                 SWAP ;
                 PAIR ;
                 SWAP ;
                 PAIR ;
                 SWAP ;
                 PAIR ;
                 DIG 1 ;
                 PAIR } } } }
