{ storage
    (pair (pair (address %admin) (mutez %bid))
          (pair (address %last_winner) (pair (nat %max_players) (set %players address)))) ;
  parameter
    (or (or (unit %play) (unit %refund_players))
        (or (mutez %set_bid) (nat %set_max_players))) ;
  code { UNPAIR ;
         IF_LEFT
           { IF_LEFT
               { SWAP ;
                 DUP ;
                 DUG 2 ;
                 CAR ;
                 CDR ;
                 AMOUNT ;
                 COMPARE ;
                 EQ ;
                 IF {} { PUSH string "Error: invalid amount" ; FAILWITH } ;
                 SWAP ;
                 DUP ;
                 GET 5 ;
                 SWAP ;
                 DUP ;
                 DUG 3 ;
                 GET 6 ;
                 SIZE ;
                 COMPARE ;
                 LT ;
                 IF {} { PUSH string "Error: no more free slot" ; FAILWITH } ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 GET 6 ;
                 SENDER ;
                 MEM ;
                 IF { PUSH string "Error: player already playing" ; FAILWITH } {} ;
                 SWAP ;
                 UNPAIR ;
                 SWAP ;
                 UNPAIR ;
                 SWAP ;
                 UNPAIR ;
                 SWAP ;
                 PUSH bool True ;
                 SENDER ;
                 UPDATE ;
                 SWAP ;
                 PAIR ;
                 SWAP ;
                 PAIR ;
                 SWAP ;
                 PAIR ;
                 DUP ;
                 GET 5 ;
                 SWAP ;
                 DUP ;
                 DUG 3 ;
                 GET 6 ;
                 SIZE ;
                 COMPARE ;
                 EQ ;
                 IF { PUSH nat 1 ;
                      DUP 3 ;
                      GET 6 ;
                      ITER { PUSH nat 1 ;
                             DUP 5 ;
                             GET 6 ;
                             SIZE ;
                             INT ;
                             PUSH timestamp "1970-01-01T00:00:00Z" ;
                             NOW ;
                             SUB ;
                             EDIV ;
                             IF_NONE { PUSH int 51 ; FAILWITH } { CDR } ;
                             ADD ;
                             DUP 3 ;
                             COMPARE ;
                             EQ ;
                             IF { DIG 3 ; UNPAIR ; SWAP ; CDR ; DIG 2 ; PAIR ; SWAP ; PAIR ; DUG 2 }
                                { DROP } ;
                             PUSH nat 1 ;
                             ADD } ;
                      DROP 2 ;
                      DUP ;
                      GET 3 ;
                      CONTRACT unit ;
                      IF_NONE { PUSH int 58 ; FAILWITH } {} ;
                      NIL operation ;
                      SWAP ;
                      BALANCE ;
                      UNIT ;
                      TRANSFER_TOKENS ;
                      CONS ;
                      SWAP ;
                      UNPAIR ;
                      SWAP ;
                      UNPAIR ;
                      SWAP ;
                      CAR ;
                      EMPTY_SET address ;
                      SWAP ;
                      PAIR ;
                      SWAP ;
                      PAIR ;
                      SWAP ;
                      PAIR ;
                      SWAP }
                    { DROP ; NIL operation } }
               { SENDER ;
                 DUP 3 ;
                 CAR ;
                 CAR ;
                 COMPARE ;
                 EQ ;
                 IF {} { PUSH string "Error: non admin call" ; FAILWITH } ;
                 PUSH mutez 0 ;
                 BALANCE ;
                 COMPARE ;
                 NEQ ;
                 IF {} { PUSH string "Error: no balance" ; FAILWITH } ;
                 PUSH nat 0 ;
                 DUP 3 ;
                 GET 6 ;
                 SIZE ;
                 COMPARE ;
                 NEQ ;
                 IF {} { PUSH string "Error: no players" ; FAILWITH } ;
                 NIL operation ;
                 DUP 3 ;
                 GET 6 ;
                 ITER { CONTRACT unit ;
                        IF_NONE { PUSH int 36 ; FAILWITH } {} ;
                        DUP 4 ;
                        GET 6 ;
                        SIZE ;
                        BALANCE ;
                        PUSH nat 1 ;
                        MUL ;
                        EDIV ;
                        IF_NONE { PUSH int 34 ; FAILWITH } {} ;
                        CAR ;
                        UNIT ;
                        TRANSFER_TOKENS ;
                        CONS } ;
                 SWAP ;
                 DROP } }
           { IF_LEFT
               { SENDER ;
                 DUP 3 ;
                 CAR ;
                 CAR ;
                 COMPARE ;
                 EQ ;
                 IF {} { PUSH string "Error: non admin call" ; FAILWITH } ;
                 PUSH mutez 0 ;
                 BALANCE ;
                 COMPARE ;
                 EQ ;
                 IF {} { PUSH string "Error: lottery in play" ; FAILWITH } ;
                 SWAP ;
                 UNPAIR ;
                 CAR ;
                 DIG 2 ;
                 SWAP ;
                 PAIR ;
                 PAIR }
               { SENDER ;
                 DUP 3 ;
                 CAR ;
                 CAR ;
                 COMPARE ;
                 EQ ;
                 IF {} { PUSH string "Error: non admin call" ; FAILWITH } ;
                 PUSH mutez 0 ;
                 BALANCE ;
                 COMPARE ;
                 EQ ;
                 IF {} { PUSH string "Error: lottery in play" ; FAILWITH } ;
                 SWAP ;
                 UNPAIR ;
                 SWAP ;
                 UNPAIR ;
                 SWAP ;
                 CDR ;
                 DIG 3 ;
                 PAIR ;
                 SWAP ;
                 PAIR ;
                 SWAP ;
                 PAIR } ;
             NIL operation } ;
         NIL operation ;
         SWAP ;
         ITER { CONS } ;
         PAIR } }
