{ parameter
    (or (or (or (or (unit %collect) (unit %collect_fee))
                (or (unit %confirm_admin) (option %delegate key_hash)))
            (or (or (address %on_sale_end) (bool %pause))
                (or (address %set_admin) (list %stake nat))))
        (list %unstake nat)) ;
  storage
    (pair (pair (pair (pair (address %admin) (big_map %balances address mutez))
                      (pair (address %fee_address) (nat %fee_percent)))
                (pair (pair (big_map %metadata string bytes) (bool %paused))
                      (pair (option %pending_admin address) (address %stake_contract))))
          (pair (big_map %staked_tokens (pair address nat) unit)
                (big_map %stakes address (pair nat timestamp)))) ;
  code { NIL operation ;
         LAMBDA
           unit
           unit
           { PUSH mutez 0 ;
             AMOUNT ;
             COMPARE ;
             GT ;
             IF { DROP ; PUSH string "NO_TEZ_ALLOWED" ; FAILWITH } {} } ;
         DUP ;
         LAMBDA
           (pair (lambda unit unit)
                 (pair address
                       (pair (pair (pair (pair address (big_map address mutez)) (pair address nat))
                                   (pair (pair (big_map string bytes) bool) (pair (option address) address)))
                             (pair (big_map (pair address nat) unit) (big_map address (pair nat timestamp))))))
           (pair (list operation)
                 (pair (pair (pair (pair address (big_map address mutez)) (pair address nat))
                             (pair (pair (big_map string bytes) bool) (pair (option address) address)))
                       (pair (big_map (pair address nat) unit) (big_map address (pair nat timestamp)))))
           { { { DUP ; CAR ; DIP { CDR } } } ;
             SWAP ;
             { { DUP ; CAR ; DIP { CDR } } } ;
             PUSH bool True ;
             { DIP 2 { DUP } ; DIG 3 } ;
             CAR ;
             CDR ;
             CAR ;
             CDR ;
             COMPARE ;
             EQ ;
             IF { PUSH string "PAUSED" ; FAILWITH } {} ;
             UNIT ;
             DIG 3 ;
             SWAP ;
             EXEC ;
             DROP ;
             SWAP ;
             DUP ;
             DUG 2 ;
             SWAP ;
             DUP ;
             DUG 2 ;
             SWAP ;
             CAR ;
             CAR ;
             CAR ;
             CDR ;
             SWAP ;
             GET ;
             IF_NONE { PUSH mutez 0 } {} ;
             PUSH mutez 0 ;
             SWAP ;
             DUP ;
             DUG 2 ;
             COMPARE ;
             EQ ;
             IF { PUSH string "ZERO_BALANCE" ; FAILWITH } {} ;
             SWAP ;
             DUP ;
             DUG 2 ;
             CONTRACT unit ;
             IF_NONE { PUSH string "NO_CONTRACT" ; FAILWITH } {} ;
             { DIP 3 { DUP } ; DIG 4 } ;
             CDR ;
             { DIP 4 { DUP } ; DIG 5 } ;
             CAR ;
             CDR ;
             { DIP 5 { DUP } ; DIG 6 } ;
             CAR ;
             CAR ;
             CDR ;
             { DIP 6 { DUP } ; DIG 7 } ;
             CAR ;
             CAR ;
             CAR ;
             CDR ;
             DIG 6 ;
             NONE mutez ;
             SWAP ;
             UPDATE ;
             DIG 6 ;
             CAR ;
             CAR ;
             CAR ;
             CAR ;
             PAIR ;
             PAIR ;
             PAIR ;
             PAIR ;
             NIL operation ;
             DIG 2 ;
             DIG 3 ;
             UNIT ;
             TRANSFER_TOKENS ;
             CONS ;
             PAIR } ;
         SWAP ;
         APPLY ;
         DIG 3 ;
         { { DUP ; CAR ; DIP { CDR } } } ;
         IF_LEFT
           { IF_LEFT
               { IF_LEFT
                   { DIG 3 ;
                     DIG 4 ;
                     DROP 2 ;
                     IF_LEFT
                       { DROP ; SENDER ; PAIR ; EXEC }
                       { DROP ; DUP ; CAR ; CAR ; CDR ; CAR ; PAIR ; EXEC } }
                   { DIG 2 ;
                     DROP ;
                     IF_LEFT
                       { DROP ;
                         UNIT ;
                         DIG 2 ;
                         SWAP ;
                         EXEC ;
                         DROP ;
                         DUP ;
                         CAR ;
                         CDR ;
                         CDR ;
                         CAR ;
                         IF_NONE { PUSH string "NO_PENDING_ADMIN" ; FAILWITH } {} ;
                         SENDER ;
                         COMPARE ;
                         EQ ;
                         IF { DUP ;
                              CDR ;
                              SWAP ;
                              DUP ;
                              DUG 2 ;
                              CAR ;
                              CDR ;
                              { DIP 2 { DUP } ; DIG 3 } ;
                              CAR ;
                              CAR ;
                              CDR ;
                              DIG 3 ;
                              CAR ;
                              CAR ;
                              CAR ;
                              CDR ;
                              SENDER ;
                              PAIR ;
                              PAIR ;
                              PAIR ;
                              PAIR ;
                              DUP ;
                              CDR ;
                              SWAP ;
                              DUP ;
                              DUG 2 ;
                              CAR ;
                              CDR ;
                              CDR ;
                              CDR ;
                              NONE address ;
                              PAIR ;
                              { DIP 2 { DUP } ; DIG 3 } ;
                              CAR ;
                              CDR ;
                              CAR ;
                              PAIR ;
                              DIG 2 ;
                              CAR ;
                              CAR ;
                              PAIR ;
                              PAIR }
                            { PUSH string "NOT_A_PENDING_ADMIN" ; FAILWITH } ;
                         SWAP ;
                         PAIR }
                       { DIG 3 ;
                         DROP ;
                         UNIT ;
                         DIG 3 ;
                         SWAP ;
                         EXEC ;
                         DROP ;
                         SWAP ;
                         DUP ;
                         DUG 2 ;
                         CAR ;
                         CAR ;
                         CAR ;
                         CAR ;
                         SENDER ;
                         COMPARE ;
                         NEQ ;
                         IF { PUSH string "NOT_ADMIN" ; FAILWITH } {} ;
                         SWAP ;
                         NIL operation ;
                         DIG 2 ;
                         SET_DELEGATE ;
                         CONS ;
                         PAIR } } }
               { DIG 2 ;
                 DROP ;
                 IF_LEFT
                   { IF_LEFT
                       { DIG 2 ;
                         DROP ;
                         PUSH bool True ;
                         { DIP 2 { DUP } ; DIG 3 } ;
                         CAR ;
                         CDR ;
                         CAR ;
                         CDR ;
                         COMPARE ;
                         EQ ;
                         IF { PUSH string "PAUSED" ; FAILWITH } {} ;
                         PUSH mutez 0 ;
                         AMOUNT ;
                         COMPARE ;
                         EQ ;
                         IF { DROP }
                            { SWAP ;
                              DUP ;
                              DUG 2 ;
                              AMOUNT ;
                              { DIP 2 { DUP } ; DIG 3 } ;
                              PUSH mutez 0 ;
                              { DIP 2 { DUP } ; DIG 3 } ;
                              COMPARE ;
                              EQ ;
                              IF { DROP 3 ; PUSH mutez 0 }
                                 { { DIP 2 { DUP } ; DIG 3 } ;
                                   CAR ;
                                   CAR ;
                                   CDR ;
                                   CDR ;
                                   PUSH nat 1000 ;
                                   DIG 3 ;
                                   EDIV ;
                                   IF_NONE { PUSH string "DIV by 0" ; FAILWITH } {} ;
                                   CAR ;
                                   MUL ;
                                   DUG 2 ;
                                   SWAP ;
                                   CDR ;
                                   CDR ;
                                   SWAP ;
                                   GET ;
                                   IF_NONE { NOW ; PUSH nat 0 ; PAIR } {} ;
                                   PUSH int 600 ;
                                   SWAP ;
                                   DUP ;
                                   DUG 2 ;
                                   CDR ;
                                   NOW ;
                                   SUB ;
                                   COMPARE ;
                                   LT ;
                                   IF { DROP }
                                      { PUSH nat 3 ;
                                        SWAP ;
                                        DUP ;
                                        DUG 2 ;
                                        CAR ;
                                        COMPARE ;
                                        GT ;
                                        IF { DROP 2 ; PUSH mutez 0 }
                                           { CAR ;
                                             PUSH nat 4 ;
                                             { DIP 2 { DUP } ; DIG 3 } ;
                                             EDIV ;
                                             IF_NONE { PUSH string "DIV by 0" ; FAILWITH } {} ;
                                             CAR ;
                                             MUL ;
                                             SWAP ;
                                             SUB } } } ;
                              DIG 2 ;
                              SWAP ;
                              DUP ;
                              DUG 2 ;
                              AMOUNT ;
                              SUB ;
                              DIG 3 ;
                              { DIP 2 { DUP } ; DIG 3 } ;
                              CDR ;
                              { DIP 3 { DUP } ; DIG 4 } ;
                              CAR ;
                              CDR ;
                              { DIP 4 { DUP } ; DIG 5 } ;
                              CAR ;
                              CAR ;
                              CDR ;
                              { DIP 5 { DUP } ; DIG 6 } ;
                              CAR ;
                              CAR ;
                              CAR ;
                              CDR ;
                              DIG 5 ;
                              { DIP 6 { DUP } ; DIG 7 } ;
                              { DIP 6 { DUP } ; DIG 7 } ;
                              SWAP ;
                              CAR ;
                              CAR ;
                              CAR ;
                              CDR ;
                              SWAP ;
                              GET ;
                              IF_NONE { PUSH mutez 0 } {} ;
                              ADD ;
                              DIG 5 ;
                              SWAP ;
                              SOME ;
                              SWAP ;
                              UPDATE ;
                              DIG 4 ;
                              CAR ;
                              CAR ;
                              CAR ;
                              CAR ;
                              PAIR ;
                              PAIR ;
                              PAIR ;
                              PAIR ;
                              DUP ;
                              DUG 2 ;
                              CAR ;
                              CAR ;
                              CDR ;
                              CAR ;
                              { DIP 2 { DUP } ; DIG 3 } ;
                              CDR ;
                              { DIP 3 { DUP } ; DIG 4 } ;
                              CAR ;
                              CDR ;
                              { DIP 4 { DUP } ; DIG 5 } ;
                              CAR ;
                              CAR ;
                              CDR ;
                              { DIP 5 { DUP } ; DIG 6 } ;
                              CAR ;
                              CAR ;
                              CAR ;
                              CDR ;
                              DIG 5 ;
                              { DIP 6 { DUP } ; DIG 7 } ;
                              { DIP 6 { DUP } ; DIG 7 } ;
                              SWAP ;
                              CAR ;
                              CAR ;
                              CAR ;
                              CDR ;
                              SWAP ;
                              GET ;
                              IF_NONE { PUSH mutez 0 } {} ;
                              ADD ;
                              DIG 5 ;
                              SWAP ;
                              SOME ;
                              SWAP ;
                              UPDATE ;
                              DIG 4 ;
                              CAR ;
                              CAR ;
                              CAR ;
                              CAR ;
                              PAIR ;
                              PAIR ;
                              PAIR ;
                              PAIR } ;
                         SWAP ;
                         PAIR }
                       { SWAP ;
                         DUP ;
                         DUG 2 ;
                         CAR ;
                         CAR ;
                         CAR ;
                         CAR ;
                         SENDER ;
                         COMPARE ;
                         NEQ ;
                         IF { PUSH string "NOT_ADMIN" ; FAILWITH } {} ;
                         UNIT ;
                         DIG 3 ;
                         SWAP ;
                         EXEC ;
                         DROP ;
                         SWAP ;
                         DUP ;
                         DUG 2 ;
                         CDR ;
                         { DIP 2 { DUP } ; DIG 3 } ;
                         CAR ;
                         CDR ;
                         CDR ;
                         DIG 2 ;
                         { DIP 3 { DUP } ; DIG 4 } ;
                         CAR ;
                         CDR ;
                         CAR ;
                         CAR ;
                         PAIR ;
                         PAIR ;
                         DIG 2 ;
                         CAR ;
                         CAR ;
                         PAIR ;
                         PAIR ;
                         SWAP ;
                         PAIR } }
                   { IF_LEFT
                       { SWAP ;
                         DUP ;
                         DUG 2 ;
                         CAR ;
                         CAR ;
                         CAR ;
                         CAR ;
                         SENDER ;
                         COMPARE ;
                         NEQ ;
                         IF { PUSH string "NOT_ADMIN" ; FAILWITH } {} ;
                         UNIT ;
                         DIG 3 ;
                         SWAP ;
                         EXEC ;
                         DROP ;
                         SWAP ;
                         DUP ;
                         DUG 2 ;
                         CDR ;
                         { DIP 2 { DUP } ; DIG 3 } ;
                         CAR ;
                         CDR ;
                         CDR ;
                         CDR ;
                         DIG 2 ;
                         SOME ;
                         PAIR ;
                         { DIP 2 { DUP } ; DIG 3 } ;
                         CAR ;
                         CDR ;
                         CAR ;
                         PAIR ;
                         DIG 2 ;
                         CAR ;
                         CAR ;
                         PAIR ;
                         PAIR ;
                         SWAP ;
                         PAIR }
                       { DIG 3 ;
                         DROP ;
                         PUSH bool True ;
                         { DIP 2 { DUP } ; DIG 3 } ;
                         CAR ;
                         CDR ;
                         CAR ;
                         CDR ;
                         COMPARE ;
                         EQ ;
                         IF { PUSH string "PAUSED" ; FAILWITH } {} ;
                         UNIT ;
                         DIG 3 ;
                         SWAP ;
                         EXEC ;
                         DROP ;
                         DUP ;
                         MAP { { DIP 2 { DUP } ; DIG 3 } ;
                               SWAP ;
                               DUP ;
                               DUG 2 ;
                               SENDER ;
                               DIG 2 ;
                               CDR ;
                               CAR ;
                               DUG 2 ;
                               PAIR ;
                               MEM ;
                               IF { PUSH string "ID_IS_STAKED_ALREADY" ; FAILWITH } {} ;
                               { DIP 2 { DUP } ; DIG 3 } ;
                               CDR ;
                               CDR ;
                               { DIP 3 { DUP } ; DIG 4 } ;
                               CDR ;
                               CAR ;
                               UNIT ;
                               { DIP 3 { DUP } ; DIG 4 } ;
                               SENDER ;
                               PAIR ;
                               SWAP ;
                               SOME ;
                               SWAP ;
                               UPDATE ;
                               PAIR ;
                               { DIP 3 { DUP } ; DIG 4 } ;
                               DROP 2 ;
                               PUSH nat 1 ;
                               SWAP ;
                               PAIR ;
                               SELF_ADDRESS ;
                               PAIR } ;
                         DUG 2 ;
                         SIZE ;
                         SENDER ;
                         { DIP 2 { DUP } ; DIG 3 } ;
                         SWAP ;
                         DUP ;
                         DUG 2 ;
                         SWAP ;
                         CDR ;
                         CDR ;
                         SWAP ;
                         GET ;
                         IF_NONE { NOW ; PUSH nat 0 ; PAIR } {} ;
                         { DIP 3 { DUP } ; DIG 4 } ;
                         CDR ;
                         CDR ;
                         NOW ;
                         DIG 4 ;
                         DIG 3 ;
                         CAR ;
                         ADD ;
                         PAIR ;
                         DIG 2 ;
                         SWAP ;
                         SOME ;
                         SWAP ;
                         UPDATE ;
                         SWAP ;
                         DUP ;
                         DUG 2 ;
                         CDR ;
                         CAR ;
                         PAIR ;
                         SWAP ;
                         CAR ;
                         PAIR ;
                         SWAP ;
                         SENDER ;
                         { DIP 2 { DUP } ; DIG 3 } ;
                         CAR ;
                         CDR ;
                         CDR ;
                         CDR ;
                         CONTRACT %transfer
                           (list (pair (address %from_)
                                       (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount)))))) ;
                         IF_NONE { PUSH string "NO_CONTRACT" ; FAILWITH } {} ;
                         DIG 3 ;
                         NIL operation ;
                         DIG 2 ;
                         PUSH mutez 0 ;
                         NIL (pair address (list (pair address (pair nat nat)))) ;
                         DIG 6 ;
                         DIG 6 ;
                         PAIR ;
                         CONS ;
                         TRANSFER_TOKENS ;
                         CONS ;
                         PAIR } } } }
           { DIG 2 ;
             DIG 4 ;
             DROP 2 ;
             PUSH bool True ;
             { DIP 2 { DUP } ; DIG 3 } ;
             CAR ;
             CDR ;
             CAR ;
             CDR ;
             COMPARE ;
             EQ ;
             IF { PUSH string "PAUSED" ; FAILWITH } {} ;
             UNIT ;
             DIG 3 ;
             SWAP ;
             EXEC ;
             DROP ;
             DUP ;
             MAP { { DIP 2 { DUP } ; DIG 3 } ;
                   SWAP ;
                   DUP ;
                   DUG 2 ;
                   SENDER ;
                   DIG 2 ;
                   CDR ;
                   CAR ;
                   DUG 2 ;
                   PAIR ;
                   MEM ;
                   NOT ;
                   IF { PUSH string "ID_IS_NOT_STAKED" ; FAILWITH } {} ;
                   { DIP 2 { DUP } ; DIG 3 } ;
                   CDR ;
                   CDR ;
                   { DIP 3 { DUP } ; DIG 4 } ;
                   CDR ;
                   CAR ;
                   { DIP 2 { DUP } ; DIG 3 } ;
                   SENDER ;
                   PAIR ;
                   NONE unit ;
                   SWAP ;
                   UPDATE ;
                   PAIR ;
                   { DIP 3 { DUP } ; DIG 4 } ;
                   DROP 2 ;
                   PUSH nat 1 ;
                   SWAP ;
                   PAIR ;
                   SENDER ;
                   PAIR } ;
             DUG 2 ;
             SIZE ;
             SENDER ;
             { DIP 2 { DUP } ; DIG 3 } ;
             SWAP ;
             DUP ;
             DUG 2 ;
             SWAP ;
             CDR ;
             CDR ;
             SWAP ;
             GET ;
             IF_NONE { NOW ; PUSH nat 0 ; PAIR } {} ;
             DUP ;
             CAR ;
             { DIP 3 { DUP } ; DIG 4 } ;
             COMPARE ;
             GT ;
             IF { PUSH string "STAKE_TOO_LOW" ; FAILWITH } {} ;
             DUP ;
             CAR ;
             { DIP 3 { DUP } ; DIG 4 } ;
             COMPARE ;
             EQ ;
             IF { DIG 2 ;
                  DROP 2 ;
                  SWAP ;
                  DUP ;
                  DUG 2 ;
                  CDR ;
                  CDR ;
                  SWAP ;
                  NONE (pair nat timestamp) ;
                  SWAP ;
                  UPDATE ;
                  SWAP ;
                  DUP ;
                  DUG 2 ;
                  CDR ;
                  CAR ;
                  PAIR ;
                  SWAP ;
                  CAR ;
                  PAIR }
                { { DIP 3 { DUP } ; DIG 4 } ;
                  CDR ;
                  CDR ;
                  NOW ;
                  DIG 4 ;
                  DIG 3 ;
                  CAR ;
                  SUB ;
                  ABS ;
                  PAIR ;
                  DIG 2 ;
                  SWAP ;
                  SOME ;
                  SWAP ;
                  UPDATE ;
                  SWAP ;
                  DUP ;
                  DUG 2 ;
                  CDR ;
                  CAR ;
                  PAIR ;
                  SWAP ;
                  CAR ;
                  PAIR } ;
             SWAP ;
             SELF_ADDRESS ;
             { DIP 2 { DUP } ; DIG 3 } ;
             CAR ;
             CDR ;
             CDR ;
             CDR ;
             CONTRACT %transfer
               (list (pair (address %from_)
                           (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount)))))) ;
             IF_NONE { PUSH string "NO_CONTRACT" ; FAILWITH } {} ;
             DIG 3 ;
             NIL operation ;
             DIG 2 ;
             PUSH mutez 0 ;
             NIL (pair address (list (pair address (pair nat nat)))) ;
             DIG 6 ;
             DIG 6 ;
             PAIR ;
             CONS ;
             TRANSFER_TOKENS ;
             CONS ;
             PAIR } } }
