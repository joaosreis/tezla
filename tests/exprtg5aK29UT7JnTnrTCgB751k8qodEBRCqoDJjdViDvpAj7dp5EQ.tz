{ storage
    (pair (pair (nat %operationId) (list %signers key))
          (pair (nat %threshold)
                (pair (big_map %timelock nat (pair timestamp (lambda unit (list operation))))
                      (nat %timelockSeconds)))) ;
  parameter
    (or (or (pair %cancel (map key_hash signature) (pair chain_id (pair nat nat)))
            (nat %execute))
        (or (pair %rotate (map key_hash signature) (pair chain_id (pair nat (pair nat (list key)))))
            (pair %submit
               (map key_hash signature)
               (pair chain_id (pair nat (lambda unit (list operation))))))) ;
  code { UNPAIR ;
         IF_LEFT
           { IF_LEFT
               { DUP ;
                 UNPAIR ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 UNPAIR ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 UNPAIR ;
                 CHAIN_ID ;
                 PACK ;
                 DUP 4 ;
                 PACK ;
                 COMPARE ;
                 EQ ;
                 IF {} { PUSH string "BAD_CHAIN_ID" ; FAILWITH } ;
                 PUSH nat 1 ;
                 DUP 9 ;
                 CAR ;
                 CAR ;
                 ADD ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 COMPARE ;
                 EQ ;
                 IF {} { PUSH string "BAD_OP_ID" ; FAILWITH } ;
                 PUSH nat 0 ;
                 DUP 9 ;
                 CAR ;
                 CDR ;
                 ITER { DUP 7 ;
                        SWAP ;
                        DUP ;
                        DUG 2 ;
                        HASH_KEY ;
                        MEM ;
                        IF { DUP 8 ;
                             PACK ;
                             DUP 8 ;
                             DUP 3 ;
                             HASH_KEY ;
                             GET ;
                             IF_NONE { PUSH int 196 ; FAILWITH } {} ;
                             DIG 2 ;
                             CHECK_SIGNATURE ;
                             IF {} { PUSH string "BAD_SIGNATURE" ; FAILWITH } ;
                             PUSH nat 1 ;
                             ADD }
                           { DROP } } ;
                 SWAP ;
                 DROP ;
                 DIG 2 ;
                 DROP ;
                 DIG 2 ;
                 DROP ;
                 DIG 2 ;
                 DROP ;
                 DIG 2 ;
                 DROP ;
                 DIG 2 ;
                 DROP ;
                 DUP 3 ;
                 GET 3 ;
                 SWAP ;
                 COMPARE ;
                 GE ;
                 IF {} { PUSH string "TOO_FEW_SIGS" ; FAILWITH } ;
                 SWAP ;
                 UNPAIR ;
                 UNPAIR ;
                 PUSH nat 1 ;
                 ADD ;
                 PAIR ;
                 SWAP ;
                 UNPAIR ;
                 SWAP ;
                 UNPAIR ;
                 NONE (pair timestamp (lambda unit (list operation))) ;
                 DIG 5 ;
                 UPDATE ;
                 PAIR ;
                 SWAP ;
                 PAIR ;
                 SWAP ;
                 PAIR ;
                 NIL operation }
               { SWAP ;
                 DUP ;
                 DUG 2 ;
                 GET 5 ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 GET ;
                 IF_NONE { PUSH int 214 ; FAILWITH } {} ;
                 UNPAIR ;
                 NOW ;
                 SWAP ;
                 DUP 5 ;
                 GET 6 ;
                 INT ;
                 ADD ;
                 COMPARE ;
                 LT ;
                 IF {} { PUSH string "TOO_EARLY" ; FAILWITH } ;
                 DIG 2 ;
                 UNPAIR ;
                 SWAP ;
                 UNPAIR ;
                 SWAP ;
                 UNPAIR ;
                 NONE (pair timestamp (lambda unit (list operation))) ;
                 DIG 6 ;
                 UPDATE ;
                 PAIR ;
                 SWAP ;
                 PAIR ;
                 SWAP ;
                 PAIR ;
                 SWAP ;
                 NIL operation ;
                 SWAP ;
                 UNIT ;
                 EXEC ;
                 ITER { CONS } } }
           { IF_LEFT
               { DUP ;
                 UNPAIR ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 UNPAIR ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 UNPAIR ;
                 CHAIN_ID ;
                 PACK ;
                 DUP 4 ;
                 PACK ;
                 COMPARE ;
                 EQ ;
                 IF {} { PUSH string "BAD_CHAIN_ID" ; FAILWITH } ;
                 PUSH nat 1 ;
                 DUP 9 ;
                 CAR ;
                 CAR ;
                 ADD ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 COMPARE ;
                 EQ ;
                 IF {} { PUSH string "BAD_OP_ID" ; FAILWITH } ;
                 PUSH nat 0 ;
                 DUP 9 ;
                 CAR ;
                 CDR ;
                 ITER { DUP 7 ;
                        SWAP ;
                        DUP ;
                        DUG 2 ;
                        HASH_KEY ;
                        MEM ;
                        IF { DUP 8 ;
                             PACK ;
                             DUP 8 ;
                             DUP 3 ;
                             HASH_KEY ;
                             GET ;
                             IF_NONE { PUSH int 157 ; FAILWITH } {} ;
                             DIG 2 ;
                             CHECK_SIGNATURE ;
                             IF {} { PUSH string "BAD_SIGNATURE" ; FAILWITH } ;
                             PUSH nat 1 ;
                             ADD }
                           { DROP } } ;
                 SWAP ;
                 DROP ;
                 DIG 2 ;
                 DROP ;
                 DIG 2 ;
                 DROP ;
                 DIG 2 ;
                 DROP ;
                 DIG 2 ;
                 DROP ;
                 DIG 2 ;
                 DROP ;
                 DUP 3 ;
                 GET 3 ;
                 SWAP ;
                 COMPARE ;
                 GE ;
                 IF {} { PUSH string "TOO_FEW_SIGS" ; FAILWITH } ;
                 SWAP ;
                 UNPAIR ;
                 UNPAIR ;
                 PUSH nat 1 ;
                 ADD ;
                 PAIR ;
                 PAIR ;
                 SWAP ;
                 UNPAIR ;
                 DIG 2 ;
                 UNPAIR ;
                 SWAP ;
                 CDR ;
                 DIG 2 ;
                 PAIR ;
                 SWAP ;
                 CAR ;
                 DIG 2 ;
                 SWAP ;
                 PAIR ;
                 PAIR }
               { DUP ;
                 UNPAIR ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 UNPAIR ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 UNPAIR ;
                 CHAIN_ID ;
                 PACK ;
                 DUP 4 ;
                 PACK ;
                 COMPARE ;
                 EQ ;
                 IF {} { PUSH string "BAD_CHAIN_ID" ; FAILWITH } ;
                 PUSH nat 1 ;
                 DUP 9 ;
                 CAR ;
                 CAR ;
                 ADD ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 COMPARE ;
                 EQ ;
                 IF {} { PUSH string "BAD_OP_ID" ; FAILWITH } ;
                 PUSH nat 0 ;
                 DUP 9 ;
                 CAR ;
                 CDR ;
                 ITER { DUP 7 ;
                        SWAP ;
                        DUP ;
                        DUG 2 ;
                        HASH_KEY ;
                        MEM ;
                        IF { DUP 8 ;
                             PACK ;
                             DUP 8 ;
                             DUP 3 ;
                             HASH_KEY ;
                             GET ;
                             IF_NONE { PUSH int 120 ; FAILWITH } {} ;
                             DIG 2 ;
                             CHECK_SIGNATURE ;
                             IF {} { PUSH string "BAD_SIGNATURE" ; FAILWITH } ;
                             PUSH nat 1 ;
                             ADD }
                           { DROP } } ;
                 SWAP ;
                 DROP ;
                 DIG 2 ;
                 DROP ;
                 DIG 2 ;
                 DROP ;
                 DIG 2 ;
                 DROP ;
                 DIG 2 ;
                 DROP ;
                 DIG 2 ;
                 DROP ;
                 DUP 3 ;
                 GET 3 ;
                 SWAP ;
                 COMPARE ;
                 GE ;
                 IF {} { PUSH string "TOO_FEW_SIGS" ; FAILWITH } ;
                 SWAP ;
                 UNPAIR ;
                 UNPAIR ;
                 PUSH nat 1 ;
                 ADD ;
                 PAIR ;
                 PAIR ;
                 DUP ;
                 DUG 2 ;
                 UNPAIR ;
                 SWAP ;
                 UNPAIR ;
                 SWAP ;
                 UNPAIR ;
                 DIG 4 ;
                 NOW ;
                 PAIR ;
                 SOME ;
                 DIG 5 ;
                 CAR ;
                 CAR ;
                 UPDATE ;
                 PAIR ;
                 SWAP ;
                 PAIR ;
                 SWAP ;
                 PAIR } ;
             NIL operation } ;
         NIL operation ;
         SWAP ;
         ITER { CONS } ;
         PAIR } }
