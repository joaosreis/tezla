{ parameter
    (or (pair %call
           (pair (address %contractAddress) (nat %counter))
           (pair %params (address %from) (pair (address %to) (nat %value))))
        (pair %permit (pair (bytes %paramHash) (signature %signature)) (key %signerKey))) ;
  storage
    (big_map bytes (pair (pair (bytes %paramHash) (signature %signature)) (key %signerKey))) ;
  code { DUP ;
         CDR ;
         SWAP ;
         CAR ;
         IF_LEFT
           { DUP ;
             DUG 2 ;
             CDR ;
             DIG 2 ;
             DUP ;
             DUG 3 ;
             CAR ;
             CAR ;
             NIL operation ;
             DIG 2 ;
             DUP ;
             DUG 3 ;
             CDR ;
             CDR ;
             PACK ;
             DIG 3 ;
             DUP ;
             DUG 4 ;
             CDR ;
             CAR ;
             PACK ;
             DIG 4 ;
             DUP ;
             DUG 5 ;
             CAR ;
             PACK ;
             CONCAT ;
             CONCAT ;
             BLAKE2B ;
             PACK ;
             DIG 2 ;
             DUP ;
             DUG 3 ;
             PACK ;
             CONCAT ;
             DIG 5 ;
             CAR ;
             CDR ;
             PACK ;
             CHAIN_ID ;
             PACK ;
             CONCAT ;
             CONCAT ;
             DIG 4 ;
             DUP ;
             DUG 5 ;
             DIG 2 ;
             DUP ;
             DUG 3 ;
             PAIR ;
             DIG 5 ;
             DUP ;
             DUG 6 ;
             DIG 2 ;
             DUP ;
             DUG 3 ;
             BLAKE2B ;
             GET ;
             IF_NONE
               { SWAP ;
                 DROP ;
                 SWAP ;
                 DROP ;
                 SWAP ;
                 DROP ;
                 SWAP ;
                 DROP ;
                 SWAP ;
                 DROP ;
                 PUSH string "Invalid_Hash" ;
                 FAILWITH }
               { DIG 6 ;
                 DIG 3 ;
                 NONE (pair (pair bytes signature) key) ;
                 SWAP ;
                 UPDATE ;
                 DIG 3 ;
                 DIG 4 ;
                 CONTRACT %transferSigned
                   (pair (pair (pair (address %from_) (key %pk)) (pair (signature %signed) (address %to_)))
                         (nat %value)) ;
                 IF_NONE { PUSH string "01" ; FAILWITH } {} ;
                 PUSH mutez 0 ;
                 DIG 6 ;
                 DUP ;
                 DUG 7 ;
                 CDR ;
                 CDR ;
                 DIG 7 ;
                 DUP ;
                 DUG 8 ;
                 CDR ;
                 CAR ;
                 DIG 6 ;
                 DUP ;
                 DUG 7 ;
                 CAR ;
                 CDR ;
                 PAIR ;
                 DIG 6 ;
                 CDR ;
                 DIG 8 ;
                 CAR ;
                 PAIR ;
                 PAIR ;
                 PAIR ;
                 TRANSFER_TOKENS ;
                 CONS ;
                 DUG 2 ;
                 SWAP ;
                 CAR ;
                 PAIR ;
                 CDR ;
                 SWAP ;
                 PAIR } }
           { SWAP ;
             DUP ;
             DIG 2 ;
             DUP ;
             DUG 3 ;
             CAR ;
             CAR ;
             GET ;
             IF_NONE { PUSH unit Unit } { DROP ; PUSH string "PermitExists" ; FAILWITH } ;
             DROP ;
             SWAP ;
             DUP ;
             DUG 2 ;
             CAR ;
             CAR ;
             DIG 2 ;
             DUP ;
             DUG 3 ;
             CAR ;
             CDR ;
             DIG 3 ;
             DUP ;
             DUG 4 ;
             CDR ;
             CHECK_SIGNATURE ;
             IF { DUP ;
                  DIG 2 ;
                  DUP ;
                  CAR ;
                  CAR ;
                  SWAP ;
                  SOME ;
                  SWAP ;
                  UPDATE ;
                  DIP { DROP } }
                { SWAP ; DROP ; PUSH string "InvalidSignature" ; FAILWITH } ;
             NIL operation ;
             PAIR } } }
