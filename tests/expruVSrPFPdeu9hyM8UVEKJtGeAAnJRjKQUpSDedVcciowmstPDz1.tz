{ parameter
    (or (or (or (or (or (address %blacklist) (pair %buy_tickets address (pair nat string)))
                    (or (pair %buy_tickets_with_kolibri address (pair nat string))
                        (pair %create_ticket address string)))
                (or (or (pair %redeem_tickets address (pair string nat)) (address %remove_pool))
                    (or (unit %reset_kolibri_tx_status) (address %update_admin))))
            (or (or (or (address %update_kolibri_address) (nat %update_kolibri_ticket_price))
                    (or (string %update_nickname) (mutez %update_nickname_fee)))
                (or (or (pair %update_pool_addresses address string)
                        (address %update_storage_contract))
                    (or (mutez %update_ticket_price) (string %update_ticket_types)))))
        (unit %withdraw_balance)) ;
  storage
    (pair (address %admin)
          (pair (big_map %pool_addresses address string)
                (pair (big_map %nicknames address (pair timestamp string))
                      (pair (big_map %blacklist address timestamp)
                            (pair (set %ticket_types string)
                                  (pair (mutez %ticket_price)
                                        (pair (int %ticket_validity)
                                              (pair (mutez %nickname_fee)
                                                    (pair (address %kolibri)
                                                          (pair (nat %kolibri_ticket_price)
                                                                (pair (bool %tx_to_kolibri) (address %storage_contract)))))))))))) ;
  code { UNPAIR ;
         IF_LEFT
           { IF_LEFT
               { IF_LEFT
                   { IF_LEFT
                       { IF_LEFT
                           { SWAP ;
                             DUP ;
                             DUG 2 ;
                             CAR ;
                             SENDER ;
                             COMPARE ;
                             NEQ ;
                             IF { DROP 2 ; PUSH string "NOT_AND_ADMIN" ; FAILWITH }
                                { SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  GET ;
                                  IF_NONE
                                    { SWAP ;
                                      DUP ;
                                      DUG 2 ;
                                      CDR ;
                                      CDR ;
                                      CDR ;
                                      CDR ;
                                      DUP 3 ;
                                      CDR ;
                                      CDR ;
                                      CDR ;
                                      CAR ;
                                      NOW ;
                                      DIG 3 ;
                                      SWAP ;
                                      SOME ;
                                      SWAP ;
                                      UPDATE ;
                                      PAIR ;
                                      SWAP ;
                                      DUP ;
                                      DUG 2 ;
                                      CDR ;
                                      CDR ;
                                      CAR ;
                                      PAIR ;
                                      SWAP ;
                                      DUP ;
                                      DUG 2 ;
                                      CDR ;
                                      CAR ;
                                      PAIR ;
                                      SWAP ;
                                      CAR ;
                                      PAIR }
                                    { DROP ;
                                      SWAP ;
                                      DUP ;
                                      DUG 2 ;
                                      CDR ;
                                      CDR ;
                                      CDR ;
                                      CDR ;
                                      DUP 3 ;
                                      CDR ;
                                      CDR ;
                                      CDR ;
                                      CAR ;
                                      DUP 3 ;
                                      NONE timestamp ;
                                      SWAP ;
                                      UPDATE ;
                                      PAIR ;
                                      DUP 3 ;
                                      CDR ;
                                      CDR ;
                                      CAR ;
                                      PAIR ;
                                      DUP 3 ;
                                      CDR ;
                                      CAR ;
                                      PAIR ;
                                      DUP 3 ;
                                      CAR ;
                                      PAIR ;
                                      DUP ;
                                      CDR ;
                                      CDR ;
                                      CDR ;
                                      DIG 3 ;
                                      CDR ;
                                      CDR ;
                                      CAR ;
                                      DIG 3 ;
                                      NONE (pair timestamp string) ;
                                      SWAP ;
                                      UPDATE ;
                                      PAIR ;
                                      SWAP ;
                                      DUP ;
                                      DUG 2 ;
                                      CDR ;
                                      CAR ;
                                      PAIR ;
                                      SWAP ;
                                      CAR ;
                                      PAIR } } ;
                             NIL operation ;
                             PAIR }
                           { DUP ;
                             CDR ;
                             UNPAIR ;
                             DUP 4 ;
                             CDR ;
                             CDR ;
                             CDR ;
                             CDR ;
                             CDR ;
                             CAR ;
                             SWAP ;
                             DUP ;
                             DUG 2 ;
                             MUL ;
                             AMOUNT ;
                             COMPARE ;
                             NEQ ;
                             PUSH mutez 0 ;
                             AMOUNT ;
                             COMPARE ;
                             NEQ ;
                             AND ;
                             IF { DROP 4 ; PUSH string "INCORRECT_AMOUNT" ; FAILWITH }
                                { SELF_ADDRESS ;
                                  SENDER ;
                                  COMPARE ;
                                  NEQ ;
                                  PUSH mutez 0 ;
                                  AMOUNT ;
                                  COMPARE ;
                                  EQ ;
                                  AND ;
                                  IF { DROP 4 ; PUSH string "INVALID_SENDER" ; FAILWITH }
                                     { DUP 4 ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CAR ;
                                       NOT ;
                                       SELF_ADDRESS ;
                                       SENDER ;
                                       COMPARE ;
                                       EQ ;
                                       PUSH mutez 0 ;
                                       AMOUNT ;
                                       COMPARE ;
                                       EQ ;
                                       AND ;
                                       AND ;
                                       IF { DROP 4 ; PUSH string "INVALID_KOLIBRI_BUY" ; FAILWITH }
                                          { PUSH nat 0 ;
                                            SWAP ;
                                            COMPARE ;
                                            EQ ;
                                            IF { DROP 3 ; PUSH string "ZERO_TICKET_AMOUNT" ; FAILWITH }
                                               { DUP 3 ;
                                                 CDR ;
                                                 CDR ;
                                                 CDR ;
                                                 CDR ;
                                                 CAR ;
                                                 SWAP ;
                                                 MEM ;
                                                 NOT ;
                                                 IF { DROP 2 ; PUSH string "INVALID_TICKET_TYPE" ; FAILWITH }
                                                    { UNPAIR ;
                                                      SWAP ;
                                                      UNPAIR ;
                                                      DUP 4 ;
                                                      CDR ;
                                                      CDR ;
                                                      CDR ;
                                                      CDR ;
                                                      CDR ;
                                                      CDR ;
                                                      CDR ;
                                                      CDR ;
                                                      CDR ;
                                                      CDR ;
                                                      CDR ;
                                                      CONTRACT %add_tickets
                                                        (pair (address %user) (pair (string %ticket_type) (nat %ticket_amount))) ;
                                                      IF_NONE { PUSH string "UNKNOWN_STORAGE_CONTRACT" ; FAILWITH } {} ;
                                                      PUSH mutez 0 ;
                                                      DIG 2 ;
                                                      DIG 3 ;
                                                      PAIR ;
                                                      DIG 3 ;
                                                      PAIR ;
                                                      TRANSFER_TOKENS ;
                                                      SWAP ;
                                                      DUP ;
                                                      DUG 2 ;
                                                      CDR ;
                                                      CDR ;
                                                      CDR ;
                                                      CDR ;
                                                      CDR ;
                                                      CDR ;
                                                      CDR ;
                                                      CDR ;
                                                      CDR ;
                                                      CDR ;
                                                      CAR ;
                                                      SELF_ADDRESS ;
                                                      SENDER ;
                                                      COMPARE ;
                                                      EQ ;
                                                      PUSH mutez 0 ;
                                                      AMOUNT ;
                                                      COMPARE ;
                                                      EQ ;
                                                      AND ;
                                                      AND ;
                                                      IF { SWAP ;
                                                           DUP ;
                                                           DUG 2 ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           PUSH bool False ;
                                                           PAIR ;
                                                           DUP 3 ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CAR ;
                                                           PAIR ;
                                                           DUP 3 ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CAR ;
                                                           PAIR ;
                                                           DUP 3 ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CAR ;
                                                           PAIR ;
                                                           DUP 3 ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CAR ;
                                                           PAIR ;
                                                           DUP 3 ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CAR ;
                                                           PAIR ;
                                                           DUP 3 ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CAR ;
                                                           PAIR ;
                                                           DUP 3 ;
                                                           CDR ;
                                                           CDR ;
                                                           CDR ;
                                                           CAR ;
                                                           PAIR ;
                                                           DUP 3 ;
                                                           CDR ;
                                                           CDR ;
                                                           CAR ;
                                                           PAIR ;
                                                           DUP 3 ;
                                                           CDR ;
                                                           CAR ;
                                                           PAIR ;
                                                           DIG 2 ;
                                                           CAR ;
                                                           PAIR ;
                                                           NIL operation ;
                                                           DIG 2 ;
                                                           CONS ;
                                                           PAIR }
                                                         { SWAP ; NIL operation ; DIG 2 ; CONS ; PAIR } } } } } } } }
                       { IF_LEFT
                           { SWAP ;
                             DUP ;
                             DUG 2 ;
                             CDR ;
                             CDR ;
                             CDR ;
                             CDR ;
                             CDR ;
                             CDR ;
                             CDR ;
                             CDR ;
                             CDR ;
                             CDR ;
                             CAR ;
                             IF { DROP 2 ; PUSH string "ONGOING_KOLIBRI_TX" ; FAILWITH }
                                { SELF_ADDRESS ;
                                  SENDER ;
                                  COMPARE ;
                                  EQ ;
                                  IF { DROP 2 ; PUSH string "NO_TX_FROM_SELF" ; FAILWITH }
                                     { DUP ;
                                       UNPAIR ;
                                       SWAP ;
                                       CAR ;
                                       SENDER ;
                                       DIG 2 ;
                                       COMPARE ;
                                       NEQ ;
                                       IF { DROP 3 ; PUSH string "PLAYER_IS_NOT_SENDER" ; FAILWITH }
                                          { DUP 3 ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CAR ;
                                            CONTRACT %transfer (pair (address %from) (pair (address %to) (nat %value))) ;
                                            IF_NONE { PUSH string "UNKNOWN_KOLIBRI_CONTRACT" ; FAILWITH } {} ;
                                            DUP 4 ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CAR ;
                                            DIG 2 ;
                                            MUL ;
                                            DUP 4 ;
                                            CAR ;
                                            PAIR ;
                                            SENDER ;
                                            PAIR ;
                                            SWAP ;
                                            PUSH mutez 0 ;
                                            DIG 2 ;
                                            TRANSFER_TOKENS ;
                                            SELF %buy_tickets ;
                                            PUSH mutez 0 ;
                                            DIG 3 ;
                                            TRANSFER_TOKENS ;
                                            DUP 3 ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            PUSH bool True ;
                                            PAIR ;
                                            DUP 4 ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CAR ;
                                            PAIR ;
                                            DUP 4 ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CAR ;
                                            PAIR ;
                                            DUP 4 ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CAR ;
                                            PAIR ;
                                            DUP 4 ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CAR ;
                                            PAIR ;
                                            DUP 4 ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CAR ;
                                            PAIR ;
                                            DUP 4 ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CAR ;
                                            PAIR ;
                                            DUP 4 ;
                                            CDR ;
                                            CDR ;
                                            CDR ;
                                            CAR ;
                                            PAIR ;
                                            DUP 4 ;
                                            CDR ;
                                            CDR ;
                                            CAR ;
                                            PAIR ;
                                            DUP 4 ;
                                            CDR ;
                                            CAR ;
                                            PAIR ;
                                            DIG 3 ;
                                            CAR ;
                                            PAIR ;
                                            NIL operation ;
                                            DIG 2 ;
                                            CONS ;
                                            DIG 2 ;
                                            CONS ;
                                            PAIR } } } }
                           { UNPAIR ;
                             DUP 3 ;
                             CDR ;
                             CAR ;
                             SENDER ;
                             MEM ;
                             DUP 4 ;
                             CAR ;
                             SENDER ;
                             COMPARE ;
                             EQ ;
                             OR ;
                             IF { DUP 3 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CONTRACT %add_tickets
                                    (pair (address %user) (pair (string %ticket_type) (nat %ticket_amount))) ;
                                  IF_NONE { PUSH string "UNKNOWN_STORAGE_CONTRACT" ; FAILWITH } {} ;
                                  PUSH mutez 0 ;
                                  PUSH nat 1 ;
                                  DIG 4 ;
                                  PAIR ;
                                  DIG 3 ;
                                  PAIR ;
                                  TRANSFER_TOKENS ;
                                  SWAP ;
                                  NIL operation ;
                                  DIG 2 ;
                                  CONS ;
                                  PAIR }
                                { DROP 3 ; PUSH string "FORBIDDEN_OP" ; FAILWITH } } } }
                   { IF_LEFT
                       { IF_LEFT
                           { SWAP ;
                             DUP ;
                             DUG 2 ;
                             CDR ;
                             CAR ;
                             SENDER ;
                             MEM ;
                             NOT ;
                             IF { DROP 2 ; PUSH string "UNKNOWN_POOL" ; FAILWITH }
                                { UNPAIR ;
                                  SWAP ;
                                  UNPAIR ;
                                  DUP 4 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CONTRACT %sub_tickets
                                    (pair (address %user)
                                          (pair (string %ticket_type) (pair (nat %amount_to_sub) (int %ticket_expiry)))) ;
                                  IF_NONE { PUSH string "UNKNOWN_STORAGE_CONTRACT" ; FAILWITH } {} ;
                                  PUSH mutez 0 ;
                                  DUP 6 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  DIG 4 ;
                                  PAIR ;
                                  DIG 3 ;
                                  PAIR ;
                                  DIG 3 ;
                                  PAIR ;
                                  TRANSFER_TOKENS ;
                                  SWAP ;
                                  NIL operation ;
                                  DIG 2 ;
                                  CONS ;
                                  PAIR } }
                           { SWAP ;
                             DUP ;
                             DUG 2 ;
                             CAR ;
                             SENDER ;
                             COMPARE ;
                             NEQ ;
                             IF { DROP 2 ; PUSH string "NOT_AND_ADMIN" ; FAILWITH }
                                { SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  DUP 3 ;
                                  CDR ;
                                  CAR ;
                                  DIG 2 ;
                                  NONE string ;
                                  SWAP ;
                                  UPDATE ;
                                  PAIR ;
                                  SWAP ;
                                  CAR ;
                                  PAIR } ;
                             NIL operation ;
                             PAIR } }
                       { IF_LEFT
                           { DROP ;
                             DUP ;
                             CAR ;
                             SENDER ;
                             COMPARE ;
                             NEQ ;
                             IF { DROP ; PUSH string "NOT_AND_ADMIN" ; FAILWITH }
                                { DUP ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  NOT ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  CAR ;
                                  PAIR } ;
                             NIL operation ;
                             PAIR }
                           { SWAP ;
                             DUP ;
                             DUG 2 ;
                             CAR ;
                             SENDER ;
                             COMPARE ;
                             NEQ ;
                             IF { DROP 2 ; PUSH string "NOT_AND_ADMIN" ; FAILWITH }
                                { SWAP ; CDR ; SWAP ; PAIR } ;
                             NIL operation ;
                             PAIR } } } }
               { IF_LEFT
                   { IF_LEFT
                       { IF_LEFT
                           { SWAP ;
                             DUP ;
                             DUG 2 ;
                             CAR ;
                             SENDER ;
                             COMPARE ;
                             NEQ ;
                             IF { DROP 2 ; PUSH string "NOT_AND_ADMIN" ; FAILWITH }
                                { SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  SWAP ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  CAR ;
                                  PAIR } ;
                             NIL operation ;
                             PAIR }
                           { SWAP ;
                             DUP ;
                             DUG 2 ;
                             CAR ;
                             SENDER ;
                             COMPARE ;
                             NEQ ;
                             IF { DROP 2 ; PUSH string "NOT_AND_ADMIN" ; FAILWITH }
                                { SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  SWAP ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  CAR ;
                                  PAIR } ;
                             NIL operation ;
                             PAIR } }
                       { IF_LEFT
                           { SWAP ;
                             DUP ;
                             DUG 2 ;
                             CDR ;
                             CDR ;
                             CDR ;
                             CDR ;
                             CDR ;
                             CDR ;
                             CDR ;
                             CAR ;
                             AMOUNT ;
                             COMPARE ;
                             NEQ ;
                             IF { DROP 2 ; PUSH string "INCORRECT_FEE" ; FAILWITH }
                                { PUSH nat 15 ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  SIZE ;
                                  COMPARE ;
                                  GT ;
                                  IF { DROP 2 ; PUSH string "NICKNAME_GREATER_THAN_30_CHAR" ; FAILWITH }
                                     { SWAP ;
                                       DUP ;
                                       DUG 2 ;
                                       CDR ;
                                       CDR ;
                                       CAR ;
                                       SENDER ;
                                       GET ;
                                       IF_NONE
                                         { SWAP ;
                                           DUP ;
                                           DUG 2 ;
                                           CDR ;
                                           CDR ;
                                           CDR ;
                                           DUP 3 ;
                                           CDR ;
                                           CDR ;
                                           CAR ;
                                           DIG 2 ;
                                           NOW ;
                                           PAIR ;
                                           SOME ;
                                           SENDER ;
                                           UPDATE ;
                                           PAIR ;
                                           SWAP ;
                                           DUP ;
                                           DUG 2 ;
                                           CDR ;
                                           CAR ;
                                           PAIR ;
                                           SWAP ;
                                           CAR ;
                                           PAIR }
                                         { NOW ;
                                           PUSH int 2592000 ;
                                           DIG 2 ;
                                           CAR ;
                                           ADD ;
                                           COMPARE ;
                                           GT ;
                                           IF { DROP 2 ; PUSH string "UPDATE_UNAVAILABLE" ; FAILWITH }
                                              { SWAP ;
                                                DUP ;
                                                DUG 2 ;
                                                CDR ;
                                                CDR ;
                                                CDR ;
                                                DUP 3 ;
                                                CDR ;
                                                CDR ;
                                                CAR ;
                                                DIG 2 ;
                                                NOW ;
                                                PAIR ;
                                                SOME ;
                                                SENDER ;
                                                UPDATE ;
                                                PAIR ;
                                                SWAP ;
                                                DUP ;
                                                DUG 2 ;
                                                CDR ;
                                                CAR ;
                                                PAIR ;
                                                SWAP ;
                                                CAR ;
                                                PAIR } } } } ;
                             NIL operation ;
                             PAIR }
                           { SWAP ;
                             DUP ;
                             DUG 2 ;
                             CAR ;
                             SENDER ;
                             COMPARE ;
                             NEQ ;
                             IF { DROP 2 ; PUSH string "NOT_AND_ADMIN" ; FAILWITH }
                                { SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  SWAP ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  CAR ;
                                  PAIR } ;
                             NIL operation ;
                             PAIR } } }
                   { IF_LEFT
                       { IF_LEFT
                           { SWAP ;
                             DUP ;
                             DUG 2 ;
                             CAR ;
                             SENDER ;
                             COMPARE ;
                             NEQ ;
                             IF { DROP 2 ; PUSH string "NOT_AND_ADMIN" ; FAILWITH }
                                { UNPAIR ;
                                  DUP 3 ;
                                  CDR ;
                                  CDR ;
                                  DUP 4 ;
                                  CDR ;
                                  CAR ;
                                  DUP 3 ;
                                  GET ;
                                  IF_NONE
                                    { DUP 4 ; CDR ; CAR ; DIG 3 ; DIG 3 ; SWAP ; SOME ; SWAP ; UPDATE }
                                    { DROP ; DUP 4 ; CDR ; CAR ; DIG 3 ; SOME ; DIG 3 ; UPDATE } ;
                                  PAIR ;
                                  SWAP ;
                                  CAR ;
                                  PAIR } ;
                             NIL operation ;
                             PAIR }
                           { SWAP ;
                             DUP ;
                             DUG 2 ;
                             CAR ;
                             SENDER ;
                             COMPARE ;
                             NEQ ;
                             IF { DROP 2 ; PUSH string "NOT_AND_ADMIN" ; FAILWITH }
                                { SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  CAR ;
                                  PAIR } ;
                             NIL operation ;
                             PAIR } }
                       { IF_LEFT
                           { SWAP ;
                             DUP ;
                             DUG 2 ;
                             CAR ;
                             SENDER ;
                             COMPARE ;
                             NEQ ;
                             IF { DROP 2 ; PUSH string "NOT_AND_ADMIN" ; FAILWITH }
                                { SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  SWAP ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CAR ;
                                  PAIR ;
                                  SWAP ;
                                  CAR ;
                                  PAIR } ;
                             NIL operation ;
                             PAIR }
                           { SWAP ;
                             DUP ;
                             DUG 2 ;
                             CAR ;
                             SENDER ;
                             COMPARE ;
                             NEQ ;
                             IF { DROP 2 ; PUSH string "NOT_AND_ADMIN" ; FAILWITH }
                                { SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CDR ;
                                  CAR ;
                                  SWAP ;
                                  DUP ;
                                  DUG 2 ;
                                  MEM ;
                                  IF { SWAP ;
                                       DUP ;
                                       DUG 2 ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       DUP 3 ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CAR ;
                                       DIG 2 ;
                                       PUSH bool False ;
                                       SWAP ;
                                       UPDATE ;
                                       PAIR ;
                                       SWAP ;
                                       DUP ;
                                       DUG 2 ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CAR ;
                                       PAIR ;
                                       SWAP ;
                                       DUP ;
                                       DUG 2 ;
                                       CDR ;
                                       CDR ;
                                       CAR ;
                                       PAIR ;
                                       SWAP ;
                                       DUP ;
                                       DUG 2 ;
                                       CDR ;
                                       CAR ;
                                       PAIR ;
                                       SWAP ;
                                       CAR ;
                                       PAIR }
                                     { SWAP ;
                                       DUP ;
                                       DUG 2 ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       DUP 3 ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CAR ;
                                       DIG 2 ;
                                       PUSH bool True ;
                                       SWAP ;
                                       UPDATE ;
                                       PAIR ;
                                       SWAP ;
                                       DUP ;
                                       DUG 2 ;
                                       CDR ;
                                       CDR ;
                                       CDR ;
                                       CAR ;
                                       PAIR ;
                                       SWAP ;
                                       DUP ;
                                       DUG 2 ;
                                       CDR ;
                                       CDR ;
                                       CAR ;
                                       PAIR ;
                                       SWAP ;
                                       DUP ;
                                       DUG 2 ;
                                       CDR ;
                                       CAR ;
                                       PAIR ;
                                       SWAP ;
                                       CAR ;
                                       PAIR } } ;
                             NIL operation ;
                             PAIR } } } } }
           { DROP ;
             DUP ;
             CAR ;
             SENDER ;
             COMPARE ;
             NEQ ;
             IF { DROP ; PUSH string "NOT_AND_ADMIN" ; FAILWITH }
                { DUP ;
                  CAR ;
                  CONTRACT unit ;
                  IF_NONE { PUSH string "UNKNOWN_ADDRESS" ; FAILWITH } {} ;
                  SWAP ;
                  NIL operation ;
                  DIG 2 ;
                  BALANCE ;
                  UNIT ;
                  TRANSFER_TOKENS ;
                  CONS ;
                  PAIR } } } }
