{ storage
    (pair (pair (address %admin)
                (pair (big_map %auctions
                         nat
                         (pair (address %token_address)
                               (pair (nat %token_amount)
                                     (pair (address %seller)
                                           (pair (mutez %bid_amount) (pair (mutez %buy_now_unit) (address %bidder)))))))
                      (address %fa2)))
          (pair (big_map %metadata string bytes)
                (pair (big_map %royalties nat (pair (address %issuer) (nat %royalties)))
                      (nat %token_id)))) ;
  parameter
    (or (or (nat %accept_bid) (or (nat %bid) (nat %cancel_auction)))
        (or (or (address %changeFA2) (address %change_admin))
            (or (pair %create_auction
                   (pair (mutez %bid_amount) (mutez %buy_now_unit))
                   (pair (address %token_address) (pair (nat %token_amount) (nat %token_id))))
                (pair %mint
                   (pair (address %address) (nat %amount))
                   (pair (map %metadata string bytes) (nat %royalties)))))) ;
  code { CAST (pair (or (or nat (or nat nat))
                        (or (or address address)
                            (or (pair (pair mutez mutez) (pair address (pair nat nat)))
                                (pair (pair address nat) (pair (map string bytes) nat)))))
                    (pair (pair address
                                (pair (big_map nat (pair address (pair nat (pair address (pair mutez (pair mutez address))))))
                                      address))
                          (pair (big_map string bytes) (pair (big_map nat (pair address nat)) nat)))) ;
         UNPAIR ;
         IF_LEFT
           { IF_LEFT
               { SWAP ;
                 DUP ;
                 DUG 2 ;
                 CAR ;
                 GET 3 ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 GET ;
                 IF_NONE { PUSH int 200 ; FAILWITH } {} ;
                 GET 5 ;
                 SENDER ;
                 COMPARE ;
                 EQ ;
                 IF { PUSH bool True }
                    { PUSH mutez 0 ;
                      DUP 3 ;
                      CAR ;
                      GET 3 ;
                      DUP 3 ;
                      GET ;
                      IF_NONE { PUSH int 200 ; FAILWITH } {} ;
                      GET 9 ;
                      COMPARE ;
                      GT ;
                      IF { SWAP ;
                           DUP ;
                           DUG 2 ;
                           CAR ;
                           GET 3 ;
                           SWAP ;
                           DUP ;
                           DUG 2 ;
                           GET ;
                           IF_NONE { PUSH int 200 ; FAILWITH } {} ;
                           GET 9 ;
                           DUP 3 ;
                           CAR ;
                           GET 3 ;
                           DUP 3 ;
                           GET ;
                           IF_NONE { PUSH int 200 ; FAILWITH } {} ;
                           GET 7 ;
                           COMPARE ;
                           GE }
                         { PUSH bool False } } ;
                 IF {} { PUSH string "You must be the seller to accept the bid" ; FAILWITH } ;
                 NIL operation ;
                 DUP 3 ;
                 CAR ;
                 GET 4 ;
                 CONTRACT %transfer (list (pair address (list (pair address (pair nat nat))))) ;
                 IF_NONE { PUSH int 82 ; FAILWITH } {} ;
                 PUSH mutez 0 ;
                 NIL (pair address (list (pair address (pair nat nat)))) ;
                 NIL (pair address (pair nat nat)) ;
                 PUSH nat 1 ;
                 DUP 7 ;
                 DUP 9 ;
                 CAR ;
                 GET 3 ;
                 DUP 9 ;
                 GET ;
                 IF_NONE { PUSH int 200 ; FAILWITH } {} ;
                 GET 10 ;
                 PAIR 3 ;
                 CONS ;
                 SELF_ADDRESS ;
                 PAIR ;
                 CONS ;
                 TRANSFER_TOKENS ;
                 CONS ;
                 DUP 3 ;
                 GET 5 ;
                 DUP 3 ;
                 GET ;
                 IF_NONE { PUSH int 211 ; FAILWITH } {} ;
                 CAR ;
                 CONTRACT unit ;
                 IF_NONE { PUSH int 211 ; FAILWITH } {} ;
                 PUSH mutez 1 ;
                 PUSH nat 25 ;
                 DUP 6 ;
                 GET 5 ;
                 DUP 6 ;
                 GET ;
                 IF_NONE { PUSH int 210 ; FAILWITH } {} ;
                 CDR ;
                 ADD ;
                 PUSH nat 1000 ;
                 PUSH nat 25 ;
                 DUP 8 ;
                 GET 5 ;
                 DUP 8 ;
                 GET ;
                 IF_NONE { PUSH int 209 ; FAILWITH } {} ;
                 CDR ;
                 ADD ;
                 PUSH mutez 1 ;
                 DUP 9 ;
                 CAR ;
                 GET 3 ;
                 DUP 9 ;
                 GET ;
                 IF_NONE { PUSH int 200 ; FAILWITH } {} ;
                 GET 7 ;
                 EDIV ;
                 IF_NONE { PUSH int 209 ; FAILWITH } {} ;
                 CAR ;
                 MUL ;
                 EDIV ;
                 IF_NONE { PUSH int 209 ; FAILWITH } { CAR } ;
                 DUP 7 ;
                 GET 5 ;
                 DUP 7 ;
                 GET ;
                 IF_NONE { PUSH int 210 ; FAILWITH } {} ;
                 CDR ;
                 MUL ;
                 EDIV ;
                 IF_NONE { PUSH int 210 ; FAILWITH } { CAR } ;
                 MUL ;
                 UNIT ;
                 TRANSFER_TOKENS ;
                 CONS ;
                 DUP 3 ;
                 CAR ;
                 CAR ;
                 CONTRACT unit ;
                 IF_NONE { PUSH int 215 ; FAILWITH } {} ;
                 PUSH mutez 1 ;
                 PUSH nat 25 ;
                 DUP 6 ;
                 GET 5 ;
                 DUP 6 ;
                 GET ;
                 IF_NONE { PUSH int 210 ; FAILWITH } {} ;
                 CDR ;
                 ADD ;
                 PUSH nat 1000 ;
                 PUSH nat 25 ;
                 DUP 8 ;
                 GET 5 ;
                 DUP 8 ;
                 GET ;
                 IF_NONE { PUSH int 209 ; FAILWITH } {} ;
                 CDR ;
                 ADD ;
                 PUSH mutez 1 ;
                 DUP 9 ;
                 CAR ;
                 GET 3 ;
                 DUP 9 ;
                 GET ;
                 IF_NONE { PUSH int 200 ; FAILWITH } {} ;
                 GET 7 ;
                 EDIV ;
                 IF_NONE { PUSH int 209 ; FAILWITH } {} ;
                 CAR ;
                 MUL ;
                 EDIV ;
                 IF_NONE { PUSH int 209 ; FAILWITH } { CAR } ;
                 DUP 7 ;
                 GET 5 ;
                 DUP 7 ;
                 GET ;
                 IF_NONE { PUSH int 210 ; FAILWITH } {} ;
                 CDR ;
                 MUL ;
                 EDIV ;
                 IF_NONE { PUSH int 210 ; FAILWITH } { CAR } ;
                 PUSH nat 1000 ;
                 PUSH nat 25 ;
                 DUP 8 ;
                 GET 5 ;
                 DUP 8 ;
                 GET ;
                 IF_NONE { PUSH int 209 ; FAILWITH } {} ;
                 CDR ;
                 ADD ;
                 PUSH mutez 1 ;
                 DUP 9 ;
                 CAR ;
                 GET 3 ;
                 DUP 9 ;
                 GET ;
                 IF_NONE { PUSH int 200 ; FAILWITH } {} ;
                 GET 7 ;
                 EDIV ;
                 IF_NONE { PUSH int 209 ; FAILWITH } {} ;
                 CAR ;
                 MUL ;
                 EDIV ;
                 IF_NONE { PUSH int 209 ; FAILWITH } { CAR } ;
                 SUB ;
                 ABS ;
                 MUL ;
                 UNIT ;
                 TRANSFER_TOKENS ;
                 CONS ;
                 DUP 3 ;
                 CAR ;
                 GET 3 ;
                 DUP 3 ;
                 GET ;
                 IF_NONE { PUSH int 200 ; FAILWITH } {} ;
                 GET 5 ;
                 CONTRACT unit ;
                 IF_NONE { PUSH int 219 ; FAILWITH } {} ;
                 PUSH mutez 1 ;
                 PUSH nat 1000 ;
                 PUSH nat 25 ;
                 DUP 7 ;
                 GET 5 ;
                 DUP 7 ;
                 GET ;
                 IF_NONE { PUSH int 209 ; FAILWITH } {} ;
                 CDR ;
                 ADD ;
                 PUSH mutez 1 ;
                 DUP 8 ;
                 CAR ;
                 GET 3 ;
                 DUP 8 ;
                 GET ;
                 IF_NONE { PUSH int 200 ; FAILWITH } {} ;
                 GET 7 ;
                 EDIV ;
                 IF_NONE { PUSH int 209 ; FAILWITH } {} ;
                 CAR ;
                 MUL ;
                 EDIV ;
                 IF_NONE { PUSH int 209 ; FAILWITH } { CAR } ;
                 MUL ;
                 DUP 5 ;
                 CAR ;
                 GET 3 ;
                 DUP 5 ;
                 GET ;
                 IF_NONE { PUSH int 200 ; FAILWITH } {} ;
                 GET 7 ;
                 SUB ;
                 UNIT ;
                 TRANSFER_TOKENS ;
                 CONS ;
                 DUP 3 ;
                 UNPAIR ;
                 UNPAIR ;
                 SWAP ;
                 UNPAIR ;
                 DUP ;
                 DUP 7 ;
                 DUP ;
                 DUG 2 ;
                 GET ;
                 IF_NONE { PUSH int 223 ; FAILWITH } {} ;
                 PUSH nat 1 ;
                 DIG 9 ;
                 CAR ;
                 GET 3 ;
                 DUP 10 ;
                 GET ;
                 IF_NONE { PUSH int 223 ; FAILWITH } {} ;
                 GET 3 ;
                 SUB ;
                 ABS ;
                 UPDATE 3 ;
                 SOME ;
                 SWAP ;
                 UPDATE ;
                 DUP ;
                 DUP 7 ;
                 DUP ;
                 DUG 2 ;
                 GET ;
                 IF_NONE { PUSH int 225 ; FAILWITH } {} ;
                 PUSH mutez 0 ;
                 UPDATE 7 ;
                 SOME ;
                 SWAP ;
                 UPDATE ;
                 PAIR ;
                 SWAP ;
                 PAIR ;
                 PAIR ;
                 DUG 2 ;
                 PUSH nat 0 ;
                 DUP 4 ;
                 CAR ;
                 GET 3 ;
                 DUP 4 ;
                 GET ;
                 IF_NONE { PUSH int 228 ; FAILWITH } {} ;
                 GET 3 ;
                 COMPARE ;
                 EQ ;
                 IF { DIG 2 ;
                      UNPAIR ;
                      UNPAIR ;
                      SWAP ;
                      UNPAIR ;
                      NONE (pair address (pair nat (pair address (pair mutez (pair mutez address))))) ;
                      DIG 6 ;
                      UPDATE ;
                      PAIR ;
                      SWAP ;
                      PAIR ;
                      PAIR ;
                      SWAP }
                    { SWAP ; DROP } }
               { IF_LEFT
                   { PUSH bytes 0x050a0000001601 ;
                     SENDER ;
                     PACK ;
                     COMPARE ;
                     LT ;
                     IF {} { PUSH string "Contracts cannot bid" ; FAILWITH } ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     CAR ;
                     GET 3 ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     GET ;
                     IF_NONE { PUSH int 147 ; FAILWITH } {} ;
                     GET 5 ;
                     SENDER ;
                     COMPARE ;
                     NEQ ;
                     IF {} { PUSH string "AUC_SELLER_CANNOT_BID" ; FAILWITH } ;
                     PUSH mutez 100000 ;
                     DUP 3 ;
                     CAR ;
                     GET 3 ;
                     DUP 3 ;
                     GET ;
                     IF_NONE { PUSH int 147 ; FAILWITH } {} ;
                     GET 7 ;
                     ADD ;
                     AMOUNT ;
                     COMPARE ;
                     GE ;
                     IF {} { PUSH string "AUC_BID_AMOUNT_TOO_LOW" ; FAILWITH } ;
                     PUSH mutez 0 ;
                     DUP 3 ;
                     CAR ;
                     GET 3 ;
                     DUP 3 ;
                     GET ;
                     IF_NONE { PUSH int 147 ; FAILWITH } {} ;
                     GET 9 ;
                     COMPARE ;
                     GT ;
                     IF { SWAP ;
                          DUP ;
                          DUG 2 ;
                          CAR ;
                          GET 3 ;
                          SWAP ;
                          DUP ;
                          DUG 2 ;
                          GET ;
                          IF_NONE { PUSH int 147 ; FAILWITH } {} ;
                          GET 9 ;
                          AMOUNT ;
                          COMPARE ;
                          GE }
                        { PUSH bool False } ;
                     IF { NIL operation ;
                          SELF_ADDRESS ;
                          CONTRACT %accept_bid nat ;
                          IF_NONE { PUSH int 162 ; FAILWITH } {} ;
                          PUSH mutez 0 ;
                          DUP 4 ;
                          TRANSFER_TOKENS ;
                          CONS }
                        { NIL operation } ;
                     DUP 3 ;
                     CAR ;
                     GET 3 ;
                     DUP 3 ;
                     GET ;
                     IF_NONE { PUSH int 147 ; FAILWITH } {} ;
                     GET 5 ;
                     DUP 4 ;
                     CAR ;
                     GET 3 ;
                     DUP 4 ;
                     GET ;
                     IF_NONE { PUSH int 147 ; FAILWITH } {} ;
                     GET 10 ;
                     COMPARE ;
                     NEQ ;
                     IF { DUP 3 ;
                          CAR ;
                          GET 3 ;
                          DUP 3 ;
                          GET ;
                          IF_NONE { PUSH int 147 ; FAILWITH } {} ;
                          GET 10 ;
                          CONTRACT unit ;
                          IF_NONE { PUSH int 169 ; FAILWITH } {} ;
                          DUP 4 ;
                          CAR ;
                          GET 3 ;
                          DUP 4 ;
                          GET ;
                          IF_NONE { PUSH int 147 ; FAILWITH } {} ;
                          GET 7 ;
                          UNIT ;
                          TRANSFER_TOKENS ;
                          CONS }
                        {} ;
                     DIG 2 ;
                     UNPAIR ;
                     UNPAIR ;
                     SWAP ;
                     UNPAIR ;
                     DUP ;
                     DUP 7 ;
                     DUP ;
                     DUG 2 ;
                     GET ;
                     IF_NONE { PUSH int 172 ; FAILWITH } {} ;
                     SENDER ;
                     UPDATE 10 ;
                     SOME ;
                     SWAP ;
                     UPDATE ;
                     DUP ;
                     DUP 7 ;
                     DUP ;
                     DUG 2 ;
                     GET ;
                     IF_NONE { PUSH int 173 ; FAILWITH } {} ;
                     AMOUNT ;
                     UPDATE 7 ;
                     SOME ;
                     SWAP ;
                     UPDATE ;
                     PAIR ;
                     SWAP ;
                     PAIR ;
                     PAIR ;
                     DUP ;
                     DUG 3 ;
                     UNPAIR ;
                     UNPAIR ;
                     SWAP ;
                     UNPAIR ;
                     DIG 6 ;
                     CAR ;
                     GET 3 ;
                     DUP 7 ;
                     GET ;
                     IF_NONE { PUSH int 147 ; FAILWITH } {} ;
                     SOME ;
                     DIG 6 ;
                     UPDATE ;
                     PAIR ;
                     SWAP ;
                     PAIR ;
                     PAIR ;
                     SWAP }
                   { SWAP ;
                     DUP ;
                     DUG 2 ;
                     CAR ;
                     GET 3 ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     GET ;
                     IF_NONE { PUSH int 183 ; FAILWITH } {} ;
                     GET 5 ;
                     SENDER ;
                     COMPARE ;
                     EQ ;
                     IF {}
                        { PUSH string "You must be the seller to cancel the auction" ; FAILWITH } ;
                     NIL operation ;
                     DUP 3 ;
                     CAR ;
                     GET 3 ;
                     DUP 3 ;
                     GET ;
                     IF_NONE { PUSH int 183 ; FAILWITH } {} ;
                     GET 10 ;
                     CONTRACT unit ;
                     IF_NONE { PUSH int 188 ; FAILWITH } {} ;
                     DUP 4 ;
                     CAR ;
                     GET 3 ;
                     DUP 4 ;
                     GET ;
                     IF_NONE { PUSH int 183 ; FAILWITH } {} ;
                     GET 7 ;
                     UNIT ;
                     TRANSFER_TOKENS ;
                     CONS ;
                     DUP 3 ;
                     CAR ;
                     GET 4 ;
                     CONTRACT %transfer (list (pair address (list (pair address (pair nat nat))))) ;
                     IF_NONE { PUSH int 82 ; FAILWITH } {} ;
                     PUSH mutez 0 ;
                     NIL (pair address (list (pair address (pair nat nat)))) ;
                     NIL (pair address (pair nat nat)) ;
                     DUP 7 ;
                     CAR ;
                     GET 3 ;
                     DUP 7 ;
                     GET ;
                     IF_NONE { PUSH int 183 ; FAILWITH } {} ;
                     GET 3 ;
                     DUP 7 ;
                     DUP 9 ;
                     CAR ;
                     GET 3 ;
                     DUP 9 ;
                     GET ;
                     IF_NONE { PUSH int 183 ; FAILWITH } {} ;
                     GET 5 ;
                     PAIR 3 ;
                     CONS ;
                     SELF_ADDRESS ;
                     PAIR ;
                     CONS ;
                     TRANSFER_TOKENS ;
                     CONS ;
                     DIG 2 ;
                     UNPAIR ;
                     UNPAIR ;
                     SWAP ;
                     UNPAIR ;
                     NONE (pair address (pair nat (pair address (pair mutez (pair mutez address))))) ;
                     DIG 6 ;
                     UPDATE ;
                     PAIR ;
                     SWAP ;
                     PAIR ;
                     PAIR ;
                     SWAP } } }
           { IF_LEFT
               { IF_LEFT
                   { SWAP ;
                     DUP ;
                     DUG 2 ;
                     CAR ;
                     CAR ;
                     SENDER ;
                     COMPARE ;
                     EQ ;
                     IF {}
                        { PUSH string "WrongCondition: sp.sender == self.data.admin" ; FAILWITH } ;
                     SWAP ;
                     UNPAIR ;
                     UNPAIR ;
                     SWAP ;
                     CAR ;
                     DIG 3 ;
                     SWAP ;
                     PAIR ;
                     SWAP ;
                     PAIR ;
                     PAIR }
                   { SWAP ;
                     DUP ;
                     DUG 2 ;
                     CAR ;
                     CAR ;
                     SENDER ;
                     COMPARE ;
                     EQ ;
                     IF {}
                        { PUSH string "WrongCondition: sp.sender == self.data.admin" ; FAILWITH } ;
                     SWAP ;
                     UNPAIR ;
                     CDR ;
                     DIG 2 ;
                     PAIR ;
                     PAIR } ;
                 NIL operation }
               { IF_LEFT
                   { DUP ;
                     GET 5 ;
                     PUSH nat 0 ;
                     COMPARE ;
                     LT ;
                     IF {} { PUSH string "AUC_TOKEN_AMOUNT_TOO_LOW" ; FAILWITH } ;
                     DUP ;
                     CAR ;
                     CAR ;
                     PUSH mutez 100000 ;
                     SWAP ;
                     COMPARE ;
                     GE ;
                     IF {} { PUSH string "AUC_BID_AMOUNT_TOO_LOW" ; FAILWITH } ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     CAR ;
                     GET 3 ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     GET 6 ;
                     MEM ;
                     IF { PUSH string "AUC_ID_ALREADY_IN_USE" ; FAILWITH } {} ;
                     NIL operation ;
                     DUP 3 ;
                     CAR ;
                     GET 4 ;
                     CONTRACT %transfer (list (pair address (list (pair address (pair nat nat))))) ;
                     IF_NONE { PUSH int 82 ; FAILWITH } {} ;
                     PUSH mutez 0 ;
                     NIL (pair address (list (pair address (pair nat nat)))) ;
                     NIL (pair address (pair nat nat)) ;
                     DIG 5 ;
                     DUP ;
                     GET 5 ;
                     SWAP ;
                     DUP ;
                     DUG 7 ;
                     GET 6 ;
                     SELF_ADDRESS ;
                     PAIR 3 ;
                     CONS ;
                     SENDER ;
                     PAIR ;
                     CONS ;
                     TRANSFER_TOKENS ;
                     CONS ;
                     DIG 2 ;
                     UNPAIR ;
                     UNPAIR ;
                     SWAP ;
                     UNPAIR ;
                     SENDER ;
                     DIG 6 ;
                     DUP ;
                     CAR ;
                     CDR ;
                     SWAP ;
                     DUP ;
                     DUG 8 ;
                     CAR ;
                     CAR ;
                     SENDER ;
                     DIG 9 ;
                     DUP ;
                     GET 5 ;
                     SWAP ;
                     DUP ;
                     DUG 11 ;
                     GET 3 ;
                     PAIR 6 ;
                     SOME ;
                     DIG 6 ;
                     GET 6 ;
                     UPDATE ;
                     PAIR ;
                     SWAP ;
                     PAIR ;
                     PAIR ;
                     SWAP }
                   { DUP ;
                     CAR ;
                     CDR ;
                     PUSH nat 0 ;
                     COMPARE ;
                     LT ;
                     IF { DUP ;
                          GET 4 ;
                          PUSH nat 0 ;
                          SWAP ;
                          COMPARE ;
                          GE ;
                          IF { DUP ; GET 4 ; PUSH nat 250 ; SWAP ; COMPARE ; LE }
                             { PUSH bool False } }
                        { PUSH bool False } ;
                     IF { DUP ; GET 3 ; SIZE ; PUSH nat 0 ; COMPARE ; LT } { PUSH bool False } ;
                     IF {}
                        { PUSH string
                               "WrongCondition: ((params.amount > 0) & ((params.royalties >= 0) & (params.royalties <= 250))) & (sp.len(params.metadata) > 0)" ;
                          FAILWITH } ;
                     NIL operation ;
                     DUP 3 ;
                     CAR ;
                     GET 4 ;
                     CONTRACT %mint (pair (pair address nat) (pair nat (map string bytes))) ;
                     IF_NONE { PUSH int 48 ; FAILWITH } {} ;
                     PUSH mutez 0 ;
                     DUP 4 ;
                     GET 3 ;
                     DUP 6 ;
                     GET 6 ;
                     PAIR ;
                     DIG 4 ;
                     DUP ;
                     CAR ;
                     CDR ;
                     SWAP ;
                     DUP ;
                     DUG 6 ;
                     CAR ;
                     CAR ;
                     PAIR ;
                     PAIR ;
                     TRANSFER_TOKENS ;
                     CONS ;
                     DUP 3 ;
                     DUP ;
                     GET 5 ;
                     DIG 3 ;
                     GET 4 ;
                     SENDER ;
                     PAIR ;
                     SOME ;
                     DIG 4 ;
                     GET 6 ;
                     UPDATE ;
                     UPDATE 5 ;
                     DUP ;
                     GET 6 ;
                     PUSH nat 1 ;
                     ADD ;
                     UPDATE 6 ;
                     SWAP } } } ;
         NIL operation ;
         SWAP ;
         ITER { CONS } ;
         PAIR } }
