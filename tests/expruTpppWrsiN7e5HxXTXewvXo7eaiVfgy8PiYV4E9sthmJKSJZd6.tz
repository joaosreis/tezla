{ storage
    (pair (pair (address %admin) (address %issuer))
          (pair (big_map %users address nat)
                (big_map %whitelists nat (pair (set %allowed_whitelists nat) (bool %unrestricted))))) ;
  parameter
    (or (or (pair %add_user (address %new_user) (nat %new_user_whitelist))
            (pair %assert_transfer (address %from_) (address %to_)))
        (or (address %set_admin)
            (or (address %set_issuer)
                (pair %set_whitelist_outbound
                   (pair %new_outbound_whitelists (set %allowed_whitelists nat) (bool %unrestricted))
                   (nat %whitelist_id))))) ;
  code { DUP ;
         CDR ;
         SWAP ;
         CAR ;
         IF_LEFT
           { IF_LEFT
               { { SWAP ;
                   DUP ;
                   DUG 2 ;
                   CAR ;
                   CAR ;
                   SENDER ;
                   COMPARE ;
                   EQ ;
                   IF { {} } { { PUSH string "only admin may update" ; FAILWITH } } ;
                   DUP ;
                   CAR ;
                   DIG 2 ;
                   DUP ;
                   DUG 3 ;
                   CAR ;
                   CDR ;
                   COMPARE ;
                   EQ ;
                   IF { { PUSH string "issuer is not a user" ; FAILWITH } } { {} } ;
                   SWAP ;
                   DUP ;
                   DUG 2 ;
                   DUP ;
                   CAR ;
                   SWAP ;
                   CDR ;
                   DUP ;
                   CDR ;
                   SWAP ;
                   CAR ;
                   DIG 3 ;
                   DUP ;
                   DUG 4 ;
                   CDR ;
                   SOME ;
                   DIG 4 ;
                   DUP ;
                   DUG 5 ;
                   CAR ;
                   UPDATE ;
                   PAIR ;
                   SWAP ;
                   PAIR ;
                   DUG 2 ;
                   DROP 2 } }
               { { SWAP ;
                   DUP ;
                   DUG 2 ;
                   CAR ;
                   CDR ;
                   SWAP ;
                   DUP ;
                   DUG 2 ;
                   CAR ;
                   COMPARE ;
                   EQ ;
                   IF { {} }
                      { { SWAP ;
                          DUP ;
                          DUG 2 ;
                          CDR ;
                          CAR ;
                          SWAP ;
                          DUP ;
                          DUG 2 ;
                          CAR ;
                          MEM ;
                          DROP ;
                          SWAP ;
                          DUP ;
                          DUG 2 ;
                          CDR ;
                          CAR ;
                          SWAP ;
                          DUP ;
                          DUG 2 ;
                          CDR ;
                          MEM ;
                          DROP ;
                          SWAP ;
                          DUP ;
                          DUG 2 ;
                          CDR ;
                          CDR ;
                          DIG 2 ;
                          DUP ;
                          DUG 3 ;
                          CDR ;
                          CAR ;
                          DIG 2 ;
                          DUP ;
                          DUG 3 ;
                          CAR ;
                          GET ;
                          IF_NONE { { PUSH string "Get-item:94" ; FAILWITH } } {} ;
                          MEM ;
                          DROP ;
                          SWAP ;
                          DUP ;
                          DUG 2 ;
                          CDR ;
                          CDR ;
                          DIG 2 ;
                          DUP ;
                          DUG 3 ;
                          CDR ;
                          CAR ;
                          DIG 2 ;
                          DUP ;
                          DUG 3 ;
                          CAR ;
                          GET ;
                          IF_NONE { { PUSH string "Get-item:94" ; FAILWITH } } {} ;
                          GET ;
                          IF_NONE { { PUSH string "Get-item:41" ; FAILWITH } } {} ;
                          DROP ;
                          SWAP ;
                          DUP ;
                          DUG 2 ;
                          CDR ;
                          CDR ;
                          DIG 2 ;
                          DUP ;
                          DUG 3 ;
                          CDR ;
                          CAR ;
                          DIG 2 ;
                          DUP ;
                          DUG 3 ;
                          CAR ;
                          GET ;
                          IF_NONE { { PUSH string "Get-item:94" ; FAILWITH } } {} ;
                          GET ;
                          IF_NONE { { PUSH string "Get-item:41" ; FAILWITH } } {} ;
                          CAR ;
                          DIG 2 ;
                          DUP ;
                          DUG 3 ;
                          CDR ;
                          CAR ;
                          DIG 2 ;
                          DUP ;
                          DUG 3 ;
                          CDR ;
                          GET ;
                          IF_NONE { { PUSH string "Get-item:98" ; FAILWITH } } {} ;
                          MEM ;
                          IF { {} } { { PUSH string "outbound not whitelisted" ; FAILWITH } } } } ;
                   DROP } } }
           { IF_LEFT
               { { SWAP ;
                   DUP ;
                   DUG 2 ;
                   CAR ;
                   CAR ;
                   SENDER ;
                   COMPARE ;
                   EQ ;
                   IF { {} } { { PUSH string "only admin may update" ; FAILWITH } } ;
                   SWAP ;
                   DUP ;
                   DUG 2 ;
                   DUP ;
                   CDR ;
                   SWAP ;
                   CAR ;
                   CDR ;
                   DIG 2 ;
                   DUP ;
                   DUG 3 ;
                   PAIR ;
                   PAIR ;
                   DUG 2 ;
                   DROP 2 } }
               { IF_LEFT
                   { { SWAP ;
                       DUP ;
                       DUG 2 ;
                       CAR ;
                       CAR ;
                       SENDER ;
                       COMPARE ;
                       EQ ;
                       IF { {} } { { PUSH string "only admin may update" ; FAILWITH } } ;
                       SWAP ;
                       DUP ;
                       DUG 2 ;
                       DUP ;
                       CDR ;
                       SWAP ;
                       CAR ;
                       CAR ;
                       DIG 2 ;
                       DUP ;
                       DUG 3 ;
                       SWAP ;
                       PAIR ;
                       PAIR ;
                       DUG 2 ;
                       DROP 2 } }
                   { { SWAP ;
                       DUP ;
                       DUG 2 ;
                       CAR ;
                       CAR ;
                       SENDER ;
                       COMPARE ;
                       EQ ;
                       IF { {} } { { PUSH string "only admin may update" ; FAILWITH } } ;
                       SWAP ;
                       DUP ;
                       DUG 2 ;
                       DUP ;
                       CAR ;
                       SWAP ;
                       CDR ;
                       DUP ;
                       CAR ;
                       SWAP ;
                       CDR ;
                       DIG 3 ;
                       DUP ;
                       DUG 4 ;
                       CAR ;
                       SOME ;
                       DIG 4 ;
                       DUP ;
                       DUG 5 ;
                       CDR ;
                       UPDATE ;
                       SWAP ;
                       PAIR ;
                       SWAP ;
                       PAIR ;
                       DUG 2 ;
                       DROP 2 } } } } ;
         NIL operation ;
         PAIR } }
