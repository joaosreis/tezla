{ storage
    (big_map
       nat
       (pair (pair (nat %bid_price) (pair (address %bidder) (timestamp %end_timestamp)))
             (pair (pair (address %ft_address) (address %nft_address))
                   (pair (nat %nft_id) (address %seller))))) ;
  parameter
    (or (pair %bid (nat %auction_id) (nat %bid_price))
        (or (pair %create_auction
               (pair (nat %auction_id) (pair (nat %bid_price) (timestamp %end_timestamp)))
               (pair (address %ft_address) (pair (address %nft_address) (nat %nft_id))))
            (nat %withdraw))) ;
  code { UNPAIR ;
         IF_LEFT
           { PUSH address "tz3jfebmewtfXYD1Xef34TwrfMg2rrrw6oum" ;
             SENDER ;
             COMPARE ;
             LE ;
             IF {} { PUSH string "AUC_INVALID_ADDRESS" ; FAILWITH } ;
             SWAP ;
             DUP ;
             DUG 2 ;
             SWAP ;
             DUP ;
             DUG 2 ;
             CAR ;
             GET ;
             IF_NONE { PUSH int 573 ; FAILWITH } {} ;
             GET 6 ;
             SENDER ;
             COMPARE ;
             NEQ ;
             IF {} { PUSH string "AUC_SELLER_CANNOT_BID" ; FAILWITH } ;
             PUSH nat 10 ;
             DUP 3 ;
             DUP 3 ;
             CAR ;
             GET ;
             IF_NONE { PUSH int 573 ; FAILWITH } {} ;
             CAR ;
             CAR ;
             ADD ;
             SWAP ;
             DUP ;
             DUG 2 ;
             CDR ;
             COMPARE ;
             GE ;
             IF {} { PUSH string "AUC_BID_PRICE_TOO_LOW" ; FAILWITH } ;
             SWAP ;
             DUP ;
             DUG 2 ;
             SWAP ;
             DUP ;
             DUG 2 ;
             CAR ;
             GET ;
             IF_NONE { PUSH int 573 ; FAILWITH } {} ;
             CAR ;
             GET 4 ;
             NOW ;
             COMPARE ;
             LT ;
             IF {} { PUSH string "AUC_AUCTION_IS_OVER" ; FAILWITH } ;
             NIL operation ;
             DUP 3 ;
             DUP 3 ;
             CAR ;
             GET ;
             IF_NONE { PUSH int 573 ; FAILWITH } {} ;
             GET 3 ;
             CAR ;
             CONTRACT %transfer
               (list (pair (address %from_)
                           (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount)))))) ;
             IF_NONE { PUSH string "error bid ft" ; FAILWITH } {} ;
             PUSH mutez 0 ;
             NIL (pair (address %from_)
                       (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount))))) ;
             NIL (pair (address %to_) (pair (nat %token_id) (nat %amount))) ;
             DUP 6 ;
             CDR ;
             PUSH nat 0 ;
             PAIR %token_id %amount ;
             SELF_ADDRESS ;
             PAIR %to_ ;
             CONS ;
             SENDER ;
             PAIR %from_ %txs ;
             CONS ;
             TRANSFER_TOKENS ;
             CONS ;
             DUP 3 ;
             DUP 3 ;
             CAR ;
             GET ;
             IF_NONE { PUSH int 573 ; FAILWITH } {} ;
             GET 6 ;
             DUP 4 ;
             DUP 4 ;
             CAR ;
             GET ;
             IF_NONE { PUSH int 573 ; FAILWITH } {} ;
             CAR ;
             GET 3 ;
             COMPARE ;
             NEQ ;
             IF { DUP 3 ;
                  DUP 3 ;
                  CAR ;
                  GET ;
                  IF_NONE { PUSH int 573 ; FAILWITH } {} ;
                  GET 3 ;
                  CAR ;
                  CONTRACT %transfer
                    (list (pair (address %from_)
                                (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount)))))) ;
                  IF_NONE { PUSH string "error bid ft" ; FAILWITH } {} ;
                  PUSH mutez 0 ;
                  NIL (pair (address %from_)
                            (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount))))) ;
                  NIL (pair (address %to_) (pair (nat %token_id) (nat %amount))) ;
                  DUP 7 ;
                  DUP 7 ;
                  CAR ;
                  GET ;
                  IF_NONE { PUSH int 573 ; FAILWITH } {} ;
                  CAR ;
                  CAR ;
                  PUSH nat 0 ;
                  PAIR %token_id %amount ;
                  DUP 8 ;
                  DUP 8 ;
                  CAR ;
                  GET ;
                  IF_NONE { PUSH int 573 ; FAILWITH } {} ;
                  CAR ;
                  GET 3 ;
                  PAIR %to_ ;
                  CONS ;
                  SELF_ADDRESS ;
                  PAIR %from_ %txs ;
                  CONS ;
                  TRANSFER_TOKENS ;
                  CONS }
                {} ;
             DIG 2 ;
             DUP ;
             DUP 4 ;
             CAR ;
             DUP ;
             DUG 2 ;
             GET ;
             IF_NONE { PUSH int 589 ; FAILWITH } {} ;
             UNPAIR ;
             UNPAIR ;
             SWAP ;
             CDR ;
             SENDER ;
             PAIR ;
             SWAP ;
             PAIR ;
             PAIR ;
             SOME ;
             SWAP ;
             UPDATE ;
             DUP ;
             DUP 4 ;
             CAR ;
             DUP ;
             DUG 2 ;
             GET ;
             IF_NONE { PUSH int 590 ; FAILWITH } {} ;
             UNPAIR ;
             CDR ;
             DUP 6 ;
             CDR ;
             PAIR ;
             PAIR ;
             SOME ;
             SWAP ;
             UPDATE ;
             DUP ;
             DUP 4 ;
             CAR ;
             GET ;
             IF_NONE { PUSH int 573 ; FAILWITH } {} ;
             SOME ;
             DIG 3 ;
             CAR ;
             UPDATE ;
             SWAP }
           { IF_LEFT
               { PUSH address "tz3jfebmewtfXYD1Xef34TwrfMg2rrrw6oum" ;
                 SENDER ;
                 COMPARE ;
                 LE ;
                 IF {} { PUSH string "AUC_INVALID_ADDRESS" ; FAILWITH } ;
                 NOW ;
                 PUSH int 60 ;
                 DUP ;
                 PUSH int 1 ;
                 MUL ;
                 MUL ;
                 ADD ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 CAR ;
                 GET 4 ;
                 COMPARE ;
                 GE ;
                 IF {} { PUSH string "AUC_END_DATE_TOO_SOON" ; FAILWITH } ;
                 NOW ;
                 PUSH int 60 ;
                 DUP ;
                 PUSH int 168 ;
                 MUL ;
                 MUL ;
                 ADD ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 CAR ;
                 GET 4 ;
                 COMPARE ;
                 LE ;
                 IF {} { PUSH string "AUC_END_DATE_TOO_LATE" ; FAILWITH } ;
                 DUP ;
                 CAR ;
                 GET 3 ;
                 PUSH nat 100 ;
                 SWAP ;
                 COMPARE ;
                 GE ;
                 IF {} { PUSH string "AUC_BID_PRICE_TOO_LOW" ; FAILWITH } ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 CAR ;
                 CAR ;
                 MEM ;
                 IF { PUSH string "AUC_ID_ALREADY_IN_USE" ; FAILWITH } {} ;
                 DUP ;
                 GET 5 ;
                 CONTRACT %transfer
                   (list (pair (address %from_)
                               (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount)))))) ;
                 IF_NONE { PUSH string "error create auction nft" ; FAILWITH } {} ;
                 NIL operation ;
                 SWAP ;
                 PUSH mutez 0 ;
                 NIL (pair (address %from_)
                           (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount))))) ;
                 NIL (pair (address %to_) (pair (nat %token_id) (nat %amount))) ;
                 PUSH nat 1 ;
                 DUP 7 ;
                 GET 6 ;
                 PAIR %token_id %amount ;
                 SELF_ADDRESS ;
                 PAIR %to_ ;
                 CONS ;
                 SENDER ;
                 PAIR %from_ %txs ;
                 CONS ;
                 TRANSFER_TOKENS ;
                 CONS ;
                 DIG 2 ;
                 SENDER ;
                 DUP 4 ;
                 GET 6 ;
                 PAIR %nft_id %seller ;
                 DIG 3 ;
                 DUP ;
                 GET 5 ;
                 SWAP ;
                 DUP ;
                 DUG 5 ;
                 GET 3 ;
                 PAIR %ft_address %nft_address ;
                 PAIR ;
                 DUP 4 ;
                 CAR ;
                 GET 4 ;
                 SENDER ;
                 PAIR %bidder %end_timestamp ;
                 DUP 5 ;
                 CAR ;
                 GET 3 ;
                 PAIR %bid_price ;
                 PAIR ;
                 SOME ;
                 DIG 3 ;
                 CAR ;
                 CAR ;
                 UPDATE ;
                 SWAP }
               { SWAP ;
                 DUP ;
                 DUG 2 ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 GET ;
                 IF_NONE { PUSH int 599 ; FAILWITH } {} ;
                 CAR ;
                 GET 4 ;
                 NOW ;
                 COMPARE ;
                 GE ;
                 IF {} { PUSH string "AUC_AUCTION_IS_ONGOING" ; FAILWITH } ;
                 NIL operation ;
                 DUP 3 ;
                 DUP 3 ;
                 GET ;
                 IF_NONE { PUSH int 599 ; FAILWITH } {} ;
                 GET 3 ;
                 CDR ;
                 CONTRACT %transfer
                   (list (pair (address %from_)
                               (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount)))))) ;
                 IF_NONE { PUSH int 603 ; FAILWITH } {} ;
                 PUSH mutez 0 ;
                 NIL (pair (address %from_)
                           (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount))))) ;
                 NIL (pair (address %to_) (pair (nat %token_id) (nat %amount))) ;
                 PUSH nat 1 ;
                 DUP 8 ;
                 DUP 8 ;
                 GET ;
                 IF_NONE { PUSH int 599 ; FAILWITH } {} ;
                 GET 5 ;
                 PAIR %token_id %amount ;
                 DUP 8 ;
                 DUP 8 ;
                 GET ;
                 IF_NONE { PUSH int 599 ; FAILWITH } {} ;
                 CAR ;
                 GET 3 ;
                 PAIR %to_ ;
                 CONS ;
                 SELF_ADDRESS ;
                 PAIR %from_ %txs ;
                 CONS ;
                 TRANSFER_TOKENS ;
                 CONS ;
                 DUP 3 ;
                 DUP 3 ;
                 GET ;
                 IF_NONE { PUSH int 599 ; FAILWITH } {} ;
                 GET 6 ;
                 DUP 4 ;
                 DUP 4 ;
                 GET ;
                 IF_NONE { PUSH int 599 ; FAILWITH } {} ;
                 CAR ;
                 GET 3 ;
                 COMPARE ;
                 NEQ ;
                 IF { DUP 3 ;
                      DUP 3 ;
                      GET ;
                      IF_NONE { PUSH int 599 ; FAILWITH } {} ;
                      GET 3 ;
                      CAR ;
                      CONTRACT %transfer
                        (list (pair (address %from_)
                                    (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount)))))) ;
                      IF_NONE { PUSH int 608 ; FAILWITH } {} ;
                      PUSH mutez 0 ;
                      NIL (pair (address %from_)
                                (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount))))) ;
                      NIL (pair (address %to_) (pair (nat %token_id) (nat %amount))) ;
                      DUP 7 ;
                      DUP 7 ;
                      GET ;
                      IF_NONE { PUSH int 599 ; FAILWITH } {} ;
                      CAR ;
                      CAR ;
                      PUSH nat 0 ;
                      PAIR %token_id %amount ;
                      DUP 8 ;
                      DUP 8 ;
                      GET ;
                      IF_NONE { PUSH int 599 ; FAILWITH } {} ;
                      GET 6 ;
                      PAIR %to_ ;
                      CONS ;
                      SELF_ADDRESS ;
                      PAIR %from_ %txs ;
                      CONS ;
                      TRANSFER_TOKENS ;
                      CONS }
                    {} ;
                 DIG 2 ;
                 NONE (pair (pair (nat %bid_price) (pair (address %bidder) (timestamp %end_timestamp)))
                            (pair (pair (address %ft_address) (address %nft_address))
                                  (pair (nat %nft_id) (address %seller)))) ;
                 DIG 3 ;
                 UPDATE ;
                 SWAP } } ;
         NIL operation ;
         SWAP ;
         ITER { CONS } ;
         PAIR } }
