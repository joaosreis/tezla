{ parameter
    (or (or %asset
           (pair %burn (nat %amount) (address %to_))
           (list %mint (pair (address %to_) (pair (nat %token_id) (nat %amount)))))
        (or %fa2
           (or (pair %balance_of
                  (list %requests (pair (address %owner) (nat %token_id)))
                  (contract %callback
                     (list (pair (pair %request (address %owner) (nat %token_id)) (nat %balance)))))
               (contract %token_metadata_registry address))
           (or (list %transfer
                  (pair (address %from_)
                        (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount))))))
               (list %update_operators
                  (or (pair %add_operator
                         (address %owner)
                         (pair %operator (address %operator) (nat %token_id)))
                      (pair %remove_operator
                         (address %owner)
                         (pair %operator (address %operator) (nat %token_id)))))))) ;
  storage
    (pair (pair (big_map %ledger address (map nat (pair (nat %balance) (set %operators address))))
                (set %owner address))
          (pair (set %token_ids nat)
                (big_map %token_metadata nat (pair (nat %token_id) (map %token_info string bytes))))) ;
  code { PUSH nat 0 ;
         LAMBDA
           (pair nat (set nat))
           unit
           { { { DUP ; CAR ; DIP { CDR } } } ;
             MEM ;
             IF { UNIT } { PUSH string "FA2_TOKEN_UNDEFINED" ; FAILWITH } } ;
         LAMBDA
           (pair address
                 (pair (pair (big_map address (map nat (pair nat (set address)))) (set address))
                       (pair (set nat) (big_map nat (pair nat (map string bytes))))))
           (map nat (pair nat (set address)))
           { { { DUP ; CAR ; DIP { CDR } } } ;
             SWAP ;
             CAR ;
             CAR ;
             SWAP ;
             GET ;
             IF_NONE { EMPTY_MAP nat (pair nat (set address)) } {} } ;
         LAMBDA
           (pair nat (map nat (pair nat (set address))))
           (pair nat (set address))
           { { { DUP ; CAR ; DIP { CDR } } } ;
             GET ;
             IF_NONE { EMPTY_SET address ; PUSH nat 0 ; PAIR } {} } ;
         DIG 4 ;
         { { DUP ; CAR ; DIP { CDR } } } ;
         PUSH string "XTZ_RECEIVED" ;
         PUSH mutez 0 ;
         AMOUNT ;
         COMPARE ;
         NEQ ;
         IF { FAILWITH } { DROP } ;
         IF_LEFT
           { DIG 4 ;
             DROP ;
             IF_LEFT
               { DROP ; SWAP ; DROP ; SWAP ; DROP ; SWAP ; DROP ; NIL operation ; PAIR }
               { SWAP ;
                 DUP ;
                 DUG 2 ;
                 CAR ;
                 CDR ;
                 SENDER ;
                 MEM ;
                 NOT ;
                 IF { PUSH string "FA2_not_owner" ; FAILWITH } {} ;
                 SWAP ;
                 DUP ;
                 DUG 2 ;
                 SWAP ;
                 ITER { DUP ;
                        DUG 2 ;
                        CDR ;
                        CDR ;
                        { DIP 2 { DUP } ; DIG 3 } ;
                        CAR ;
                        { DIP 2 { DUP } ; DIG 3 } ;
                        SWAP ;
                        DUP ;
                        DUG 2 ;
                        PAIR ;
                        { DIP 7 { DUP } ; DIG 8 } ;
                        SWAP ;
                        EXEC ;
                        DUP ;
                        { DIP 3 { DUP } ; DIG 4 } ;
                        PAIR ;
                        { DIP 7 { DUP } ; DIG 8 } ;
                        SWAP ;
                        EXEC ;
                        { DIP 9 { DUP } ; DIG 10 } ;
                        { DIP 4 { DUP } ; DIG 5 } ;
                        COMPARE ;
                        EQ ;
                        IF { DUP ;
                             CDR ;
                             DIG 6 ;
                             CDR ;
                             CAR ;
                             DIG 2 ;
                             CAR ;
                             ADD ;
                             PAIR ;
                             SOME ;
                             DIG 3 ;
                             UPDATE ;
                             DIG 2 ;
                             PAIR }
                           { DIG 5 ;
                             DROP ;
                             { DIP 4 { DUP } ; DIG 5 } ;
                             CDR ;
                             CAR ;
                             { DIP 4 { DUP } ; DIG 5 } ;
                             MEM ;
                             IF { PUSH string "FA2_NFT_EXIST" ; FAILWITH } {} ;
                             CDR ;
                             PUSH nat 1 ;
                             PAIR ;
                             SOME ;
                             { DIP 3 { DUP } ; DIG 4 } ;
                             UPDATE ;
                             { DIP 3 { DUP } ; DIG 4 } ;
                             CDR ;
                             CDR ;
                             { DIP 4 { DUP } ; DIG 5 } ;
                             CDR ;
                             CAR ;
                             DIG 4 ;
                             PUSH bool True ;
                             SWAP ;
                             UPDATE ;
                             PAIR ;
                             DIG 3 ;
                             CAR ;
                             PAIR ;
                             PAIR } ;
                        DUP ;
                        CAR ;
                        DUP ;
                        CDR ;
                        SWAP ;
                        DUP ;
                        DUG 2 ;
                        CAR ;
                        CDR ;
                        DIG 2 ;
                        CAR ;
                        CAR ;
                        DIG 3 ;
                        CDR ;
                        SOME ;
                        DIG 4 ;
                        UPDATE ;
                        PAIR ;
                        PAIR } ;
                 DIG 2 ;
                 DROP ;
                 DIG 2 ;
                 DROP ;
                 DIG 2 ;
                 DROP 2 ;
                 NIL operation ;
                 PAIR } }
           { IF_LEFT
               { DIG 5 ;
                 DROP ;
                 IF_LEFT
                   { DUP ;
                     CAR ;
                     MAP { { DIP 2 { DUP } ; DIG 3 } ;
                           CDR ;
                           CAR ;
                           SWAP ;
                           DUP ;
                           DUG 2 ;
                           CDR ;
                           PAIR ;
                           { DIP 6 { DUP } ; DIG 7 } ;
                           SWAP ;
                           EXEC ;
                           DROP ;
                           { DIP 2 { DUP } ; DIG 3 } ;
                           SWAP ;
                           DUP ;
                           DUG 2 ;
                           CAR ;
                           PAIR ;
                           { DIP 5 { DUP } ; DIG 6 } ;
                           SWAP ;
                           EXEC ;
                           SWAP ;
                           DUP ;
                           DUG 2 ;
                           CDR ;
                           PAIR ;
                           { DIP 4 { DUP } ; DIG 5 } ;
                           SWAP ;
                           EXEC ;
                           CAR ;
                           SWAP ;
                           PAIR } ;
                     DIG 3 ;
                     DROP ;
                     DIG 3 ;
                     DROP ;
                     DIG 3 ;
                     DROP ;
                     SWAP ;
                     CDR ;
                     PUSH mutez 0 ;
                     DIG 2 ;
                     TRANSFER_TOKENS ;
                     SWAP ;
                     NIL operation ;
                     DIG 2 ;
                     CONS ;
                     PAIR }
                   { DIG 2 ;
                     DROP ;
                     DIG 2 ;
                     DROP ;
                     DIG 2 ;
                     DROP ;
                     SWAP ;
                     NIL operation ;
                     DIG 2 ;
                     PUSH mutez 0 ;
                     SELF_ADDRESS ;
                     TRANSFER_TOKENS ;
                     CONS ;
                     PAIR } }
               { IF_LEFT
                   { SWAP ;
                     DUP ;
                     DUG 2 ;
                     NIL operation ;
                     PAIR ;
                     SWAP ;
                     ITER { SWAP ;
                            DUP ;
                            CDR ;
                            { DIP 2 { DUP } ; DIG 3 } ;
                            CDR ;
                            ITER { SWAP ;
                                   { DIP 4 { DUP } ; DIG 5 } ;
                                   CDR ;
                                   CAR ;
                                   { DIP 2 { DUP } ; DIG 3 } ;
                                   CDR ;
                                   CAR ;
                                   PAIR ;
                                   { DIP 8 { DUP } ; DIG 9 } ;
                                   SWAP ;
                                   EXEC ;
                                   DROP ;
                                   SWAP ;
                                   DUP ;
                                   DUG 2 ;
                                   CDR ;
                                   CDR ;
                                   { DIP 2 { DUP } ; DIG 3 } ;
                                   CDR ;
                                   CAR ;
                                   { DIP 2 { DUP } ; DIG 3 } ;
                                   { DIP 6 { DUP } ; DIG 7 } ;
                                   CAR ;
                                   PAIR ;
                                   { DIP 9 { DUP } ; DIG 10 } ;
                                   SWAP ;
                                   EXEC ;
                                   { DIP 3 { DUP } ; DIG 4 } ;
                                   { DIP 5 { DUP } ; DIG 6 } ;
                                   CAR ;
                                   PAIR ;
                                   { DIP 10 { DUP } ; DIG 11 } ;
                                   SWAP ;
                                   EXEC ;
                                   SWAP ;
                                   DUP ;
                                   DUG 2 ;
                                   { DIP 6 { DUP } ; DIG 7 } ;
                                   CDR ;
                                   CAR ;
                                   PAIR ;
                                   { DIP 10 { DUP } ; DIG 11 } ;
                                   SWAP ;
                                   EXEC ;
                                   { DIP 8 { DUP } ; DIG 9 } ;
                                   CAR ;
                                   SWAP ;
                                   DUP ;
                                   DUG 2 ;
                                   SENDER ;
                                   PUSH bool True ;
                                   DIG 2 ;
                                   CDR ;
                                   DIG 2 ;
                                   MEM ;
                                   COMPARE ;
                                   EQ ;
                                   SWAP ;
                                   SENDER ;
                                   COMPARE ;
                                   EQ ;
                                   OR ;
                                   IF {} { PUSH string "FA2_NOT_OPERATOR" ; FAILWITH } ;
                                   SWAP ;
                                   DUP ;
                                   DUG 2 ;
                                   { DIP 7 { DUP } ; DIG 8 } ;
                                   CDR ;
                                   CAR ;
                                   PAIR ;
                                   { DIP 11 { DUP } ; DIG 12 } ;
                                   SWAP ;
                                   EXEC ;
                                   { DIP 5 { DUP } ; DIG 6 } ;
                                   { DIP 2 { DUP } ; DIG 3 } ;
                                   CAR ;
                                   COMPARE ;
                                   LT ;
                                   IF { PUSH string "FA2_INSUFFICIENT_BALANCE" ; FAILWITH } {} ;
                                   { DIP 14 { DUP } ; DIG 15 } ;
                                   { DIP 5 { DUP } ; DIG 6 } ;
                                   COMPARE ;
                                   EQ ;
                                   IF { SWAP ;
                                        DUP ;
                                        DUG 2 ;
                                        CDR ;
                                        { DIP 6 { DUP } ; DIG 7 } ;
                                        DIG 3 ;
                                        CAR ;
                                        SUB ;
                                        ABS ;
                                        PAIR ;
                                        SWAP ;
                                        DUP ;
                                        DUG 2 ;
                                        CDR ;
                                        DIG 6 ;
                                        DIG 3 ;
                                        CAR ;
                                        ADD ;
                                        PAIR ;
                                        DIG 2 ;
                                        SWAP ;
                                        SOME ;
                                        { DIP 4 { DUP } ; DIG 5 } ;
                                        UPDATE ;
                                        DUG 2 ;
                                        SOME ;
                                        DIG 3 ;
                                        UPDATE ;
                                        PAIR }
                                      { DIG 5 ;
                                        DROP ;
                                        DIG 2 ;
                                        SWAP ;
                                        CDR ;
                                        PUSH nat 1 ;
                                        PAIR ;
                                        SOME ;
                                        { DIP 4 { DUP } ; DIG 5 } ;
                                        UPDATE ;
                                        DUG 2 ;
                                        CDR ;
                                        PUSH nat 0 ;
                                        PAIR ;
                                        SOME ;
                                        DIG 3 ;
                                        UPDATE ;
                                        PAIR } ;
                                   SWAP ;
                                   DUP ;
                                   DUG 2 ;
                                   CDR ;
                                   { DIP 2 { DUP } ; DIG 3 } ;
                                   CAR ;
                                   CDR ;
                                   DIG 3 ;
                                   CAR ;
                                   CAR ;
                                   { DIP 3 { DUP } ; DIG 4 } ;
                                   CAR ;
                                   SOME ;
                                   { DIP 7 { DUP } ; DIG 8 } ;
                                   CAR ;
                                   UPDATE ;
                                   DIG 3 ;
                                   CDR ;
                                   SOME ;
                                   DIG 4 ;
                                   CAR ;
                                   UPDATE ;
                                   PAIR ;
                                   PAIR } ;
                            DIG 2 ;
                            DROP ;
                            SWAP ;
                            CAR ;
                            NIL operation ;
                            ITER { CONS } ;
                            PAIR } ;
                     SWAP ;
                     DROP ;
                     SWAP ;
                     DROP ;
                     SWAP ;
                     DROP ;
                     SWAP ;
                     DROP ;
                     SWAP ;
                     DROP }
                   { DIG 5 ;
                     DROP ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     SENDER ;
                     PAIR ;
                     DIG 4 ;
                     SWAP ;
                     EXEC ;
                     SWAP ;
                     ITER { IF_LEFT
                              { { DIP 2 { DUP } ; DIG 3 } ;
                                CDR ;
                                CAR ;
                                DUG 2 ;
                                SENDER ;
                                SWAP ;
                                DUP ;
                                DUG 2 ;
                                CAR ;
                                COMPARE ;
                                NEQ ;
                                IF { PUSH string "FA2_NOT_OWNER" ; FAILWITH } {} ;
                                DUP ;
                                CDR ;
                                CDR ;
                                DIG 3 ;
                                SWAP ;
                                DUP ;
                                DUG 2 ;
                                PAIR ;
                                { DIP 6 { DUP } ; DIG 7 } ;
                                SWAP ;
                                EXEC ;
                                DROP ;
                                SWAP ;
                                CDR ;
                                CAR ;
                                { DIP 2 { DUP } ; DIG 3 } ;
                                { DIP 2 { DUP } ; DIG 3 } ;
                                PAIR ;
                                { DIP 5 { DUP } ; DIG 6 } ;
                                SWAP ;
                                EXEC ;
                                DUP ;
                                CDR ;
                                { DIP 2 { DUP } ; DIG 3 } ;
                                MEM ;
                                IF { PUSH string "FA2_OPERATOR_EXIST" ; FAILWITH } {} ;
                                DIG 3 ;
                                SWAP ;
                                DUP ;
                                DUG 2 ;
                                CDR ;
                                DIG 3 ;
                                PUSH bool True ;
                                SWAP ;
                                UPDATE ;
                                DIG 2 ;
                                CAR ;
                                PAIR ;
                                SOME ;
                                DIG 2 ;
                                UPDATE }
                              { { DIP 2 { DUP } ; DIG 3 } ;
                                CDR ;
                                CAR ;
                                DUG 2 ;
                                SENDER ;
                                SWAP ;
                                DUP ;
                                DUG 2 ;
                                CAR ;
                                COMPARE ;
                                NEQ ;
                                IF { PUSH string "FA2_NOT_OWNER" ; FAILWITH } {} ;
                                DUP ;
                                CDR ;
                                CDR ;
                                DIG 3 ;
                                SWAP ;
                                DUP ;
                                DUG 2 ;
                                PAIR ;
                                { DIP 6 { DUP } ; DIG 7 } ;
                                SWAP ;
                                EXEC ;
                                DROP ;
                                SWAP ;
                                CDR ;
                                CAR ;
                                { DIP 2 { DUP } ; DIG 3 } ;
                                { DIP 2 { DUP } ; DIG 3 } ;
                                PAIR ;
                                { DIP 5 { DUP } ; DIG 6 } ;
                                SWAP ;
                                EXEC ;
                                PUSH bool True ;
                                SWAP ;
                                DUP ;
                                DUG 2 ;
                                CDR ;
                                { DIP 3 { DUP } ; DIG 4 } ;
                                MEM ;
                                COMPARE ;
                                NEQ ;
                                IF { PUSH string "FA2_OPERATOR_NOT_EXIST" ; FAILWITH } {} ;
                                DIG 3 ;
                                SWAP ;
                                DUP ;
                                DUG 2 ;
                                CDR ;
                                DIG 3 ;
                                PUSH bool False ;
                                SWAP ;
                                UPDATE ;
                                DIG 2 ;
                                CAR ;
                                PAIR ;
                                SOME ;
                                DIG 2 ;
                                UPDATE } } ;
                     DIG 2 ;
                     DROP ;
                     DIG 2 ;
                     DROP ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     CDR ;
                     { DIP 2 { DUP } ; DIG 3 } ;
                     CAR ;
                     CDR ;
                     DIG 3 ;
                     CAR ;
                     CAR ;
                     DIG 3 ;
                     SOME ;
                     SENDER ;
                     UPDATE ;
                     PAIR ;
                     PAIR ;
                     NIL operation ;
                     PAIR } } } } }
