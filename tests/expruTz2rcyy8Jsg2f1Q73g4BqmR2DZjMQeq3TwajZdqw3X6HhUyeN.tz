{ storage
    (pair (address %admin)
          (pair (map %ads
                   nat
                   (pair (pair (nat %ad_id) (string %image))
                         (pair (string %link) (pair (bool %nsfw) (string %title)))))
                (map %grid (pair nat nat) bool))) ;
  parameter (pair (pair (nat %height) (nat %width)) (pair (nat %x) (nat %y))) ;
  code { UNPAIR ;
         PUSH mutez 0 ;
         PUSH mutez 1 ;
         PUSH nat 100 ;
         DIG 3 ;
         DUP ;
         CAR ;
         CAR ;
         SWAP ;
         DUP ;
         DUG 5 ;
         CAR ;
         CDR ;
         MUL ;
         MUL ;
         MUL ;
         COMPARE ;
         GT ;
         IF {}
            { PUSH string
                   "WrongCondition: sp.mutez((params.width * params.height) * 100) > sp.tez(0)" ;
              FAILWITH } ;
         PUSH mutez 1 ;
         PUSH nat 100 ;
         DIG 2 ;
         DUP ;
         CAR ;
         CAR ;
         SWAP ;
         DUP ;
         DUG 4 ;
         CAR ;
         CDR ;
         MUL ;
         MUL ;
         MUL ;
         AMOUNT ;
         COMPARE ;
         GE ;
         IF {}
            { PUSH string
                   "WrongCondition: sp.amount >= sp.mutez((params.width * params.height) * 100)" ;
              FAILWITH } ;
         DUP ;
         CAR ;
         CDR ;
         PUSH nat 0 ;
         DUP ;
         DUP 3 ;
         COMPARE ;
         GT ;
         LOOP { DUP 3 ;
                CAR ;
                CAR ;
                PUSH nat 0 ;
                DUP ;
                DUP 3 ;
                COMPARE ;
                GT ;
                LOOP { DUP 6 ;
                       GET 4 ;
                       SWAP ;
                       DUP ;
                       DUG 2 ;
                       DUP 7 ;
                       GET 4 ;
                       ADD ;
                       DUP 5 ;
                       DUP 8 ;
                       GET 3 ;
                       ADD ;
                       PAIR ;
                       MEM ;
                       IF { PUSH string "contains pixel that has been bought already" ; FAILWITH }
                          {} ;
                       DIG 5 ;
                       UNPAIR ;
                       SWAP ;
                       UNPAIR ;
                       SWAP ;
                       PUSH (option bool) (Some True) ;
                       DUP 5 ;
                       DUP 10 ;
                       GET 4 ;
                       ADD ;
                       DUP 8 ;
                       DUP 11 ;
                       GET 3 ;
                       ADD ;
                       PAIR ;
                       UPDATE ;
                       SWAP ;
                       PAIR ;
                       SWAP ;
                       PAIR ;
                       DUG 5 ;
                       PUSH nat 1 ;
                       ADD ;
                       DUP ;
                       DUP 3 ;
                       COMPARE ;
                       GT } ;
                DROP 2 ;
                PUSH nat 1 ;
                ADD ;
                DUP ;
                DUP 3 ;
                COMPARE ;
                GT } ;
         DROP 3 ;
         DUP ;
         UNPAIR ;
         SWAP ;
         UNPAIR ;
         PUSH (pair (string %link) (pair (bool %nsfw) (string %title))) (Pair "" (Pair False "")) ;
         PUSH string "" ;
         DUP 6 ;
         GET 3 ;
         SIZE ;
         PAIR %ad_id %image ;
         PAIR ;
         SOME ;
         DIG 4 ;
         GET 3 ;
         SIZE ;
         UPDATE ;
         PAIR ;
         SWAP ;
         PAIR ;
         NIL operation ;
         PAIR } }
