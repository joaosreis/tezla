{ parameter (or :_entries (unit %main) (map %debit address nat)) ;
  storage (pair :storage (map %accounts address nat) (key_hash %manager)) ;
  code { DUP ;
         DIP { CDR @storage_slash_1 } ;
         CAR @parameter_slash_2 ;
         DUP @parameter ;
         IF_LEFT
           { RENAME @__slash_17 ;
             { DIP { { DIP { DUP @storage } ; SWAP } } ; SWAP } ;
             DUP @storage ;
             CAR @accounts %accounts ;
             PUSH nat 1000 ;
             PUSH mutez 1000000 ;
             AMOUNT ;
             EDIV ;
             IF_NONE { PUSH string "division by 0 impossible" ; FAILWITH } { CAR } ;
             RENAME @credits ;
             MUL @new_credits ;
             { DIP { DUP @accounts } ; SWAP } ;
             SOURCE @source ;
             GET ;
             IF_NONE
               { { DIP { { DIP { DUP @storage } ; SWAP } } ; SWAP } ;
                 CDR %manager ;
                 { DIP { { DIP { DUP @accounts } ; SWAP } } ; SWAP } ;
                 { DIP { { DIP { DUP @new_credits } ; SWAP } } ; SWAP } ;
                 SENDER ;
                 DIP { SOME } ;
                 UPDATE ;
                 PAIR @storage %accounts %manager ;
                 NIL operation ;
                 PAIR }
               { { DIP { { DIP { { DIP { DUP @storage } ; SWAP } } ; SWAP } } ;
                   SWAP } ;
                 CDR %manager ;
                 { DIP { { DIP { { DIP { DUP @accounts } ; SWAP } } ; SWAP } } ;
                   SWAP } ;
                 { DIP { { DIP { { DIP { DUP @new_credits } ; SWAP } } ; SWAP } } ;
                   SWAP } ;
                 { DIP { { DIP { { DIP { DUP @x } ; SWAP } } ; SWAP } } ;
                   SWAP } ;
                 ADD ;
                 SENDER ;
                 DIP { SOME } ;
                 DIP { DIP { DIP { DIP { DROP } } } } ;
                 UPDATE ;
                 PAIR @storage %accounts %manager ;
                 NIL operation ;
                 PAIR } ;
             DIP { DROP ; DROP ; DROP ; DROP } }
           { RENAME @account_updates_slash_27 ;
             { DIP { { DIP { DUP @storage } ; SWAP } } ; SWAP } ;
             { DIP { DUP @account_updates } ; SWAP } ;
             ITER { RENAME @_fold_arg_slash_29 ;
                    DIP { DUP } ;
                    PAIR ;
                    DUP ;
                    DUP @arg ;
                    DUP ;
                    CDR @storage ;
                    DUP @storage ;
                    CAR @accounts %accounts ;
                    { DIP { { DIP { DUP } ; SWAP } } ; SWAP } ;
                    CAR @account ;
                    DUP ;
                    CAR @account_address ;
                    { DIP { { DIP { DUP @accounts } ; SWAP } } ; SWAP } ;
                    { DIP { DUP @account_address } ; SWAP } ;
                    GET ;
                    IF_NONE
                      { PUSH string "Account provided does not exist." ; FAILWITH }
                      { { DIP { { DIP { { DIP { { DIP { DUP @storage } ; SWAP } } ; SWAP } } ;
                                  SWAP } } ;
                          SWAP } ;
                        CDR %manager ;
                        { DIP { { DIP { { DIP { { DIP { DUP @accounts } ; SWAP } } ; SWAP } } ;
                                  SWAP } } ;
                          SWAP } ;
                        { DIP { { DIP { { DIP { { DIP { DUP } ; SWAP } } ; SWAP } } ; SWAP } } ;
                          SWAP } ;
                        CDR @debit_credits ;
                        { DIP { { DIP { { DIP { DUP @x } ; SWAP } } ; SWAP } } ;
                          SWAP } ;
                        SUB ;
                        DUP ;
                        ABS ;
                        SWAP ;
                        GE ;
                        IF {} { PUSH string "Credits should not be negative" ; FAILWITH } ;
                        RENAME @new_account_balance ;
                        { DIP { { DIP { { DIP { { DIP { DUP @account_address } ; SWAP } } ; SWAP } } ;
                                  SWAP } } ;
                          SWAP } ;
                        DIP { SOME } ;
                        DIP { DIP { DIP { DIP { DROP } } } } ;
                        UPDATE ;
                        PAIR @storage %accounts %manager } ;
                    DIP { DROP ; DROP ; DROP ; DROP ; DROP ; DROP ; DROP ; DROP } } ;
             DIP { DROP } ;
             RENAME @new_storage ;
             NIL operation ;
             PAIR } ;
         DIP { DROP ; DROP } } }
