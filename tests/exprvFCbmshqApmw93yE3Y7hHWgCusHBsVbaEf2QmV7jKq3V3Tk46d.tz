{ storage
    (pair (pair (pair (big_map %ContractMap address address)
                      (big_map %Indexer address (set address)))
                (pair (nat %SupplyCeiling) (nat %WithReward)))
          (pair (pair (nat %WithoutReward) (address %admin))
                (pair (address %contract) (pair (bool %paused) (nat %totalSupply))))) ;
  parameter
    (or (or (or (nat %AdminTransfer)
                (or (unit %ChangeState) (pair %GetInterestRate (address %owner) (bool %type))))
            (or (address %LiquidateVault)
                (or (pair %ModifyInterestRate (nat %one) (nat %two)) (unit %OpenVault))))
        (or (or (address %SecuritiesExercise)
                (or (pair %SecuritiesPurchase
                       (pair (nat %duration) (nat %order))
                       (pair (address %spender) (pair (nat %token) (nat %xtz))))
                    (nat %UpdateCeiling)))
            (or (address %UpdateLiquidateOwner)
                (or (pair %burn (address %address) (pair (address %owner) (nat %value)))
                    (pair %mint (nat %amount) (pair (address %owner) (address %vault))))))) ;
  code { UNPAIR ;
         IF_LEFT
           { IF_LEFT
               { IF_LEFT
                   { SWAP ;
                     DUP ;
                     DUG 2 ;
                     GET 3 ;
                     CDR ;
                     SENDER ;
                     COMPARE ;
                     EQ ;
                     IF {} { PUSH string "User is not authorized to withdraw funds" ; FAILWITH } ;
                     NIL operation ;
                     PUSH address "KT1Cxrhwn6TD2pxvZrn2HfHA1dhkWoQeKrRV" ;
                     CONTRACT %transfer (pair (address %from_) (pair (address %to_) (nat %value))) ;
                     IF_NONE
                       { PUSH string " call to transfer interest + penality from factory contract failed" ;
                         FAILWITH }
                       {} ;
                     PUSH mutez 0 ;
                     DIG 3 ;
                     DUP 5 ;
                     GET 3 ;
                     CDR ;
                     PAIR %to_ %value ;
                     SELF_ADDRESS ;
                     PAIR %from_ ;
                     TRANSFER_TOKENS ;
                     CONS }
                   { IF_LEFT
                       { DROP ;
                         DUP ;
                         GET 3 ;
                         CDR ;
                         SENDER ;
                         COMPARE ;
                         EQ ;
                         IF {}
                            { PUSH string "User is not authorized to change state of factory contract" ;
                              FAILWITH } ;
                         DUP ;
                         UNPAIR ;
                         SWAP ;
                         UNPAIR ;
                         SWAP ;
                         UNPAIR ;
                         SWAP ;
                         CDR ;
                         DIG 4 ;
                         GET 7 ;
                         NOT ;
                         PAIR ;
                         SWAP ;
                         PAIR ;
                         SWAP ;
                         PAIR ;
                         SWAP ;
                         PAIR ;
                         NIL operation }
                       { SWAP ;
                         DUP ;
                         DUG 2 ;
                         CAR ;
                         CAR ;
                         CDR ;
                         SWAP ;
                         CAR ;
                         GET ;
                         IF_NONE { PUSH int 494 ; FAILWITH } {} ;
                         SENDER ;
                         MEM ;
                         IF {} { PUSH string "Vault and Owner details do not match" ; FAILWITH } ;
                         NIL operation ;
                         SENDER ;
                         CONTRACT %UpdateInterestRate nat ;
                         IF_NONE
                           { PUSH string " call to update global interest rate for vaults failed" ;
                             FAILWITH }
                           {} ;
                         PUSH mutez 0 ;
                         DUP 4 ;
                         GET 3 ;
                         CAR ;
                         TRANSFER_TOKENS ;
                         CONS } } }
               { IF_LEFT
                   { SWAP ;
                     DUP ;
                     DUG 2 ;
                     CAR ;
                     CAR ;
                     CAR ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     MEM ;
                     IF {}
                        { PUSH string "Vault address is not registed with the factory contract" ;
                          FAILWITH } ;
                     NIL operation ;
                     PUSH address "KT1McGXves4Ba5n4T331r8xnnNAnQvSMQDCq" ;
                     CONTRACT %LiquidateVault (pair (address %address) (address %vault)) ;
                     IF_NONE
                       { PUSH string "call to oracle to get latest parameters failed" ; FAILWITH }
                       {} ;
                     PUSH mutez 0 ;
                     DIG 3 ;
                     SENDER ;
                     PAIR %address %vault ;
                     TRANSFER_TOKENS ;
                     CONS }
                   { IF_LEFT
                       { SWAP ;
                         DUP ;
                         DUG 2 ;
                         GET 3 ;
                         CDR ;
                         SENDER ;
                         COMPARE ;
                         EQ ;
                         IF {}
                            { PUSH string "User is not authorized to Update Interest Rate" ; FAILWITH } ;
                         SWAP ;
                         UNPAIR ;
                         UNPAIR ;
                         SWAP ;
                         CAR ;
                         DUP 4 ;
                         CAR ;
                         SWAP ;
                         PAIR ;
                         SWAP ;
                         PAIR ;
                         SWAP ;
                         UNPAIR ;
                         CDR ;
                         DIG 3 ;
                         CDR ;
                         PAIR ;
                         PAIR ;
                         SWAP ;
                         PAIR ;
                         NIL operation }
                       { DROP ;
                         DUP ;
                         GET 7 ;
                         IF { PUSH string "Factory Contract is not deploying new vaults" ; FAILWITH }
                            {} ;
                         PUSH nat 0 ;
                         SELF_ADDRESS ;
                         PAIR %validator %xtz ;
                         PUSH nat 0 ;
                         PAIR %token ;
                         SENDER ;
                         SENDER ;
                         PAIR %owner %securityDelegator ;
                         DUP 3 ;
                         CAR ;
                         GET 4 ;
                         PAIR %interestRate ;
                         PAIR ;
                         PUSH nat 0 ;
                         NOW ;
                         PAIR %duration %interest ;
                         PUSH bool True ;
                         PAIR %Reward ;
                         PUSH bool False ;
                         NOW ;
                         PAIR %Insurance %Liquidated ;
                         PUSH bool True ;
                         PAIR %Closed ;
                         PAIR ;
                         PAIR ;
                         PUSH mutez 0 ;
                         PUSH (option key_hash) (Some "tz1aCnK45NP7CG31WMkUTP3d3V486mXwzZZt") ;
                         CREATE_CONTRACT
                           { parameter
                               (or (or (or (unit %DelayedReward) (or (unit %ExerciseSecurity) (nat %IncreaseCollateral)))
                                       (or (or (nat %IncreaseLoan) (pair %InterestAccured unit (contract nat)))
                                           (or (pair %OpenLoan (nat %amount) (pair (nat %loan) (nat %type)))
                                               (pair %OracleLiquidate
                                                  (pair (address %address) (nat %penality))
                                                  (pair (nat %price) (pair (nat %ratio) (nat %stabilityFees)))))))
                                   (or (or (or (pair %PurchaseSecurity
                                                  (nat %duration)
                                                  (pair (nat %order) (address %securityDelegator)))
                                               (pair %Repay (nat %Operation) (nat %amount)))
                                           (or (unit %SwitchInterestRate) (nat %TransferToken)))
                                       (or (or (nat %UpdateInterestRate) (nat %WithdrawCollateral))
                                           (or (unit %default) (option %delegate key_hash))))) ;
                             storage
                               (pair (pair (pair (bool %Closed) (pair (timestamp %Insurance) (bool %Liquidated)))
                                           (pair (bool %Reward) (pair (timestamp %duration) (nat %interest))))
                                     (pair (pair (nat %interestRate) (pair (address %owner) (address %securityDelegator)))
                                           (pair (nat %token) (pair (address %validator) (nat %xtz))))) ;
                             code { UNPAIR ;
                                    IF_LEFT
                                      { IF_LEFT
                                          { IF_LEFT
                                              { DROP ;
                                                DUP ;
                                                GET 3 ;
                                                GET 3 ;
                                                SENDER ;
                                                COMPARE ;
                                                EQ ;
                                                IF {}
                                                   { PUSH string "Sender is not Authorized to recive baking rewards" ; FAILWITH } ;
                                                DUP ;
                                                CAR ;
                                                CAR ;
                                                CAR ;
                                                IF {} { PUSH string "Vault is not Closed" ; FAILWITH } ;
                                                DUP ;
                                                GET 8 ;
                                                PUSH nat 0 ;
                                                COMPARE ;
                                                LT ;
                                                IF { DUP ;
                                                     GET 3 ;
                                                     GET 3 ;
                                                     CONTRACT unit ;
                                                     IF_NONE { PUSH int 242 ; FAILWITH } {} ;
                                                     NIL operation ;
                                                     SWAP ;
                                                     BALANCE ;
                                                     UNIT ;
                                                     TRANSFER_TOKENS ;
                                                     CONS ;
                                                     SWAP ;
                                                     UNPAIR ;
                                                     SWAP ;
                                                     UNPAIR ;
                                                     SWAP ;
                                                     UNPAIR ;
                                                     SWAP ;
                                                     CAR ;
                                                     PUSH nat 0 ;
                                                     SWAP ;
                                                     PAIR ;
                                                     SWAP ;
                                                     PAIR ;
                                                     SWAP ;
                                                     PAIR ;
                                                     SWAP ;
                                                     PAIR ;
                                                     SWAP }
                                                   { NIL operation } ;
                                                SWAP ;
                                                DUP ;
                                                DUG 2 ;
                                                CAR ;
                                                CAR ;
                                                GET 4 ;
                                                IF { SWAP ;
                                                     UNPAIR ;
                                                     UNPAIR ;
                                                     UNPAIR ;
                                                     SWAP ;
                                                     CAR ;
                                                     PUSH bool False ;
                                                     SWAP ;
                                                     PAIR ;
                                                     SWAP ;
                                                     PAIR ;
                                                     PAIR ;
                                                     PAIR ;
                                                     DUP ;
                                                     DUG 2 ;
                                                     GET 7 ;
                                                     CONTRACT %UpdateLiquidateOwner address ;
                                                     IF_NONE { PUSH string " updating vault owner call failed" ; FAILWITH } {} ;
                                                     PUSH mutez 0 ;
                                                     DUP 4 ;
                                                     GET 3 ;
                                                     GET 3 ;
                                                     TRANSFER_TOKENS ;
                                                     CONS }
                                                   {} }
                                              { IF_LEFT
                                                  { DROP ;
                                                    DUP ;
                                                    CAR ;
                                                    CAR ;
                                                    GET 3 ;
                                                    NOW ;
                                                    SWAP ;
                                                    COMPARE ;
                                                    GE ;
                                                    IF {} { PUSH string "PUT Options have already expired" ; FAILWITH } ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CAR ;
                                                    PUSH mutez 1 ;
                                                    BALANCE ;
                                                    EDIV ;
                                                    IF_NONE
                                                      { PUSH string "unable to convert balance to nat value" ; FAILWITH }
                                                      {} ;
                                                    CAR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    DUP ;
                                                    GET 3 ;
                                                    GET 3 ;
                                                    SENDER ;
                                                    COMPARE ;
                                                    EQ ;
                                                    IF { PUSH bool True } { DUP ; GET 3 ; GET 4 ; SENDER ; COMPARE ; EQ } ;
                                                    IF { UNPAIR ;
                                                         UNPAIR ;
                                                         UNPAIR ;
                                                         SWAP ;
                                                         CDR ;
                                                         NOW ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         PAIR ;
                                                         PAIR ;
                                                         DUP ;
                                                         GET 7 ;
                                                         CONTRACT %SecuritiesExercise address ;
                                                         IF_NONE
                                                           { PUSH string "call to exercise security to vault factory contract failed" ;
                                                             FAILWITH }
                                                           {} ;
                                                         NIL operation ;
                                                         SWAP ;
                                                         PUSH mutez 0 ;
                                                         DUP 4 ;
                                                         GET 3 ;
                                                         GET 3 ;
                                                         TRANSFER_TOKENS ;
                                                         CONS }
                                                       { NIL operation } }
                                                  { SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    CAR ;
                                                    CAR ;
                                                    CAR ;
                                                    IF { PUSH string "Loan has not been opened yet by the vault." ; FAILWITH }
                                                       {} ;
                                                    AMOUNT ;
                                                    PUSH mutez 1 ;
                                                    DIG 2 ;
                                                    MUL ;
                                                    COMPARE ;
                                                    EQ ;
                                                    IF {}
                                                       { PUSH string "WrongCondition: sp.mutez(params.amount) == sp.amount" ;
                                                         FAILWITH } ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CAR ;
                                                    PUSH mutez 1 ;
                                                    BALANCE ;
                                                    EDIV ;
                                                    IF_NONE
                                                      { PUSH string "unable to convert balance to nat value" ; FAILWITH }
                                                      {} ;
                                                    CAR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    DUP ;
                                                    CAR ;
                                                    GET 5 ;
                                                    NOW ;
                                                    SUB ;
                                                    ABS ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    UNPAIR ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CDR ;
                                                    PUSH nat 315360000000 ;
                                                    DUP 7 ;
                                                    GET 3 ;
                                                    CAR ;
                                                    DIG 6 ;
                                                    DIG 7 ;
                                                    GET 5 ;
                                                    MUL ;
                                                    MUL ;
                                                    EDIV ;
                                                    IF_NONE { PUSH int 41 ; FAILWITH } { CAR } ;
                                                    ADD ;
                                                    NOW ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    PAIR ;
                                                    NIL operation } } }
                                          { IF_LEFT
                                              { IF_LEFT
                                                  { SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    GET 3 ;
                                                    GET 3 ;
                                                    SENDER ;
                                                    COMPARE ;
                                                    EQ ;
                                                    IF {}
                                                       { PUSH string "Sender is not authorized to increase Loan Amount" ; FAILWITH } ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    CAR ;
                                                    CAR ;
                                                    CAR ;
                                                    IF { PUSH string "Closed Vault cannot mint DAL tokens" ; FAILWITH } {} ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    CAR ;
                                                    CAR ;
                                                    GET 3 ;
                                                    NOW ;
                                                    COMPARE ;
                                                    GT ;
                                                    IF {}
                                                       { PUSH string "Insured Vaults cannot Mint more DAL tokens" ; FAILWITH } ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CAR ;
                                                    PUSH mutez 1 ;
                                                    BALANCE ;
                                                    EDIV ;
                                                    IF_NONE
                                                      { PUSH string "unable to convert balance to nat value" ; FAILWITH }
                                                      {} ;
                                                    CAR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    CAR ;
                                                    GET 5 ;
                                                    NOW ;
                                                    SUB ;
                                                    ABS ;
                                                    DUP 3 ;
                                                    UNPAIR ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CDR ;
                                                    PUSH nat 315360000000 ;
                                                    DUP 8 ;
                                                    GET 3 ;
                                                    CAR ;
                                                    DIG 6 ;
                                                    DIG 8 ;
                                                    GET 5 ;
                                                    MUL ;
                                                    MUL ;
                                                    EDIV ;
                                                    IF_NONE { PUSH int 120 ; FAILWITH } { CAR } ;
                                                    ADD ;
                                                    NOW ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    PAIR ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    GET 5 ;
                                                    DIG 2 ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    DUP 6 ;
                                                    ADD ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    DUG 2 ;
                                                    NIL operation ;
                                                    PUSH address "KT1McGXves4Ba5n4T331r8xnnNAnQvSMQDCq" ;
                                                    CONTRACT %MintToken
                                                      (pair (pair (nat %collateral) (nat %loan))
                                                            (pair (address %owner) (pair (nat %token) (address %validator)))) ;
                                                    IF_NONE
                                                      { PUSH string "call to oracle to mint stablecoins failed" ; FAILWITH }
                                                      {} ;
                                                    PUSH mutez 0 ;
                                                    DIG 5 ;
                                                    DUP ;
                                                    GET 7 ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 7 ;
                                                    CAR ;
                                                    GET 6 ;
                                                    DIG 5 ;
                                                    ADD ;
                                                    PAIR %token %validator ;
                                                    DUP 6 ;
                                                    GET 3 ;
                                                    GET 3 ;
                                                    PAIR %owner ;
                                                    DIG 4 ;
                                                    DUP 6 ;
                                                    GET 8 ;
                                                    PAIR %collateral %loan ;
                                                    PAIR ;
                                                    TRANSFER_TOKENS ;
                                                    CONS }
                                                  { PUSH nat 0 ;
                                                    DUP 3 ;
                                                    CAR ;
                                                    CAR ;
                                                    CAR ;
                                                    IF {}
                                                       { DROP ;
                                                         SWAP ;
                                                         DUP ;
                                                         DUG 2 ;
                                                         CAR ;
                                                         GET 5 ;
                                                         NOW ;
                                                         SUB ;
                                                         ABS ;
                                                         PUSH nat 31536000000000 ;
                                                         DUP 4 ;
                                                         GET 3 ;
                                                         CAR ;
                                                         DIG 2 ;
                                                         DUP 5 ;
                                                         GET 5 ;
                                                         MUL ;
                                                         MUL ;
                                                         EDIV ;
                                                         IF_NONE { PUSH int 355 ; FAILWITH } { CAR } ;
                                                         DUP 3 ;
                                                         CAR ;
                                                         GET 6 ;
                                                         ADD } ;
                                                    NIL operation ;
                                                    DIG 2 ;
                                                    CDR ;
                                                    PUSH mutez 0 ;
                                                    DIG 3 ;
                                                    TRANSFER_TOKENS ;
                                                    CONS } }
                                              { IF_LEFT
                                                  { SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    GET 3 ;
                                                    GET 3 ;
                                                    SENDER ;
                                                    COMPARE ;
                                                    EQ ;
                                                    IF {} { PUSH string "Sender is not the owner of the vault" ; FAILWITH } ;
                                                    AMOUNT ;
                                                    PUSH mutez 1 ;
                                                    DUP 3 ;
                                                    CAR ;
                                                    MUL ;
                                                    COMPARE ;
                                                    EQ ;
                                                    IF {} { PUSH string "params.amount and xtz sent are not equal" ; FAILWITH } ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    CAR ;
                                                    CAR ;
                                                    CAR ;
                                                    IF {} { PUSH string " Loan is already Opened" ; FAILWITH } ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    CAR ;
                                                    CAR ;
                                                    GET 4 ;
                                                    IF { PUSH string " Vault is already liquidated" ; FAILWITH } {} ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CAR ;
                                                    PUSH mutez 1 ;
                                                    BALANCE ;
                                                    EDIV ;
                                                    IF_NONE
                                                      { PUSH string "unable to convert balance to nat value" ; FAILWITH }
                                                      {} ;
                                                    CAR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    DUP 5 ;
                                                    GET 3 ;
                                                    ADD ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CDR ;
                                                    NOW ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    CDR ;
                                                    PUSH bool False ;
                                                    PAIR ;
                                                    PAIR ;
                                                    PAIR ;
                                                    SWAP ;
                                                    DUP ;
                                                    GET 4 ;
                                                    PUSH nat 1 ;
                                                    COMPARE ;
                                                    EQ ;
                                                    IF { SWAP ;
                                                         UNPAIR ;
                                                         UNPAIR ;
                                                         SWAP ;
                                                         CDR ;
                                                         PUSH bool False ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         PAIR ;
                                                         SWAP }
                                                       { SWAP ;
                                                         UNPAIR ;
                                                         UNPAIR ;
                                                         SWAP ;
                                                         CDR ;
                                                         PUSH bool True ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         PAIR ;
                                                         SWAP } ;
                                                    NIL operation ;
                                                    PUSH address "KT1McGXves4Ba5n4T331r8xnnNAnQvSMQDCq" ;
                                                    CONTRACT %MintToken
                                                      (pair (pair (nat %collateral) (nat %loan))
                                                            (pair (address %owner) (pair (nat %token) (address %validator)))) ;
                                                    IF_NONE { PUSH string " oracle call to open loan failed" ; FAILWITH } {} ;
                                                    PUSH mutez 0 ;
                                                    DUP 5 ;
                                                    GET 7 ;
                                                    PUSH nat 0 ;
                                                    PAIR %token %validator ;
                                                    DUP 6 ;
                                                    GET 3 ;
                                                    GET 3 ;
                                                    PAIR %owner ;
                                                    DIG 4 ;
                                                    GET 3 ;
                                                    DUP 6 ;
                                                    GET 8 ;
                                                    PAIR %collateral %loan ;
                                                    PAIR ;
                                                    TRANSFER_TOKENS ;
                                                    CONS ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    GET 7 ;
                                                    CONTRACT %GetInterestRate (pair (address %owner) (bool %type)) ;
                                                    IF_NONE
                                                      { PUSH string "getting the global interest rate call failed" ; FAILWITH }
                                                      {} ;
                                                    PUSH mutez 0 ;
                                                    DIG 3 ;
                                                    DUP ;
                                                    CAR ;
                                                    GET 3 ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 5 ;
                                                    GET 3 ;
                                                    GET 3 ;
                                                    PAIR %owner %type ;
                                                    TRANSFER_TOKENS ;
                                                    CONS }
                                                  { PUSH address "KT1McGXves4Ba5n4T331r8xnnNAnQvSMQDCq" ;
                                                    SENDER ;
                                                    COMPARE ;
                                                    EQ ;
                                                    IF {} { PUSH string "Sender is not the Oracle Contract" ; FAILWITH } ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CAR ;
                                                    PUSH mutez 1 ;
                                                    BALANCE ;
                                                    EDIV ;
                                                    IF_NONE
                                                      { PUSH string "unable to convert balance to nat value" ; FAILWITH }
                                                      {} ;
                                                    CAR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    CAR ;
                                                    GET 5 ;
                                                    NOW ;
                                                    SUB ;
                                                    ABS ;
                                                    DUP 3 ;
                                                    UNPAIR ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CDR ;
                                                    PUSH nat 315360000000 ;
                                                    DUP 8 ;
                                                    GET 3 ;
                                                    CAR ;
                                                    DIG 6 ;
                                                    DIG 8 ;
                                                    GET 5 ;
                                                    MUL ;
                                                    MUL ;
                                                    EDIV ;
                                                    IF_NONE { PUSH int 204 ; FAILWITH } { CAR } ;
                                                    ADD ;
                                                    NOW ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    PAIR ;
                                                    SWAP ;
                                                    DUP ;
                                                    GET 5 ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    GET 6 ;
                                                    DIG 3 ;
                                                    DUP ;
                                                    CAR ;
                                                    GET 6 ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 5 ;
                                                    GET 5 ;
                                                    ADD ;
                                                    ADD ;
                                                    MUL ;
                                                    PUSH nat 1000000000000 ;
                                                    DUP 3 ;
                                                    GET 3 ;
                                                    DUP 5 ;
                                                    GET 8 ;
                                                    MUL ;
                                                    MUL ;
                                                    COMPARE ;
                                                    LT ;
                                                    IF { SWAP ; DUP ; DUG 2 ; CAR ; CAR ; GET 3 ; NOW ; COMPARE ; GT }
                                                       { PUSH bool False } ;
                                                    IF { DUP ;
                                                         CAR ;
                                                         CDR ;
                                                         DUP 3 ;
                                                         GET 5 ;
                                                         EDIV ;
                                                         IF_NONE { PUSH int 209 ; FAILWITH } { CAR } ;
                                                         NIL operation ;
                                                         PUSH address "KT1Cxrhwn6TD2pxvZrn2HfHA1dhkWoQeKrRV" ;
                                                         CONTRACT %transfer (pair (address %from_) (pair (address %to_) (nat %value))) ;
                                                         IF_NONE
                                                           { PUSH string " transferring DAL from Liquidator to vault failed" ; FAILWITH }
                                                           {} ;
                                                         PUSH mutez 0 ;
                                                         DUP 4 ;
                                                         DUP 6 ;
                                                         GET 6 ;
                                                         DIG 7 ;
                                                         DUP ;
                                                         CAR ;
                                                         GET 6 ;
                                                         SWAP ;
                                                         DUP ;
                                                         DUG 9 ;
                                                         GET 5 ;
                                                         ADD ;
                                                         ADD ;
                                                         ADD ;
                                                         SELF_ADDRESS ;
                                                         PAIR %to_ %value ;
                                                         DUP 6 ;
                                                         CAR ;
                                                         CAR ;
                                                         PAIR %from_ ;
                                                         TRANSFER_TOKENS ;
                                                         CONS ;
                                                         DUP 4 ;
                                                         GET 7 ;
                                                         CONTRACT %burn (pair (address %address) (pair (address %owner) (nat %value))) ;
                                                         IF_NONE
                                                           { PUSH string "burning call to vault factory contract failed" ; FAILWITH }
                                                           {} ;
                                                         PUSH mutez 0 ;
                                                         DIG 5 ;
                                                         DUP ;
                                                         GET 5 ;
                                                         SWAP ;
                                                         DUP ;
                                                         DUG 7 ;
                                                         GET 3 ;
                                                         GET 3 ;
                                                         PAIR %owner %value ;
                                                         SELF_ADDRESS ;
                                                         PAIR %address ;
                                                         TRANSFER_TOKENS ;
                                                         CONS ;
                                                         PUSH address "KT1Cxrhwn6TD2pxvZrn2HfHA1dhkWoQeKrRV" ;
                                                         CONTRACT %transfer (pair (address %from_) (pair (address %to_) (nat %value))) ;
                                                         IF_NONE
                                                           { PUSH string " transferring interest + penality to vault factory contract failed" ;
                                                             FAILWITH }
                                                           {} ;
                                                         PUSH mutez 0 ;
                                                         DIG 3 ;
                                                         DUP 5 ;
                                                         GET 6 ;
                                                         DUP 7 ;
                                                         CAR ;
                                                         GET 6 ;
                                                         ADD ;
                                                         ADD ;
                                                         DUP 6 ;
                                                         GET 7 ;
                                                         PAIR %to_ %value ;
                                                         SELF_ADDRESS ;
                                                         PAIR %from_ ;
                                                         TRANSFER_TOKENS ;
                                                         CONS ;
                                                         DIG 2 ;
                                                         UNPAIR ;
                                                         UNPAIR ;
                                                         CDR ;
                                                         PUSH bool True ;
                                                         SWAP ;
                                                         CAR ;
                                                         PUSH bool True ;
                                                         SWAP ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         PAIR ;
                                                         SWAP ;
                                                         UNPAIR ;
                                                         SWAP ;
                                                         GET 3 ;
                                                         PUSH nat 0 ;
                                                         SWAP ;
                                                         PAIR ;
                                                         PUSH nat 0 ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         SWAP ;
                                                         UNPAIR ;
                                                         SWAP ;
                                                         UNPAIR ;
                                                         SWAP ;
                                                         CAR ;
                                                         PUSH nat 0 ;
                                                         SWAP ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         SWAP ;
                                                         UNPAIR ;
                                                         UNPAIR ;
                                                         SWAP ;
                                                         CDR ;
                                                         DUP 6 ;
                                                         CAR ;
                                                         CAR ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         DUG 2 ;
                                                         SWAP ;
                                                         CAR ;
                                                         CAR ;
                                                         CONTRACT unit ;
                                                         IF_NONE { PUSH int 233 ; FAILWITH } {} ;
                                                         BALANCE ;
                                                         UNIT ;
                                                         TRANSFER_TOKENS ;
                                                         CONS }
                                                       { DROP ; NIL operation } } } } }
                                      { IF_LEFT
                                          { IF_LEFT
                                              { IF_LEFT
                                                  { SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    GET 3 ;
                                                    GET 3 ;
                                                    SENDER ;
                                                    COMPARE ;
                                                    EQ ;
                                                    IF {} { PUSH string "Sender is not the vault's owner" ; FAILWITH } ;
                                                    DUP ;
                                                    CAR ;
                                                    PUSH (set nat) { 1 ; 7 ; 14 ; 21 } ;
                                                    SWAP ;
                                                    MEM ;
                                                    IF {} { PUSH string "Invalid Duration for PUT Options contract" ; FAILWITH } ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    CAR ;
                                                    CAR ;
                                                    CAR ;
                                                    IF { PUSH string "Closed Vaults cannot Purchase Securities" ; FAILWITH } {} ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CAR ;
                                                    PUSH mutez 1 ;
                                                    BALANCE ;
                                                    EDIV ;
                                                    IF_NONE
                                                      { PUSH string "unable to convert balance to nat value" ; FAILWITH }
                                                      {} ;
                                                    CAR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CDR ;
                                                    NOW ;
                                                    PUSH int 60 ;
                                                    DUP ;
                                                    PUSH int 24 ;
                                                    DUP 9 ;
                                                    CAR ;
                                                    INT ;
                                                    MUL ;
                                                    MUL ;
                                                    MUL ;
                                                    ADD ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    PAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CAR ;
                                                    DUP 5 ;
                                                    GET 4 ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    CAR ;
                                                    GET 5 ;
                                                    NOW ;
                                                    SUB ;
                                                    ABS ;
                                                    DUP 3 ;
                                                    UNPAIR ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CDR ;
                                                    PUSH nat 315360000000 ;
                                                    DUP 8 ;
                                                    GET 3 ;
                                                    CAR ;
                                                    DIG 6 ;
                                                    DIG 8 ;
                                                    GET 5 ;
                                                    MUL ;
                                                    MUL ;
                                                    EDIV ;
                                                    IF_NONE { PUSH int 292 ; FAILWITH } { CAR } ;
                                                    ADD ;
                                                    NOW ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    PAIR ;
                                                    SWAP ;
                                                    NOW ;
                                                    NOW ;
                                                    PUSH int 60 ;
                                                    DUP ;
                                                    PUSH int 24 ;
                                                    DUP 6 ;
                                                    CAR ;
                                                    INT ;
                                                    MUL ;
                                                    MUL ;
                                                    MUL ;
                                                    ADD ;
                                                    SUB ;
                                                    ABS ;
                                                    DUP 3 ;
                                                    GET 3 ;
                                                    CAR ;
                                                    SWAP ;
                                                    DUP 4 ;
                                                    GET 5 ;
                                                    MUL ;
                                                    MUL ;
                                                    PUSH nat 315360000000 ;
                                                    SWAP ;
                                                    EDIV ;
                                                    IF_NONE { PUSH int 299 ; FAILWITH } { CAR } ;
                                                    NIL operation ;
                                                    DUP 4 ;
                                                    GET 7 ;
                                                    CONTRACT %SecuritiesPurchase
                                                      (pair (pair (nat %duration) (nat %order))
                                                            (pair (address %spender) (pair (nat %token) (nat %xtz)))) ;
                                                    IF_NONE
                                                      { PUSH string "call to purchase security to vault factory contract failed" ;
                                                        FAILWITH }
                                                      {} ;
                                                    PUSH mutez 0 ;
                                                    DUP 6 ;
                                                    GET 8 ;
                                                    DIG 4 ;
                                                    DIG 6 ;
                                                    DUP ;
                                                    CAR ;
                                                    GET 6 ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 8 ;
                                                    GET 5 ;
                                                    ADD ;
                                                    ADD ;
                                                    PAIR %token %xtz ;
                                                    DUP 6 ;
                                                    GET 3 ;
                                                    GET 3 ;
                                                    PAIR %spender ;
                                                    DIG 4 ;
                                                    DUP ;
                                                    GET 3 ;
                                                    SWAP ;
                                                    CAR ;
                                                    PAIR %duration %order ;
                                                    PAIR ;
                                                    TRANSFER_TOKENS ;
                                                    CONS }
                                                  { SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    CAR ;
                                                    CAR ;
                                                    CAR ;
                                                    IF { PUSH string "Loan has not been opened by the vault" ; FAILWITH } {} ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    CAR ;
                                                    GET 5 ;
                                                    NOW ;
                                                    SUB ;
                                                    ABS ;
                                                    DUP 3 ;
                                                    UNPAIR ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CDR ;
                                                    PUSH nat 315360000000 ;
                                                    DUP 8 ;
                                                    GET 3 ;
                                                    CAR ;
                                                    DUP 7 ;
                                                    DIG 9 ;
                                                    GET 5 ;
                                                    MUL ;
                                                    MUL ;
                                                    EDIV ;
                                                    IF_NONE { PUSH int 141 ; FAILWITH } { CAR } ;
                                                    ADD ;
                                                    NOW ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    PAIR ;
                                                    DUG 2 ;
                                                    PUSH nat 1 ;
                                                    DUP 3 ;
                                                    CAR ;
                                                    COMPARE ;
                                                    EQ ;
                                                    IF { DIG 2 ;
                                                         DUP ;
                                                         GET 5 ;
                                                         SWAP ;
                                                         DUP ;
                                                         DUG 4 ;
                                                         CAR ;
                                                         GET 6 ;
                                                         ADD ;
                                                         DUP 3 ;
                                                         CDR ;
                                                         COMPARE ;
                                                         GT ;
                                                         IF { DIG 2 ; DUP ; GET 5 ; SWAP ; DUP ; DUG 4 ; CAR ; GET 6 ; ADD }
                                                            { SWAP ; DUP ; DUG 2 ; CDR } ;
                                                         NIL operation ;
                                                         PUSH address "KT1Cxrhwn6TD2pxvZrn2HfHA1dhkWoQeKrRV" ;
                                                         CONTRACT %transfer (pair (address %from_) (pair (address %to_) (nat %value))) ;
                                                         IF_NONE
                                                           { PUSH string "transferring DAL from sender to vault failed" ; FAILWITH }
                                                           {} ;
                                                         PUSH mutez 0 ;
                                                         DUP 4 ;
                                                         SELF_ADDRESS ;
                                                         PAIR %to_ %value ;
                                                         SENDER ;
                                                         PAIR %from_ ;
                                                         TRANSFER_TOKENS ;
                                                         CONS }
                                                       { SWAP ; DUP ; DUG 2 ; CDR ; NIL operation } ;
                                                    PUSH nat 0 ;
                                                    DUP 6 ;
                                                    CAR ;
                                                    GET 6 ;
                                                    DUP 4 ;
                                                    COMPARE ;
                                                    GT ;
                                                    IF { DUP 6 ;
                                                         CAR ;
                                                         GET 6 ;
                                                         DUP 4 ;
                                                         SUB ;
                                                         ABS ;
                                                         DUP 7 ;
                                                         GET 5 ;
                                                         SWAP ;
                                                         DUP ;
                                                         DUG 2 ;
                                                         COMPARE ;
                                                         GE ;
                                                         IF { DROP 2 ;
                                                              SWAP ;
                                                              DROP ;
                                                              SWAP ;
                                                              DROP ;
                                                              SWAP ;
                                                              DROP ;
                                                              SWAP ;
                                                              DUP ;
                                                              DUG 2 ;
                                                              GET 5 ;
                                                              SWAP ;
                                                              DUP 3 ;
                                                              GET 3 ;
                                                              GET 3 ;
                                                              CONTRACT unit ;
                                                              IF_NONE { PUSH int 170 ; FAILWITH } {} ;
                                                              BALANCE ;
                                                              UNIT ;
                                                              TRANSFER_TOKENS ;
                                                              CONS ;
                                                              SWAP ;
                                                              DIG 2 ;
                                                              UNPAIR ;
                                                              UNPAIR ;
                                                              CDR ;
                                                              PUSH bool True ;
                                                              PAIR ;
                                                              PAIR ;
                                                              SWAP ;
                                                              UNPAIR ;
                                                              SWAP ;
                                                              GET 3 ;
                                                              PUSH nat 0 ;
                                                              SWAP ;
                                                              PAIR ;
                                                              PUSH nat 0 ;
                                                              PAIR ;
                                                              SWAP ;
                                                              PAIR ;
                                                              SWAP ;
                                                              PAIR ;
                                                              DUG 2 }
                                                            { SWAP ;
                                                              DROP ;
                                                              DIG 2 ;
                                                              DROP ;
                                                              DIG 2 ;
                                                              DROP ;
                                                              DIG 2 ;
                                                              DROP ;
                                                              DUP ;
                                                              DUP 4 ;
                                                              UNPAIR ;
                                                              SWAP ;
                                                              UNPAIR ;
                                                              SWAP ;
                                                              CDR ;
                                                              DIG 4 ;
                                                              DIG 6 ;
                                                              GET 5 ;
                                                              SUB ;
                                                              ABS ;
                                                              PAIR ;
                                                              SWAP ;
                                                              PAIR ;
                                                              SWAP ;
                                                              PAIR ;
                                                              DUG 2 } ;
                                                         DUP 3 ;
                                                         CAR ;
                                                         GET 6 ;
                                                         SWAP ;
                                                         DIG 3 ;
                                                         UNPAIR ;
                                                         UNPAIR ;
                                                         SWAP ;
                                                         UNPAIR ;
                                                         SWAP ;
                                                         CAR ;
                                                         PUSH nat 0 ;
                                                         SWAP ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         PAIR ;
                                                         DUG 3 ;
                                                         DIG 2 ;
                                                         DUP 4 ;
                                                         GET 7 ;
                                                         CONTRACT %burn (pair (address %address) (pair (address %owner) (nat %value))) ;
                                                         IF_NONE
                                                           { PUSH string "burning DAL to vault factory contract failed" ; FAILWITH }
                                                           {} ;
                                                         PUSH mutez 0 ;
                                                         DIG 3 ;
                                                         DUP 6 ;
                                                         GET 3 ;
                                                         GET 3 ;
                                                         PAIR %owner %value ;
                                                         SELF_ADDRESS ;
                                                         PAIR %address ;
                                                         TRANSFER_TOKENS ;
                                                         CONS ;
                                                         SWAP }
                                                       { DROP ;
                                                         DIG 2 ;
                                                         DROP ;
                                                         DIG 2 ;
                                                         DROP ;
                                                         SWAP ;
                                                         DUP ;
                                                         DUG 2 ;
                                                         DUP 4 ;
                                                         UNPAIR ;
                                                         UNPAIR ;
                                                         SWAP ;
                                                         UNPAIR ;
                                                         SWAP ;
                                                         CAR ;
                                                         DIG 6 ;
                                                         DIG 7 ;
                                                         CAR ;
                                                         GET 6 ;
                                                         SUB ;
                                                         ABS ;
                                                         SWAP ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         PAIR ;
                                                         DUG 2 } ;
                                                    SWAP ;
                                                    PUSH address "KT1Cxrhwn6TD2pxvZrn2HfHA1dhkWoQeKrRV" ;
                                                    CONTRACT %transfer (pair (address %from_) (pair (address %to_) (nat %value))) ;
                                                    IF_NONE
                                                      { PUSH string "transferring interest to vault factory contract failed" ;
                                                        FAILWITH }
                                                      {} ;
                                                    PUSH mutez 0 ;
                                                    DIG 3 ;
                                                    DUP 5 ;
                                                    GET 7 ;
                                                    PAIR %to_ %value ;
                                                    SELF_ADDRESS ;
                                                    PAIR %from_ ;
                                                    TRANSFER_TOKENS ;
                                                    CONS } }
                                              { IF_LEFT
                                                  { DROP ;
                                                    DUP ;
                                                    GET 3 ;
                                                    GET 3 ;
                                                    SENDER ;
                                                    COMPARE ;
                                                    EQ ;
                                                    IF {} { PUSH string "Sender is not the owner of the vault" ; FAILWITH } ;
                                                    DUP ;
                                                    CAR ;
                                                    CAR ;
                                                    CAR ;
                                                    IF { PUSH string " Loan is already Closed" ; FAILWITH } {} ;
                                                    DUP ;
                                                    CAR ;
                                                    CAR ;
                                                    GET 4 ;
                                                    IF { PUSH string " Vault is already liquidated" ; FAILWITH } {} ;
                                                    DUP ;
                                                    CAR ;
                                                    GET 5 ;
                                                    NOW ;
                                                    SUB ;
                                                    ABS ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    UNPAIR ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CDR ;
                                                    PUSH nat 315360000000 ;
                                                    DUP 7 ;
                                                    GET 3 ;
                                                    CAR ;
                                                    DIG 6 ;
                                                    DIG 7 ;
                                                    GET 5 ;
                                                    MUL ;
                                                    MUL ;
                                                    EDIV ;
                                                    IF_NONE { PUSH int 84 ; FAILWITH } { CAR } ;
                                                    ADD ;
                                                    NOW ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    PAIR ;
                                                    DUP ;
                                                    CAR ;
                                                    GET 3 ;
                                                    IF { UNPAIR ;
                                                         UNPAIR ;
                                                         SWAP ;
                                                         CDR ;
                                                         PUSH bool False ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         PAIR }
                                                       { UNPAIR ;
                                                         UNPAIR ;
                                                         SWAP ;
                                                         CDR ;
                                                         PUSH bool True ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         PAIR } ;
                                                    DUP ;
                                                    GET 7 ;
                                                    CONTRACT %GetInterestRate (pair (address %owner) (bool %type)) ;
                                                    IF_NONE
                                                      { PUSH string "getting the global interest rate call failed" ; FAILWITH }
                                                      {} ;
                                                    NIL operation ;
                                                    SWAP ;
                                                    PUSH mutez 0 ;
                                                    DIG 3 ;
                                                    DUP ;
                                                    CAR ;
                                                    GET 3 ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 5 ;
                                                    GET 3 ;
                                                    GET 3 ;
                                                    PAIR %owner %type ;
                                                    TRANSFER_TOKENS ;
                                                    CONS }
                                                  { SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    GET 3 ;
                                                    GET 3 ;
                                                    SENDER ;
                                                    COMPARE ;
                                                    EQ ;
                                                    IF {}
                                                       { PUSH string "Sender is not authorized to withdraw funds from the vault" ;
                                                         FAILWITH } ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    CAR ;
                                                    CAR ;
                                                    CAR ;
                                                    IF {} { PUSH string "WrongCondition: self.data.Closed" ; FAILWITH } ;
                                                    NIL operation ;
                                                    PUSH address "KT1Cxrhwn6TD2pxvZrn2HfHA1dhkWoQeKrRV" ;
                                                    CONTRACT %transfer (pair (address %from_) (pair (address %to_) (nat %value))) ;
                                                    IF_NONE
                                                      { PUSH string "transferring surplus DAL to owner failed" ; FAILWITH }
                                                      {} ;
                                                    PUSH mutez 0 ;
                                                    DIG 3 ;
                                                    DUP 5 ;
                                                    GET 3 ;
                                                    GET 3 ;
                                                    PAIR %to_ %value ;
                                                    SELF_ADDRESS ;
                                                    PAIR %from_ ;
                                                    TRANSFER_TOKENS ;
                                                    CONS } } }
                                          { IF_LEFT
                                              { IF_LEFT
                                                  { SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    GET 7 ;
                                                    SENDER ;
                                                    COMPARE ;
                                                    EQ ;
                                                    IF {}
                                                       { PUSH string "Sender is not authorized to update interest rate" ; FAILWITH } ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    CDR ;
                                                    DIG 3 ;
                                                    PAIR ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    NIL operation }
                                                  { SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CAR ;
                                                    PUSH mutez 1 ;
                                                    BALANCE ;
                                                    EDIV ;
                                                    IF_NONE
                                                      { PUSH string "unable to convert balance to nat value" ; FAILWITH }
                                                      {} ;
                                                    CAR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    GET 3 ;
                                                    GET 3 ;
                                                    SENDER ;
                                                    COMPARE ;
                                                    EQ ;
                                                    IF {} { PUSH string "Sender is not Vault Owner" ; FAILWITH } ;
                                                    DUP ;
                                                    DUP 3 ;
                                                    GET 8 ;
                                                    COMPARE ;
                                                    GT ;
                                                    IF {}
                                                       { PUSH string "Withdraw Amount is greater than Vault's balance" ; FAILWITH } ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    CAR ;
                                                    GET 5 ;
                                                    NOW ;
                                                    SUB ;
                                                    ABS ;
                                                    DUP 3 ;
                                                    UNPAIR ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CDR ;
                                                    PUSH nat 31536000000000 ;
                                                    DUP 8 ;
                                                    GET 3 ;
                                                    CAR ;
                                                    DIG 6 ;
                                                    DIG 8 ;
                                                    GET 5 ;
                                                    MUL ;
                                                    MUL ;
                                                    EDIV ;
                                                    IF_NONE { PUSH int 335 ; FAILWITH } { CAR } ;
                                                    ADD ;
                                                    NOW ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    PAIR ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    UNPAIR ;
                                                    SWAP ;
                                                    CAR ;
                                                    DUP 5 ;
                                                    DIG 6 ;
                                                    GET 8 ;
                                                    SUB ;
                                                    ABS ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    PAIR ;
                                                    SWAP ;
                                                    NIL operation ;
                                                    PUSH address "KT1McGXves4Ba5n4T331r8xnnNAnQvSMQDCq" ;
                                                    CONTRACT %WithdrawCollateral (pair (nat %collateral) (nat %token)) ;
                                                    IF_NONE
                                                      { PUSH string " call to oracle contract to check vault's collateral Ratio" ;
                                                        FAILWITH }
                                                      {} ;
                                                    PUSH mutez 0 ;
                                                    DIG 4 ;
                                                    DUP ;
                                                    CAR ;
                                                    GET 6 ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 6 ;
                                                    GET 5 ;
                                                    ADD ;
                                                    DUP 6 ;
                                                    GET 8 ;
                                                    PAIR %collateral %token ;
                                                    TRANSFER_TOKENS ;
                                                    CONS ;
                                                    DUP 3 ;
                                                    GET 3 ;
                                                    GET 3 ;
                                                    CONTRACT unit ;
                                                    IF_NONE { PUSH int 346 ; FAILWITH } {} ;
                                                    PUSH mutez 1 ;
                                                    DIG 3 ;
                                                    MUL ;
                                                    UNIT ;
                                                    TRANSFER_TOKENS ;
                                                    CONS } }
                                              { IF_LEFT
                                                  { DROP ;
                                                    PUSH mutez 0 ;
                                                    AMOUNT ;
                                                    COMPARE ;
                                                    GE ;
                                                    IF {} { PUSH string "WrongCondition: sp.amount >= sp.tez(0)" ; FAILWITH } ;
                                                    DUP ;
                                                    CAR ;
                                                    GET 3 ;
                                                    IF { UNPAIR ;
                                                         SWAP ;
                                                         UNPAIR ;
                                                         SWAP ;
                                                         UNPAIR ;
                                                         SWAP ;
                                                         CAR ;
                                                         PUSH mutez 1 ;
                                                         BALANCE ;
                                                         EDIV ;
                                                         IF_NONE
                                                           { PUSH string "unable to convert balance to nat value" ; FAILWITH }
                                                           {} ;
                                                         CAR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         SWAP ;
                                                         PAIR ;
                                                         NIL operation }
                                                       { PUSH mutez 1 ;
                                                         AMOUNT ;
                                                         EDIV ;
                                                         IF_NONE
                                                           { PUSH string "unable to convert balance to nat value" ; FAILWITH }
                                                           {} ;
                                                         CAR ;
                                                         NIL operation ;
                                                         PUSH address "KT1TmaYKaUrJrtwATcwyRUzfKrhwFm6TXBX6" ;
                                                         CONTRACT %mint (pair (address %address) (nat %value)) ;
                                                         IF_NONE { PUSH string "Reward Token could not be minted" ; FAILWITH } {} ;
                                                         PUSH mutez 1 ;
                                                         DUP 4 ;
                                                         MUL ;
                                                         DIG 3 ;
                                                         DUP 5 ;
                                                         GET 3 ;
                                                         GET 3 ;
                                                         PAIR %address %value ;
                                                         TRANSFER_TOKENS ;
                                                         CONS } }
                                                  { SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    GET 3 ;
                                                    GET 3 ;
                                                    SENDER ;
                                                    COMPARE ;
                                                    EQ ;
                                                    IF {}
                                                       { PUSH string "Sender is not authorized to change vault's baker" ; FAILWITH } ;
                                                    SWAP ;
                                                    DUP ;
                                                    DUG 2 ;
                                                    CAR ;
                                                    GET 3 ;
                                                    IF {}
                                                       { DUP ;
                                                         NONE key_hash ;
                                                         COMPARE ;
                                                         NEQ ;
                                                         IF {} { PUSH string "None Value cannot be assigned" ; FAILWITH } } ;
                                                    SET_DELEGATE ;
                                                    NIL operation ;
                                                    SWAP ;
                                                    CONS } } } } ;
                                    NIL operation ;
                                    SWAP ;
                                    ITER { CONS } ;
                                    PAIR } } ;
                         PAIR ;
                         DUP ;
                         CAR ;
                         NIL operation ;
                         SWAP ;
                         CONS ;
                         DIG 2 ;
                         UNPAIR ;
                         SWAP ;
                         UNPAIR ;
                         SWAP ;
                         CDR ;
                         DIG 4 ;
                         CDR ;
                         PAIR ;
                         SWAP ;
                         PAIR ;
                         SWAP ;
                         PAIR ;
                         DUP ;
                         DUG 2 ;
                         CAR ;
                         CAR ;
                         CDR ;
                         SENDER ;
                         MEM ;
                         IF {}
                            { SWAP ;
                              UNPAIR ;
                              UNPAIR ;
                              UNPAIR ;
                              SWAP ;
                              PUSH (option (set address)) (Some {}) ;
                              SENDER ;
                              UPDATE ;
                              SWAP ;
                              PAIR ;
                              PAIR ;
                              PAIR ;
                              SWAP } ;
                         SWAP ;
                         DUP ;
                         DUG 2 ;
                         UNPAIR ;
                         UNPAIR ;
                         UNPAIR ;
                         SENDER ;
                         SOME ;
                         DIG 6 ;
                         GET 5 ;
                         UPDATE ;
                         PAIR ;
                         PAIR ;
                         PAIR ;
                         DUP ;
                         DUG 2 ;
                         UNPAIR ;
                         UNPAIR ;
                         UNPAIR ;
                         SWAP ;
                         DUP ;
                         SENDER ;
                         DUP ;
                         DUG 2 ;
                         GET ;
                         IF_NONE { PUSH int 397 ; FAILWITH } {} ;
                         PUSH bool True ;
                         DIG 8 ;
                         GET 5 ;
                         UPDATE ;
                         SOME ;
                         SWAP ;
                         UPDATE ;
                         SWAP ;
                         PAIR ;
                         PAIR ;
                         PAIR ;
                         SWAP } } } }
           { IF_LEFT
               { IF_LEFT
                   { SWAP ;
                     DUP ;
                     DUG 2 ;
                     CAR ;
                     CAR ;
                     CDR ;
                     SWAP ;
                     GET ;
                     IF_NONE { PUSH int 463 ; FAILWITH } {} ;
                     SENDER ;
                     MEM ;
                     IF {} { PUSH string "Vault and Owner details do not match" ; FAILWITH } ;
                     NIL operation ;
                     PUSH address "KT1McGXves4Ba5n4T331r8xnnNAnQvSMQDCq" ;
                     CONTRACT %SecuritiesExercise address ;
                     IF_NONE
                       { PUSH string " call to exercise put options to oracle failed" ; FAILWITH }
                       {} ;
                     PUSH mutez 0 ;
                     SENDER ;
                     TRANSFER_TOKENS ;
                     CONS }
                   { IF_LEFT
                       { SWAP ;
                         DUP ;
                         DUG 2 ;
                         CAR ;
                         CAR ;
                         CDR ;
                         SWAP ;
                         DUP ;
                         DUG 2 ;
                         GET 3 ;
                         GET ;
                         IF_NONE { PUSH int 449 ; FAILWITH } {} ;
                         SENDER ;
                         MEM ;
                         IF {} { PUSH string "Vault and spender details do not match" ; FAILWITH } ;
                         NIL operation ;
                         PUSH address "KT1McGXves4Ba5n4T331r8xnnNAnQvSMQDCq" ;
                         CONTRACT %SecuritiesPurchase
                           (pair (pair (nat %duration) (pair (nat %order) (address %spender)))
                                 (pair (nat %token) (pair (address %vault) (nat %xtz)))) ;
                         IF_NONE
                           { PUSH string " call to purchase put options to oracle failed" ; FAILWITH }
                           {} ;
                         PUSH mutez 0 ;
                         DUP 4 ;
                         GET 6 ;
                         SENDER ;
                         PAIR %vault %xtz ;
                         DUP 5 ;
                         GET 5 ;
                         PAIR %token ;
                         DIG 4 ;
                         DUP ;
                         GET 3 ;
                         SWAP ;
                         DUP ;
                         DUG 6 ;
                         CAR ;
                         CDR ;
                         PAIR %order %spender ;
                         DIG 5 ;
                         CAR ;
                         CAR ;
                         PAIR %duration ;
                         PAIR ;
                         TRANSFER_TOKENS ;
                         CONS }
                       { SWAP ;
                         DUP ;
                         DUG 2 ;
                         GET 3 ;
                         CDR ;
                         SENDER ;
                         COMPARE ;
                         EQ ;
                         IF {}
                            { PUSH string "Sender isn't authorized to update Ceiling function" ;
                              FAILWITH } ;
                         SWAP ;
                         UNPAIR ;
                         UNPAIR ;
                         SWAP ;
                         CDR ;
                         DIG 3 ;
                         PAIR ;
                         SWAP ;
                         PAIR ;
                         PAIR ;
                         NIL operation } } }
               { IF_LEFT
                   { SWAP ;
                     DUP ;
                     DUG 2 ;
                     CAR ;
                     CAR ;
                     CAR ;
                     SENDER ;
                     MEM ;
                     IF {}
                        { PUSH string "Vault is not registered with the factory contract" ; FAILWITH } ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     CAR ;
                     CAR ;
                     CAR ;
                     SENDER ;
                     GET ;
                     IF_NONE { PUSH int 544 ; FAILWITH } {} ;
                     DIG 2 ;
                     UNPAIR ;
                     UNPAIR ;
                     UNPAIR ;
                     SWAP ;
                     DUP ;
                     DIG 5 ;
                     DUP ;
                     DUG 2 ;
                     GET ;
                     IF_NONE { PUSH int 546 ; FAILWITH } {} ;
                     PUSH bool False ;
                     SENDER ;
                     UPDATE ;
                     SOME ;
                     SWAP ;
                     UPDATE ;
                     SWAP ;
                     PAIR ;
                     PAIR ;
                     PAIR ;
                     DUP ;
                     DUG 2 ;
                     CAR ;
                     CAR ;
                     CDR ;
                     SWAP ;
                     DUP ;
                     DUG 2 ;
                     MEM ;
                     IF {}
                        { SWAP ;
                          UNPAIR ;
                          UNPAIR ;
                          UNPAIR ;
                          SWAP ;
                          PUSH (option (set address)) (Some {}) ;
                          DUP 6 ;
                          UPDATE ;
                          SWAP ;
                          PAIR ;
                          PAIR ;
                          PAIR ;
                          SWAP } ;
                     SWAP ;
                     UNPAIR ;
                     UNPAIR ;
                     UNPAIR ;
                     SWAP ;
                     DUP ;
                     DUP 6 ;
                     DUP ;
                     DUG 2 ;
                     GET ;
                     IF_NONE { PUSH int 551 ; FAILWITH } {} ;
                     PUSH bool True ;
                     SENDER ;
                     UPDATE ;
                     SOME ;
                     SWAP ;
                     UPDATE ;
                     SWAP ;
                     DIG 4 ;
                     SOME ;
                     SENDER ;
                     UPDATE ;
                     PAIR ;
                     PAIR ;
                     PAIR ;
                     NIL operation }
                   { IF_LEFT
                       { SWAP ;
                         DUP ;
                         DUG 2 ;
                         CAR ;
                         CAR ;
                         CDR ;
                         SWAP ;
                         DUP ;
                         DUG 2 ;
                         GET 3 ;
                         GET ;
                         IF_NONE { PUSH int 431 ; FAILWITH } {} ;
                         SENDER ;
                         MEM ;
                         IF {} { PUSH string "Vault and Owner details do not match" ; FAILWITH } ;
                         DUP ;
                         CAR ;
                         SENDER ;
                         COMPARE ;
                         EQ ;
                         IF { SWAP ;
                              DUP ;
                              DUG 2 ;
                              UNPAIR ;
                              SWAP ;
                              UNPAIR ;
                              SWAP ;
                              UNPAIR ;
                              SWAP ;
                              CAR ;
                              DUP 5 ;
                              GET 4 ;
                              DIG 6 ;
                              GET 8 ;
                              SUB ;
                              ABS ;
                              SWAP ;
                              PAIR ;
                              SWAP ;
                              PAIR ;
                              SWAP ;
                              PAIR ;
                              SWAP ;
                              PAIR ;
                              SWAP ;
                              NIL operation ;
                              PUSH address "KT1Cxrhwn6TD2pxvZrn2HfHA1dhkWoQeKrRV" ;
                              CONTRACT %burn (pair (address %address) (nat %value)) ;
                              IF_NONE { PUSH string " call to DAL fa1.2 to burn failed" ; FAILWITH } {} ;
                              PUSH mutez 0 ;
                              DIG 3 ;
                              DUP ;
                              GET 4 ;
                              SWAP ;
                              CAR ;
                              PAIR %address %value ;
                              TRANSFER_TOKENS ;
                              CONS }
                            { DROP ; NIL operation } }
                       { PUSH address "KT1McGXves4Ba5n4T331r8xnnNAnQvSMQDCq" ;
                         SENDER ;
                         COMPARE ;
                         EQ ;
                         IF {}
                            { PUSH string "Sender isn't authorized to mint stable coins" ; FAILWITH } ;
                         SWAP ;
                         DUP ;
                         DUG 2 ;
                         CAR ;
                         GET 3 ;
                         SWAP ;
                         DUP ;
                         DUG 2 ;
                         CAR ;
                         DUP 4 ;
                         GET 8 ;
                         ADD ;
                         COMPARE ;
                         LE ;
                         IF {}
                            { PUSH string
                                   "WrongCondition: (self.data.totalSupply + params.amount) <= self.data.SupplyCeiling" ;
                              FAILWITH } ;
                         SWAP ;
                         UNPAIR ;
                         SWAP ;
                         UNPAIR ;
                         SWAP ;
                         UNPAIR ;
                         SWAP ;
                         UNPAIR ;
                         SWAP ;
                         DUP 6 ;
                         CAR ;
                         ADD ;
                         SWAP ;
                         PAIR ;
                         SWAP ;
                         PAIR ;
                         SWAP ;
                         PAIR ;
                         SWAP ;
                         PAIR ;
                         SWAP ;
                         NIL operation ;
                         PUSH address "KT1Cxrhwn6TD2pxvZrn2HfHA1dhkWoQeKrRV" ;
                         CONTRACT %mint (pair (address %address) (nat %value)) ;
                         IF_NONE { PUSH string " call to DAL fa1.2 to mint failed" ; FAILWITH } {} ;
                         PUSH mutez 0 ;
                         DIG 3 ;
                         DUP ;
                         CAR ;
                         SWAP ;
                         GET 3 ;
                         PAIR %address %value ;
                         TRANSFER_TOKENS ;
                         CONS } } } } ;
         PAIR } }
