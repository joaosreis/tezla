{ storage
    (pair (pair (list %_allEscrowAddresses (option address))
                (pair (address %_commissionBeneficiary) (address %_commissionToken)))
          (pair (pair (int %_creationCost)
                      (big_map %_escrowAddressByParty address (list (option address))))
                (pair (address %eventSinkContractAddress) (address %owner)))) ;
  parameter
    (or (or (pair %createDVP
               (pair (pair (address %admin) (int %amount_A))
                     (pair (int %amount_B)
                           (pair (address %creatorAddress) (address %eventSinkContractAddress))))
               (pair (pair (timestamp %expiryTime) (address %publicAddress_A))
                     (pair (address %publicAddress_B)
                           (pair (address %tokenAddress_A) (address %tokenAddress_B)))))
            (address %setCommissionBeneficiary))
        (or (address %setCommissionToken) (int %setCreationCost))) ;
  code { DUP ;
         CDR ;
         SWAP ;
         CAR ;
         IF_LEFT
           { IF_LEFT
               { { NIL operation ;
                   DIG 2 ;
                   DUP ;
                   DUG 3 ;
                   CAR ;
                   CDR ;
                   CDR ;
                   CONTRACT %approve (pair (int %amount) (pair (address %f) (address %t))) ;
                   IF_NONE { { PUSH unit Unit ; FAILWITH } } { {} } ;
                   PUSH mutez 0 ;
                   SELF ;
                   ADDRESS ;
                   DIG 4 ;
                   DUP ;
                   DUG 5 ;
                   CAR ;
                   CDR ;
                   CDR ;
                   CAR ;
                   PAIR %f %t ;
                   DIG 5 ;
                   DUP ;
                   DUG 6 ;
                   CDR ;
                   CAR ;
                   CAR ;
                   PAIR %amount ;
                   TRANSFER_TOKENS ;
                   CONS ;
                   DIG 2 ;
                   DUP ;
                   DUG 3 ;
                   CAR ;
                   CDR ;
                   CDR ;
                   CONTRACT %transfer (pair (int %amount) (pair (address %f) (address %t))) ;
                   IF_NONE { { PUSH unit Unit ; FAILWITH } } { {} } ;
                   PUSH mutez 0 ;
                   DIG 4 ;
                   DUP ;
                   DUG 5 ;
                   CAR ;
                   CDR ;
                   CAR ;
                   DIG 4 ;
                   DUP ;
                   DUG 5 ;
                   CAR ;
                   CDR ;
                   CDR ;
                   CAR ;
                   PAIR %f %t ;
                   DIG 5 ;
                   DUP ;
                   DUG 6 ;
                   CDR ;
                   CAR ;
                   CAR ;
                   PAIR %amount ;
                   TRANSFER_TOKENS ;
                   CONS ;
                   SWAP ;
                   DUP ;
                   DUG 2 ;
                   CDR ;
                   CDR ;
                   CDR ;
                   CDR ;
                   DIG 2 ;
                   DUP ;
                   DUG 3 ;
                   CDR ;
                   CDR ;
                   CDR ;
                   CAR ;
                   PAIR %tokenAddress_A %tokenAddress_B ;
                   DIG 2 ;
                   DUP ;
                   DUG 3 ;
                   CDR ;
                   CDR ;
                   CAR ;
                   PAIR %publicAddress_B ;
                   DIG 2 ;
                   DUP ;
                   DUG 3 ;
                   CDR ;
                   CAR ;
                   CDR ;
                   DIG 3 ;
                   DUP ;
                   DUG 4 ;
                   CDR ;
                   CAR ;
                   CAR ;
                   PAIR %expiryTime %publicAddress_A ;
                   PUSH bool False ;
                   PAIR %exchanged ;
                   PAIR ;
                   DIG 2 ;
                   DUP ;
                   DUG 3 ;
                   CAR ;
                   CDR ;
                   CDR ;
                   CDR ;
                   NOW ;
                   PAIR %creationTime %eventSinkContractAddress ;
                   DIG 3 ;
                   DUP ;
                   DUG 4 ;
                   CAR ;
                   CDR ;
                   CAR ;
                   PAIR %amount_B ;
                   DIG 3 ;
                   DUP ;
                   DUG 4 ;
                   CAR ;
                   CAR ;
                   CDR ;
                   DIG 4 ;
                   DUP ;
                   DUG 5 ;
                   CAR ;
                   CAR ;
                   CAR ;
                   PAIR %admin %amount_A ;
                   PAIR ;
                   PAIR ;
                   PUSH mutez 0 ;
                   NONE key_hash ;
                   CREATE_CONTRACT
                     { parameter unit ;
                       storage
                         (pair (pair (pair (address %admin) (int %amount_A))
                                     (pair (int %amount_B)
                                           (pair (timestamp %creationTime) (address %eventSinkContractAddress))))
                               (pair (pair (bool %exchanged) (pair (timestamp %expiryTime) (address %publicAddress_A)))
                                     (pair (address %publicAddress_B)
                                           (pair (address %tokenAddress_A) (address %tokenAddress_B))))) ;
                       code { { DUP ;
                                CDR ;
                                SWAP ;
                                CAR ;
                                SWAP ;
                                DUP ;
                                DUG 2 ;
                                CAR ;
                                CAR ;
                                CAR ;
                                SENDER ;
                                COMPARE ;
                                EQ ;
                                IF { {} } { { PUSH string "01" ; FAILWITH } } ;
                                SWAP ;
                                DUP ;
                                DUG 2 ;
                                CDR ;
                                CAR ;
                                CAR ;
                                IF { { PUSH string "Escrow already exchanged" ; FAILWITH } } { {} } ;
                                SWAP ;
                                DUP ;
                                DUG 2 ;
                                CDR ;
                                CAR ;
                                CDR ;
                                CAR ;
                                NOW ;
                                COMPARE ;
                                LE ;
                                IF { {} } { { PUSH string "Escrow already expired" ; FAILWITH } } ;
                                NIL operation ;
                                DIG 2 ;
                                DUP ;
                                DUG 3 ;
                                CDR ;
                                CDR ;
                                CDR ;
                                CAR ;
                                CONTRACT %transfer (pair (int %amount) (pair (address %f) (address %t))) ;
                                IF_NONE { { PUSH unit Unit ; FAILWITH } } { {} } ;
                                PUSH mutez 0 ;
                                DIG 4 ;
                                DUP ;
                                DUG 5 ;
                                CDR ;
                                CDR ;
                                CAR ;
                                DIG 5 ;
                                DUP ;
                                DUG 6 ;
                                CDR ;
                                CAR ;
                                CDR ;
                                CDR ;
                                PAIR %f %t ;
                                DIG 5 ;
                                DUP ;
                                DUG 6 ;
                                CAR ;
                                CAR ;
                                CDR ;
                                PAIR %amount ;
                                TRANSFER_TOKENS ;
                                CONS ;
                                DIG 2 ;
                                DUP ;
                                DUG 3 ;
                                CDR ;
                                CDR ;
                                CDR ;
                                CDR ;
                                CONTRACT %transfer (pair (int %amount) (pair (address %f) (address %t))) ;
                                IF_NONE { { PUSH unit Unit ; FAILWITH } } { {} } ;
                                PUSH mutez 0 ;
                                DIG 4 ;
                                DUP ;
                                DUG 5 ;
                                CDR ;
                                CDR ;
                                CAR ;
                                DIG 5 ;
                                DUP ;
                                DUG 6 ;
                                CDR ;
                                CDR ;
                                CAR ;
                                PAIR %f %t ;
                                DIG 5 ;
                                DUP ;
                                DUG 6 ;
                                CAR ;
                                CDR ;
                                CAR ;
                                PAIR %amount ;
                                TRANSFER_TOKENS ;
                                CONS ;
                                DIG 2 ;
                                DUP ;
                                CAR ;
                                SWAP ;
                                CDR ;
                                DUP ;
                                CDR ;
                                SWAP ;
                                CAR ;
                                CDR ;
                                PUSH bool True ;
                                PAIR ;
                                PAIR ;
                                SWAP ;
                                PAIR ;
                                DUG 2 ;
                                DUP ;
                                DIG 3 ;
                                DUP ;
                                DUG 4 ;
                                CAR ;
                                CDR ;
                                CDR ;
                                CDR ;
                                CONTRACT %exchangeEvent
                                  (pair (pair (address %DVPaddress) (int %amount_A))
                                        (pair (int %amount_B) (pair (address %party_A) (address %party_B)))) ;
                                IF_NONE { { PUSH unit Unit ; FAILWITH } } { {} } ;
                                PUSH mutez 0 ;
                                DIG 5 ;
                                DUP ;
                                DUG 6 ;
                                CDR ;
                                CDR ;
                                CAR ;
                                DIG 6 ;
                                DUP ;
                                DUG 7 ;
                                CDR ;
                                CAR ;
                                CDR ;
                                CDR ;
                                PAIR %party_A %party_B ;
                                DIG 6 ;
                                DUP ;
                                DUG 7 ;
                                CAR ;
                                CDR ;
                                CAR ;
                                PAIR %amount_B ;
                                DIG 6 ;
                                DUP ;
                                DUG 7 ;
                                CAR ;
                                CAR ;
                                CDR ;
                                SELF ;
                                DIG 6 ;
                                DROP ;
                                DIG 6 ;
                                DROP ;
                                ADDRESS ;
                                PAIR %DVPaddress %amount_A ;
                                PAIR ;
                                TRANSFER_TOKENS ;
                                CONS ;
                                PAIR } } } ;
                   PAIR ;
                   DUP ;
                   DUG 2 ;
                   CAR ;
                   CONS ;
                   SWAP ;
                   DIG 3 ;
                   DUP ;
                   DUG 4 ;
                   CDR ;
                   CAR ;
                   CDR ;
                   DIG 3 ;
                   DUP ;
                   DUG 4 ;
                   CDR ;
                   CAR ;
                   CDR ;
                   MEM ;
                   IF { {} }
                      { { DIG 3 ;
                          DUP ;
                          CAR ;
                          SWAP ;
                          CDR ;
                          DUP ;
                          CDR ;
                          SWAP ;
                          CAR ;
                          DUP ;
                          CAR ;
                          SWAP ;
                          CDR ;
                          PUSH (option (list (option address))) (Some {}) ;
                          DIG 7 ;
                          DUP ;
                          DUG 8 ;
                          CDR ;
                          CAR ;
                          CDR ;
                          UPDATE ;
                          SWAP ;
                          PAIR ;
                          PAIR ;
                          SWAP ;
                          PAIR ;
                          DUG 3 } } ;
                   DIG 3 ;
                   DUP ;
                   DUG 4 ;
                   DUP ;
                   CAR ;
                   SWAP ;
                   CDR ;
                   DUP ;
                   CDR ;
                   SWAP ;
                   CAR ;
                   DUP ;
                   CAR ;
                   SWAP ;
                   CDR ;
                   DIG 7 ;
                   CDR ;
                   CAR ;
                   CDR ;
                   DIG 7 ;
                   DUP ;
                   DUG 8 ;
                   CDR ;
                   CAR ;
                   CDR ;
                   GET ;
                   IF_NONE { { PUSH string "Get-item:220" ; FAILWITH } } {} ;
                   DIG 5 ;
                   DUP ;
                   DUG 6 ;
                   CDR ;
                   SOME ;
                   CONS ;
                   SOME ;
                   DIG 7 ;
                   DUP ;
                   DUG 8 ;
                   CDR ;
                   CAR ;
                   CDR ;
                   UPDATE ;
                   SWAP ;
                   PAIR ;
                   PAIR ;
                   SWAP ;
                   PAIR ;
                   DUG 3 ;
                   DIG 3 ;
                   DUP ;
                   DUG 4 ;
                   CDR ;
                   CAR ;
                   CDR ;
                   DIG 3 ;
                   DUP ;
                   DUG 4 ;
                   CDR ;
                   CDR ;
                   CAR ;
                   MEM ;
                   IF { {} }
                      { { DIG 3 ;
                          DUP ;
                          CAR ;
                          SWAP ;
                          CDR ;
                          DUP ;
                          CDR ;
                          SWAP ;
                          CAR ;
                          DUP ;
                          CAR ;
                          SWAP ;
                          CDR ;
                          PUSH (option (list (option address))) (Some {}) ;
                          DIG 7 ;
                          DUP ;
                          DUG 8 ;
                          CDR ;
                          CDR ;
                          CAR ;
                          UPDATE ;
                          SWAP ;
                          PAIR ;
                          PAIR ;
                          SWAP ;
                          PAIR ;
                          DUG 3 } } ;
                   DIG 3 ;
                   DUP ;
                   DUG 4 ;
                   DUP ;
                   CAR ;
                   SWAP ;
                   CDR ;
                   DUP ;
                   CDR ;
                   SWAP ;
                   CAR ;
                   DUP ;
                   CAR ;
                   SWAP ;
                   CDR ;
                   DIG 7 ;
                   CDR ;
                   CAR ;
                   CDR ;
                   DIG 7 ;
                   DUP ;
                   DUG 8 ;
                   CDR ;
                   CDR ;
                   CAR ;
                   GET ;
                   IF_NONE { { PUSH string "Get-item:220" ; FAILWITH } } {} ;
                   DIG 5 ;
                   DUP ;
                   DUG 6 ;
                   CDR ;
                   SOME ;
                   CONS ;
                   SOME ;
                   DIG 7 ;
                   CDR ;
                   CDR ;
                   CAR ;
                   UPDATE ;
                   SWAP ;
                   PAIR ;
                   PAIR ;
                   SWAP ;
                   PAIR ;
                   DUG 2 ;
                   DIG 2 ;
                   DUP ;
                   DUG 3 ;
                   DUP ;
                   CDR ;
                   SWAP ;
                   CAR ;
                   CDR ;
                   DIG 4 ;
                   CAR ;
                   CAR ;
                   DIG 3 ;
                   CDR ;
                   SOME ;
                   CONS ;
                   PAIR ;
                   PAIR ;
                   SWAP } }
               { { SWAP ;
                   DUP ;
                   DUG 2 ;
                   CDR ;
                   CDR ;
                   CDR ;
                   SENDER ;
                   COMPARE ;
                   EQ ;
                   IF { {} }
                      { { PUSH string "Only owner can change the commissionBeneficiary." ; FAILWITH } } ;
                   SWAP ;
                   DUP ;
                   CDR ;
                   SWAP ;
                   CAR ;
                   DUP ;
                   CAR ;
                   SWAP ;
                   CDR ;
                   CDR ;
                   DIG 3 ;
                   PAIR ;
                   SWAP ;
                   PAIR ;
                   PAIR ;
                   NIL operation } } }
           { { IF_LEFT
                 { { SWAP ;
                     DUP ;
                     DUG 2 ;
                     CDR ;
                     CDR ;
                     CDR ;
                     SENDER ;
                     COMPARE ;
                     EQ ;
                     IF { {} }
                        { { PUSH string "Only owner can change the commissionToken." ; FAILWITH } } ;
                     SWAP ;
                     DUP ;
                     CDR ;
                     SWAP ;
                     CAR ;
                     DUP ;
                     CAR ;
                     SWAP ;
                     CDR ;
                     CAR ;
                     DIG 3 ;
                     SWAP ;
                     PAIR ;
                     SWAP ;
                     PAIR ;
                     PAIR } }
                 { { SWAP ;
                     DUP ;
                     DUG 2 ;
                     CDR ;
                     CDR ;
                     CDR ;
                     SENDER ;
                     COMPARE ;
                     EQ ;
                     IF { {} }
                        { { PUSH string "Only owner can change the creation cost." ; FAILWITH } } ;
                     SWAP ;
                     DUP ;
                     CAR ;
                     SWAP ;
                     CDR ;
                     DUP ;
                     CDR ;
                     SWAP ;
                     CAR ;
                     CDR ;
                     DIG 3 ;
                     PAIR ;
                     PAIR ;
                     SWAP ;
                     PAIR } } ;
               NIL operation } } ;
         PAIR } }
